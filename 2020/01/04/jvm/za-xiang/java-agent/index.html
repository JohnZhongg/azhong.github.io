<!DOCTYPE HTML>
<html lang="zh-CN">


<head><meta name="generator" content="Hexo 3.9.0">
    <meta charset="utf-8">
    <meta name="keywords" content="Java agent, 技术博客 钟鸿鹏 honphan 阿钟">
    <meta name="baidu-site-verification" content="fmlEuI34ir">
    <meta name="google-site-verification" content="yCy2azpds5XSuGZvis6OuA-XIGF5GuGpYRAaGfD6o48">
    <meta name="360-site-verification" content="b7c11a830ef90fd1464ad6206bb7b6e7">
    <meta name="description" content="JVMTI 及 Instrument
JVM Tool Interface（JVM TI）是一个作为工具作用的原生(native)接口。它提供了一种方式去检查 JVM 程序的状态或者控制它们的运行。用途包括但不限于：指标分析、调试、监控、线">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Java agent | 阿钟的博客</title>
    <link rel="icon" type="image/png" href="/favicon.png">

    <link rel="stylesheet" type="text/css" href="/libs/awesome/css/font-awesome.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
    <link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css" href="/css/matery.css">
    <link rel="stylesheet" type="text/css" href="/css/my.css">
    <style type="text/css">
        
    </style>

    <script src="/libs/jquery/jquery-2.2.0.min.js"></script>
    <script src="https://sdk.jinrishici.com/v2/browser/jinrishici.js" charset="utf-8"></script>
    <script>
        var _hmt = _hmt || [];
        (function () {
            var hm = document.createElement("script");
            hm.src = "https://hm.baidu.com/hm.js?46e79e71af0709a5b9106bf20cecc493";
            var s = document.getElementsByTagName("script")[0];
            s.parentNode.insertBefore(hm, s);
        })();
    </script>

    
        <script>
            (function(){
                var bp = document.createElement('script');
                var curProtocol = window.location.protocol.split(':')[0];
                if (curProtocol === 'https') {
                    bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
                }
                else {
                    bp.src = 'http://push.zhanzhang.baidu.com/push.js';
                }
                var s = document.getElementsByTagName("script")[0];
                s.parentNode.insertBefore(bp, s);
            })();
        </script>
    

    <script>
        (function(){
        var src = "https://jspassport.ssl.qhimg.com/11.0.1.js?d182b3f28525f2db83acfaaf6e696dba";
        document.write('<script src="' + src + '" id="sozz"><\/script>');
        })();
    </script>

<link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css">
<link rel="stylesheet" href="/css/prism-line-numbers.css" type="text/css"></head>

<body>

    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="/medias/logo.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">阿钟的博客</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fa fa-navicon"></i></a>
<ul class="right">
    
    <li class="hide-on-med-and-down">
        <a href="/" class="waves-effect waves-light">
            
            <i class="fa fa-home"></i>
            
            <span>首页</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/tags" class="waves-effect waves-light">
            
            <i class="fa fa-tags"></i>
            
            <span>标签</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/categories" class="waves-effect waves-light">
            
            <i class="fa fa-bookmark"></i>
            
            <span>分类</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/archives" class="waves-effect waves-light">
            
            <i class="fa fa-archive"></i>
            
            <span>归档</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/about" class="waves-effect waves-light">
            
            <i class="fa fa-user-circle-o"></i>
            
            <span>关于</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/friends" class="waves-effect waves-light">
            
            <i class="fa fa-address-book"></i>
            
            <span>友情链接</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/contact" class="waves-effect waves-light">
            
            <i class="fa fa-comments"></i>
            
            <span>留言板</span>
        </a>
    </li>
    
    <li>
        <a href="#searchModal" class="modal-trigger waves-effect waves-light">
            <i id="searchIcon" class="fa fa-search" title="搜索"></i>
        </a>
    </li>
</ul>

<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="/medias/logo.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">阿钟的博客</div>
        <div class="logo-desc">
            
            keep going...
            
        </div>
    </div>

    

    <ul class="menu-list mobile-menu-list">
        
        <li>
            <a href="/" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-home"></i>
                
                首页
            </a>
        </li>
        
        <li>
            <a href="/tags" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-tags"></i>
                
                标签
            </a>
        </li>
        
        <li>
            <a href="/categories" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-bookmark"></i>
                
                分类
            </a>
        </li>
        
        <li>
            <a href="/archives" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-archive"></i>
                
                归档
            </a>
        </li>
        
        <li>
            <a href="/about" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-user-circle-o"></i>
                
                关于
            </a>
        </li>
        
        <li>
            <a href="/friends" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-address-book"></i>
                
                友情链接
            </a>
        </li>
        
        <li>
            <a href="/contact" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-comments"></i>
                
                留言板
            </a>
        </li>
        
        
        <li><div class="divider"></div></li>
        <li>
            <a href="https://github.com/JohnZhongg" class="waves-effect waves-light" target="_blank">
                <i class="fa fa-github-square fa-fw"></i>Fork Me
            </a>
        </li>
        
    </ul>
</div>

        </div>

        
            <style>
    .nav-transparent .github-corner {
        display: none !important;
    }

    .github-corner {
        position: absolute;
        z-index: 10;
        top: 0;
        right: 0;
        border: 0;
        transform: scale(1.1);
    }

    .github-corner svg {
        color: #0f9d58;
        fill: #fff;
        height: 64px;
        width: 64px;
    }

    .github-corner:hover .octo-arm {
        animation: a 0.56s ease-in-out;
    }

    .github-corner .octo-arm {
        animation: none;
    }

    @keyframes a {
        0%,
        to {
            transform: rotate(0);
        }
        20%,
        60% {
            transform: rotate(-25deg);
        }
        40%,
        80% {
            transform: rotate(10deg);
        }
    }
</style>

<a href="https://github.com/JohnZhongg" class="github-corner tooltipped hide-on-med-and-down" target="_blank"
   data-tooltip="Fork Me" data-position="left" data-delay="50">
    <svg viewBox="0 0 250 250" aria-hidden="true">
        <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path>
        <path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2"
              fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path>
        <path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z"
              fill="currentColor" class="octo-body"></path>
    </svg>
</a>
        
    </nav>

</header>

    
<script src="/libs/cryptojs/crypto-js.min.js"></script>
<script>
    (function() {
        let pwd = '';
        if (pwd && pwd.length > 0) {
            if (pwd !== CryptoJS.SHA256(prompt('请输入访问本文章的密码')).toString(CryptoJS.enc.Hex)) {
                alert('密码错误，将返回主页！');
                location.href = '/';
            }
        }
    })();
</script>




<div class="bg-cover pd-header post-cover" style="background-image: url('/medias/featureimages/0.jpg')">
    <div class="container">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <div class="description center-align post-title">
                        Java agent
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>



<main class="post-container content">

    
    <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
<style>
    #articleContent h1::before,
    #articleContent h2::before,
    #articleContent h3::before,
    #articleContent h4::before,
    #articleContent h5::before,
    #articleContent h6::before {
        display: block;
        content: " ";
        height: 100px;
        margin-top: -100px;
        visibility: hidden;
    }

    #articleContent :focus {
        outline: none;
    }

    .toc-fixed {
        position: fixed;
        top: 64px;
    }

    .toc-widget {
        padding-left: 20px;
    }

    .toc-widget .toc-title {
        margin: 35px 0 15px 0;
        padding-left: 17px;
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    .toc-widget ol {
        padding: 0;
        list-style: none;
    }

    #toc-content ol {
        padding-left: 10px;
    }

    #toc-content ol li {
        padding-left: 10px;
    }

    #toc-content .toc-link:hover {
        color: #42b983;
        font-weight: 700;
        text-decoration: underline;
    }

    #toc-content .toc-link::before {
        background-color: transparent;
        max-height: 25px;
    }

    #toc-content .is-active-link {
        color: #42b983;
    }

    #toc-content .is-active-link::before {
        background-color: #42b983;
    }

    #floating-toc-btn {
        position: fixed;
        right: 20px;
        bottom: 76px;
        padding-top: 15px;
        margin-bottom: 0;
        z-index: 998;
    }

    #floating-toc-btn .btn-floating {
        width: 48px;
        height: 48px;
    }

    #floating-toc-btn .btn-floating i {
        line-height: 48px;
        font-size: 1.4rem;
    }
</style>
<div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                        <a href="/tags/JVM学习/" target="_blank">
                            <span class="chip bg-color">JVM学习</span>
                        </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fa fa-bookmark fa-fw icon-category"></i>
                        
                        <a href="/categories/JVM学习/" class="post-category" target="_blank">
                            JVM学习
                        </a>
                        
                    </div>
                    
                </div>
            </div>

            <div class="post-info">
                <div class="post-date info-break-policy">
                    <i class="fa fa-calendar-minus-o fa-fw"></i>发布日期:&nbsp;&nbsp;
                    2020-01-04
                </div>

                <div class="post-author info-break-policy">
                    <i class="fa fa-user-o fa-fw"></i>作者:&nbsp;&nbsp;
                    
                    阿钟
                    
                </div>

                
                
                <div class="info-break-policy">
                    <i class="fa fa-file-word-o fa-fw"></i>文章字数:&nbsp;&nbsp;
                    6.4k
                </div>
                

                
                <div class="info-break-policy">
                    <i class="fa fa-clock-o fa-fw"></i>阅读时长:&nbsp;&nbsp;
                    25 分
                </div>
                
                

                
                <div id="busuanzi_container_page_pv" class="info-break-policy">
                    <i class="fa fa-eye fa-fw"></i>阅读次数:&nbsp;&nbsp;
                    <span id="busuanzi_value_page_pv"></span>
                </div>
                
            </div>
        </div>
        <hr class="clearfix">
        <div class="card-content article-card-content">
            <div id="articleContent">
                <h1>JVMTI 及 Instrument</h1>
<p>JVM Tool Interface（JVM TI）是一个作为工具作用的原生(native)接口。它提供了一种方式去检查 JVM 程序的状态或者控制它们的运行。用途包括但不限于：指标分析、调试、监控、线程分析、覆盖率分析工具。</p>
<p>JVM TI 在 JDK 5.0 引用。它替换了 JVMPI（JVM Profiler Interface） 和 JVMDI（JVM Debug Interface），这两者在 JDK6 不再提供。</p>
<blockquote>
<p>在《深入理解Java虚拟机》第三版的 4.3.3 节对于 VisualVM 的介绍中，介绍了它的一个插件 BTrace。</p>
<p>Instrument是JVMTI（Java Virtual Machine Tool Interface,JVMTI）中的主要组成部分, 它提供了一套 agent（代理）机制。HotSpot虚拟机允许在不停止运行的情况下,更新已经加载的类的代码。</p>
<p>BTrace的作用是在不中断目标程序运行的前提下,通过HotSpot虚拟机的 Instrument 功能动态加入原本并不存在的调试代码。另外，阿里的 Arthas 也是基于此实现的</p>
</blockquote>
<h1>Java Agent</h1>
<p><code>java.lang.instrument</code> 包提供了可以通过 Java 语言编写 JVM 的 agent（Provides services that allow Java programming language agents to instrument programs running on the JVM.）。</p>
<p>以下是一个 agent 机制的示意图：</p>
<p><img src="https://cdn.jsdelivr.net/gh/JohnZhongg/blog_images/image/20201229111156.jpeg" alt="JVM architecture"></p>
<p>通过 java agent，我们可以使用 Java 语言编写监测 JVM 程序的逻辑，以此可以实现监控、覆盖率分析、事件日志记录等需求，其原理就是对方法的字节码进行修改，这种方式对于原应用程序来说侵入性较低。</p>
<p>要通过 Java Agent 实现前面提到的功能需要两个步骤：</p>
<ol>
<li>编写 Agent 逻辑</li>
<li>加载 Agent 到应用程序 JVM 中</li>
</ol>
<h2 id="编写-Agent"><a class="header-anchor" href="#编写-Agent">¶</a>编写 Agent</h2>
<p>Java gents 机制的实现基础由 <code>java.lang.instrument</code> 包提供。这个包的结构较为简单且是自包含（不依赖其它）的，里面包含了两个异常类、一个 data 类、一个 class definition以及两个接口。当我们需要实现一个 Java agent 的时候需要用到两个类：<code>ClassFileTransformer</code> 和 <code>Instrumentation</code>。</p>
<p><img src="https://cdn.jsdelivr.net/gh/JohnZhongg/blog_images/image/20201224110021.png" alt="image-20201224110021760"></p>
<h3 id="ClassFileTransformer"><a class="header-anchor" href="#ClassFileTransformer">¶</a>ClassFileTransformer</h3>
<h4 id="transform-方法"><a class="header-anchor" href="#transform-方法">¶</a>transform 方法</h4>
<p>这一个接口提供了转换 class 文件的功能，这个转换动作会在 class 被 JVM <code>define</code> 之前进行。来看一下它唯一的一个方法：</p>
<pre class="line-numbers language-language-java"><code class="language-language-java">byte[]	transform(ClassLoader loader, 
                  String className, 
                  Class<?> classBeingRedefined, 
                  ProtectionDomain protectionDomain, 
                  byte[] classfileBuffer)
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这个方法就是被用来对字节码做转换，也就是我们要对 class 字节码做增强的地方。</p>
<h5 id="参数"><a class="header-anchor" href="#参数">¶</a>参数</h5>
<ol>
<li>第一个参数：当前要 define class 的类加载器，如果是 null 则表示该类由 bootstrap 加载器加载的</li>
<li>第二个参数：当前要 define class 的类名，格式为 JVM 规范的内部格式，例如：“java/util/List”</li>
<li>第三个参数：如果当前调用是由类重定义（redefine）或者类重转换（retransform）触发的，传入的就是将要被重定义或者重转换的 Class 对象；如果当前调用仅仅是因为类加载而被触发，传入 null</li>
<li>第四个参数：the protection domain of the class being defined or redefined</li>
<li>第五个参数：该 class 文件的字节码格式的字节 buffer（不能修改这个数组）</li>
</ol>
<h5 id="返回值"><a class="header-anchor" href="#返回值">¶</a>返回值</h5>
<p>是修改之后要返回的字节码文件的字节 buffer。</p>
<h4 id="转换器类型"><a class="header-anchor" href="#转换器类型">¶</a>转换器类型</h4>
<p>这里将 ClassFileTransformer 接口称为一个 class 转换器，一共有两种转换器：</p>
<ol>
<li>可以重转换（retransformation capable）的转换器，在调用 <code>Instrumentation.addTransformer</code> 注册转换器的时候指定第二个参数 <code>canRetransform</code> 为 true。</li>
<li>不可重转换（retransformation incapable）的转换器，相反在注册转换器的时候 <code>canRetransform</code> 设置为 false。</li>
</ol>
<h4 id="转换器被触发的方式"><a class="header-anchor" href="#转换器被触发的方式">¶</a>转换器被触发的方式</h4>
<p>当一个转换器通过 <code>addTransformer</code> 注册之后，其 <code>transform</code> 方法被调用的时机如下：</p>
<ol>
<li>每一个新的 class 被定义（new class definition）：由<code>ClassLoader.defineClass</code> 或者它对应的 native 方法触发。</li>
<li>每一个 class 被重定义（class redefinition）：由 <code>Instrumentation.redefineClasses</code> 或者它对应的 native 方法触发。</li>
<li>每一个 class 被重转换（class retransformation）<strong>并且当前转换器是可重转换的</strong>：由 <code>Instrumentation.retransformClasses</code> 或者它对应的 native 方法触发。</li>
</ol>
<p><code>transform</code> 方法会在 class 字节码被 <strong>校验</strong> 或者 <strong>应用</strong> 之前被调用。</p>
<h4 id="多转换器"><a class="header-anchor" href="#多转换器">¶</a>多转换器</h4>
<p>如果存在多个转换器，这些转换器将会被组合成一条链条进行按序调用（前一个转换器输出的字节码数组作为下一个转换器的字节码输入）。下面是多转换器的执行顺序：</p>
<ul>
<li>不可重转换的转换器</li>
<li>不可重转换的 native 转换器</li>
<li>可以重转换的转换器</li>
<li>可以重转换的 native 转换器</li>
</ul>
<p>对于重转换（class retransformations）来说，不可重转换的转换器不会被调用，而是继续使用前一个转换器的输出作为下一个转换器的输入。</p>
<p>以上四组转换器，同组内的执行顺序和注册顺序一致。native 转换器可以通过 JVM TI 中的 <code>ClassFileLoadHook</code> 事件进行注册（Java Agent 是JVM TI Instrumentation 提供的其中一个 Java 钩子，通过 JNI 可以使用更多的钩子）。</p>
<h4 id="输入第一个转换器的字节码数组"><a class="header-anchor" href="#输入第一个转换器的字节码数组">¶</a>输入第一个转换器的字节码数组</h4>
<ul>
<li>对于新的 class 被定义：通过 <code>ClassLoader.defineClass</code> 传入的字节码</li>
<li>对于 class 重定义：通过 <code>Instrumentation.redefineClasses</code> 传入的可变参数中的每一个元素的 <code>ClassDefinition.getDefinitionClassFile()</code> 的返回值</li>
<li>对于 class 重转换：the bytes passed to the new class definition or, if redefined, the last redefinition, with all transformations made by retransformation incapable transformers reapplied automatically and unaltered（不是很理解，是指将不可重转换的转换器都执行了一遍，但是不会理会它的返回值？）</li>
</ul>
<h4 id="其它注意"><a class="header-anchor" href="#其它注意">¶</a>其它注意</h4>
<ol>
<li>如果转换器认为对于当前类无需做转换工作，应该返回 null；否则，应该创建一个新的字节数组，将 <code>classfileBuffer</code> 形参的内容拷贝到新数组中进行修改，然后返回该数组。<code>classfileBuffer</code> 本身不允许修改。也就是说 JVM 会根据转换器的返回结果是否为 null 而选择是使用其返回值还是传递给它的形参字节数组作为该 class 的新的字节码流。</li>
<li>在发生类的重转换或者重定义的场景中，转换器必须支持这样的一个语义：如果一个已经在进行类初始定义阶段被该转换器修改的类在后续再进行一个重转换或者重定义的时候，该转换器必须要确保第二次转换的 class 字节码相对于第一次转换的输出是有效、合理的。</li>
<li>如果当前转换器抛出了一个未捕获的异常，后续的转换器将会被继续调用，一切照常，类似于该转换器返回了 null。为了防止转换器中的一些未知行为抛出一些未检查异常，可以在转换器中捕获 <code>Throwable</code> 。如果转换器认为 <code>classFileBuffer</code> 不是一个有效格式的 class 字节码，它应该抛出 <code>IllegalClassFormatException</code> ，这会得到和返回 null 一样的效果，同时还起到一个对于非法格式字节码的记录（logging）和调试（debugging）的效果。</li>
</ol>
<h3 id="Instrumentation"><a class="header-anchor" href="#Instrumentation">¶</a>Instrumentation</h3>
<p>这个 class 提供了修改 Java 程序代码（instrument Java programming language code）的服务，其中的注册服务允许我们注册自定义的 class 转换器 <code>ClassFileTransformer</code> 。</p>
<p>Instrumentation 指的是在方法中添加收集供工具使用的一些数据的额外的字节码。因为这些修改的侵入性很低，这些工具不会修改应用的状态或者行为。这些友好的工具包含：monitoring agents、profilers、覆盖率分析器（coverage analyzers）、事件记录器（event loggers）</p>
<blockquote>
<p>monitoring 和 profiling 的概念，总的来说，前者应该是要包含后者的，即包含指标收集、分析、告警；后者则对于分析方面更专业</p>
<ul>
<li>
<p>program profiling</p>
<p>In software engineering, <strong>profiling</strong> (“program <strong>profiling</strong>”, “software <strong>profiling</strong>”) <strong>is</strong> a form of dynamic program analysis that measures, for example, the space (memory) or time complexity of a program, the usage of particular instructions, or the frequency and duration of function calls.</p>
</li>
<li>
<p>monitoring</p>
<p>In <strong>computer science</strong>, event <strong>monitoring is</strong> the process of collecting, analyzing, and signaling event occurrences to subscribers such as operating system processes, active database rules as well as human operators.</p>
</li>
</ul>
</blockquote>
<p>这里有两种方式获取 Instrumentation 服务实例的方式：</p>
<ol>
<li>当 JVM 在启动的时候指定了一个 agent class，它将会将一个 Instrumentation 实例传到 agent class 的 <code>premain</code> 方法（通过在 manifest 中添加一项 <code>Premain-Class</code> 指定该 agent class）</li>
<li>当 JVM 是启动之后才加载 agents 的时候，Instrumentation 实例将会被传递到 agent class 的 <code>agentmain</code> 方法（通过在 manifest 中添加一项 <code>Agent-Class</code> 指定该 agent class）</li>
</ol>
<p>下面来看一下 Instrumentation 提供的服务（方法）。</p>
<h4 id="1-注册转换器"><a class="header-anchor" href="#1-注册转换器">¶</a>1&gt;注册转换器</h4>
<pre class="line-numbers language-language-java"><code class="language-language-java">void	addTransformer(ClassFileTransformer transformer, boolean canRetransform)  
void	addTransformer(ClassFileTransformer transformer) // same as addTransformer(transforrmer, false)
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<h5 id="参数-v2"><a class="header-anchor" href="#参数-v2">¶</a>参数</h5>
<ol>
<li>要注册的 class 转换器</li>
<li>该转换器是否可重转换</li>
</ol>
<h5 id="描述"><a class="header-anchor" href="#描述">¶</a>描述</h5>
<p>注册传入的 class 转换器，所有在后续发生的 class 定义对于当前注册的 class 转换器都是可见的，除了那些被任何已注册转换器依赖的 class 的定义。转换器被调用的时机和顺序参考上面的描述。同一个转换器可以被注册多次，但强烈建议不要这样做，而是创建一个新的转换器对象。</p>
<h4 id="2-注销转换器"><a class="header-anchor" href="#2-注销转换器">¶</a>2&gt;注销转换器</h4>
<pre class="line-numbers language-language-java"><code class="language-language-java">boolean removeTransformer(ClassFileTransformer transformer)
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h5 id="参数-v3"><a class="header-anchor" href="#参数-v3">¶</a>参数</h5>
<ol>
<li>要注销的转换器</li>
</ol>
<h5 id="返回值-v2"><a class="header-anchor" href="#返回值-v2">¶</a>返回值</h5>
<ul>
<li>如果转换器可以找到并且删除了，返回 true</li>
<li>如果无法找到该转换器，返回 false</li>
</ul>
<h5 id="描述-v2"><a class="header-anchor" href="#描述-v2">¶</a>描述</h5>
<p>注销指定的转换器，之后再进行的 class 定义将不会应用该转换器。Removes the most-recently-added matching instance of the transformer. Due to the multi-threaded nature of class loading, it is possible for a transformer to receive calls after it has been removed. Transformers should be written defensively to expect this situation.（移除匹配到的最晚添加的实例，因为类加载的多线程特性，可能会出现一个转换器在被注销之后还被调用的情况。在编写转换器的时候应该要考虑、预防这种情况）。</p>
<h4 id="3-查看当前-JVM-是否支持-class-重转换"><a class="header-anchor" href="#3-查看当前-JVM-是否支持-class-重转换">¶</a>3&gt;查看当前 JVM 是否支持 class 重转换</h4>
<pre class="line-numbers language-language-java"><code class="language-language-java">boolean isRetransformClassesSupported()
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h5 id="描述-v3"><a class="header-anchor" href="#描述-v3">¶</a>描述</h5>
<p>class 重转换是 JVM 的一个可选能力。当且仅当在 agent JAR 文件中的 manifest 中添加 <code>Can-Retransform-Classes</code> 属性为 true 的时候，JVM 才会支持重转换。在一个 JVM 实例中，对该方法的多次调用总是会返回相同的值。</p>
<h4 id="4-重转换-classes"><a class="header-anchor" href="#4-重转换-classes">¶</a>4&gt;重转换 classes</h4>
<pre class="line-numbers language-language-java"><code class="language-language-java">void retransformClasses(Class<?>... classes)
                 throws UnmodifiableClassException
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<h5 id="参数-v4"><a class="header-anchor" href="#参数-v4">¶</a>参数</h5>
<ol>
<li>需要被重转换的 classes 数组；设置一个长度为 0 的空数组，该方法则什么也不做</li>
</ol>
<h5 id="描述-v4"><a class="header-anchor" href="#描述-v4">¶</a>描述</h5>
<p>对于提供的 classes 集合进行重转换。该方法使得已经被加载的 classes 可以被 instrument，无论这些 classes 是否已经被转换器处理过，都会再被转换一次，以下是它的执行步骤：</p>
<ol>
<li>
<p>从 initial class file bytes 开始。</p>
<blockquote>
<p>initial class file bytes 指的是传递给 <code>ClassLoader.defineClass</code> 或者 <code>redefineClasses</code> 的字节数组（在任何转换器被调用之前）。不过它们（传递给方法之前和方法处理后）可能不是完全一模一样的。</p>
<ul>
<li>常量池的布局和内容可能不太一样</li>
<li>常量池的条目可能变多或者变少</li>
<li>常量池条目的顺序可能不太一样</li>
<li>一些属性可能不存在了</li>
<li>字节码内部元素的顺序没有被保证，例如方法之间的顺序，因为这些顺序是没有意义的</li>
</ul>
<p>但是在方法内的字节码中引用的常量池索引时候一致的。</p>
</blockquote>
</li>
<li>
<p>for each transformer that was added with <code>canRetransform</code> false, the bytes returned by <a href="https://docs.oracle.com/javase/8/docs/api/java/lang/instrument/ClassFileTransformer.html#transform-java.lang.ClassLoader-java.lang.String-java.lang.Class-java.security.ProtectionDomain-byte:A-" target="_blank" rel="noopener"><code>transform</code></a> during the last class load or redefine are reused as the output of the transformation; note that this is equivalent to reapplying the previous transformation, unaltered; except that <a href="https://docs.oracle.com/javase/8/docs/api/java/lang/instrument/ClassFileTransformer.html#transform-java.lang.ClassLoader-java.lang.String-java.lang.Class-java.security.ProtectionDomain-byte:A-" target="_blank" rel="noopener"><code>transform</code></a> is not called</p>
</li>
<li>
<p>对于可以重转换的转换器，它们的 <code>transform</code> 方法将会被调用。</p>
</li>
<li>
<p>转换后的 class 文件字节码将会被为该 class 的新的定义</p>
</li>
</ol>
<p>The order of transformation is described in the <a href="https://docs.oracle.com/javase/8/docs/api/java/lang/instrument/ClassFileTransformer.html#transform-java.lang.ClassLoader-java.lang.String-java.lang.Class-java.security.ProtectionDomain-byte:A-" target="_blank" rel="noopener"><code>transform</code></a> method. This same order is used in the automatic reapplication of retransformation incapable transforms.</p>
<p>这个方法操作的是一个集合，允许一次性操作多个互相影响的 classes。<strong>如果被重转换的方法已经存在一些栈帧，这些栈帧的字节码将会保持和原方法一致不变，而重转换后的方法将会在后续的新的调用中被使用。</strong></p>
<p>This method does not cause any initialization except that which would occur under the customary JVM semantics. In other words, redefining a class does not cause its initializers to be run. The values of static variables will remain as they were prior to the call.</p>
<p>Instances of the retransformed class are not affected.</p>
<p>重转换可能还会修改方法体、常量池和属性表，但是一定不能添加、移除、重命名字段或者方法、修改方法签名或者修改继承关系。这些限制可能会在未来的 Java 版本中被移除。class 字节码在重转换完成之后才会进行检查、校验、安装/应用，如果最终转换后得到的字节码是错误的，这个方法将会抛出一个异常。</p>
<p>如果这个方法抛出了异常，将不会有 classes 被重转换。</p>
<h4 id="5-是否支持重定义-classes"><a class="header-anchor" href="#5-是否支持重定义-classes">¶</a>5&gt;是否支持重定义 classes</h4>
<pre class="line-numbers language-language-java"><code class="language-language-java">boolean isRedefineClassesSupported()
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>返回当前 JVM 是否支持重定义 classes。当且仅当在 agent JAR 的 manifest 中存在 <code>Can-Redefine-Classes</code> 属性为 true 且 JVM 拥有重定义 classes 的能力的时候返回 true。</p>
<h4 id="6-重定义-classes"><a class="header-anchor" href="#6-重定义-classes">¶</a>6&gt;重定义 classes</h4>
<pre class="line-numbers language-language-java"><code class="language-language-java">redefineClasses
void redefineClasses(ClassDefinition... definitions)
              throws ClassNotFoundException,
                     UnmodifiableClassException
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>重定义给定的 class （定义）。</p>
<p>这个方法在无需使用现有 classes 的引用的情况下替换它们的定义，类似在调试代码的时候进行热重载那样重新编译某些类。当某些类需要被转换的时候，<code>retransformClasses</code> 就会被调用。</p>
<p>This method operates on a set in order to allow interdependent changes to more than one class at the same time (a redefinition of class A can require a redefinition of class B).</p>
<p><strong>如果被重定义的方法已经存在一些栈帧，这些栈帧的字节码将会保持和原方法一致不变，而重定义后的方法将会在后续的新的调用中被使用。</strong></p>
<p>This method does not cause any initialization except that which would occur under the customary JVM semantics. In other words, redefining a class does not cause its initializers to be run. The values of static variables will remain as they were prior to the call.</p>
<p>Instances of the redefined class are not affected.</p>
<p>重转换可能还会修改方法体、常量池和属性表，但是一定不能添加、移除、重命名字段或者方法、修改方法签名或者修改继承关系。这些限制可能会在未来的 Java 版本中被移除。class 字节码在重转换完成之后才会进行检查、校验、安装/应用，如果最终得到的字节码是错误的，这个方法将会抛出一个异常。</p>
<p>如果这个方法抛出了异常，将不会有 classes 被重定义。</p>
<h4 id="7-判断一个-class-是否可以被修改"><a class="header-anchor" href="#7-判断一个-class-是否可以被修改">¶</a>7&gt;判断一个 class 是否可以被修改</h4>
<pre class="line-numbers language-language-java"><code class="language-language-java">boolean isModifiableClass(Class<?> theClass)
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>判断一个 class 是否可以通过重转换和重定义来修改，可以则返回 true，否则返回 false。</p>
<p>class 的重转换必须 <code>isRetransformClassesSupported()</code> 为 true；重定义必须要 <code>isRedefineClassesSupported()</code> 为 true。但是这两个方法的返回值不会对当前方法产生影响，这个方法是具体的类维度的定义。</p>
<p>原生类（如 <code>java.lang.Integer.TYPE</code>）以及数组类永远不能被修改</p>
<h4 id="8-获取当前-JVM-已经加载的所有-classes"><a class="header-anchor" href="#8-获取当前-JVM-已经加载的所有-classes">¶</a>8&gt;获取当前 JVM 已经加载的所有 classes</h4>
<pre class="line-numbers language-language-java"><code class="language-language-java">Class[] getAllLoadedClasses()
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h4 id="9-获取某个类加载器已经初始化的类"><a class="header-anchor" href="#9-获取某个类加载器已经初始化的类">¶</a>9&gt;获取某个类加载器已经初始化的类</h4>
<pre class="line-numbers language-language-java"><code class="language-language-java">Class[] getInitiatedClasses(ClassLoader loader)
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>获取传入类加载器已经加载的所有类，如果传入为 null，将视为传入了 boostrap 类加载。</p>
<h4 id="10-获取对象的大小"><a class="header-anchor" href="#10-获取对象的大小">¶</a>10&gt;获取对象的大小</h4>
<pre class="line-numbers language-language-java"><code class="language-language-java">long getObjectSize(Object objectToSize)
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>返回传入对象的大小，这个大小取决于具体虚拟机的实现，且是一个近似值。这个值仅适合在同一个 JVM 内进行比较，另外这个估算值也是可能会变化的。</p>
<h4 id="11-添加额外的-jar"><a class="header-anchor" href="#11-添加额外的-jar">¶</a>11&gt;添加额外的 jar</h4>
<pre class="line-numbers language-language-java"><code class="language-language-java">void appendToBootstrapClassLoaderSearch(JarFile jarfile)
void appendToSystemClassLoaderSearch(JarFile jarfile)
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<ol>
<li>
<p>方法一是添加包含 instrumentation classes 的 jar，当 boostrap 类加载器无法加载某个类的时候，就会在该 jar 中搜索该类进行加载，这个方法可以被调用多次添加多个 jar，避免 jar 中包含除了 instrumentation 之外的 class，导致潜在的类同名加载冲突。一个合适的避免冲突的方法就是给 instrumentation 的类放在一个唯一的包名下。</p>
</li>
<li>
<p>方法二是添加包含 instrumentation classes 的 jar，当 system 类加载器无法加载某个类的时候，就会在该 jar 中搜索该类进行加载，这个方法可以被调用多次添加多个 jar，避免 jar 中包含除了 instrumentation 之外的 class，导致潜在的类同名加载冲突。</p>
<p>当 system 类加载器实现一个名为 <code>appendToClassPathForInstrumentatiion</code> 的、且只有一个 <code>java.lang.String</code> 参数的方法时，才支持这种添加 jar 的方式。JVM 通过 <code>jarfile.getName()</code> 返回的结果传入到该方法的参数中实现添加 jar。</p>
</li>
</ol>
<h4 id="12-isNativeMethodPrefixSupported"><a class="header-anchor" href="#12-isNativeMethodPrefixSupported">¶</a>12&gt;isNativeMethodPrefixSupported</h4>
<h4 id="13-setNativeMethodPrefix"><a class="header-anchor" href="#13-setNativeMethodPrefix">¶</a>13&gt;setNativeMethodPrefix</h4>
<h2 id="两种加载-Agent-的方式"><a class="header-anchor" href="#两种加载-Agent-的方式">¶</a>两种加载 Agent 的方式</h2>
<p>我们需要编写一个 agent 类，这个类中包含一些会被 JVM 通过某种方式运行的钩子方法，然后在钩子方法中可以获取到 JVM 传入的 <code>Instrumentation</code> 实例添加我们的自定义类转换器。</p>
<h3 id="静态加载"><a class="header-anchor" href="#静态加载">¶</a>静态加载</h3>
<p>在启动程序的时候指定 agent：</p>
<ol>
<li>
<p>将我们写好的 agent 打包成一个 jar，在启动 Java 程序的时候指定一个 JVM 参数 <code>javaagent</code></p>
<pre class="line-numbers language-language-shell"><code class="language-language-shell">java -javaagent:<agent jar包路径>[=options] -jar <JVM程序jar包路径>
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>这个选项可以用在一个命令上使用多次，从而创建多个 agent。多个 agent 可能使用同一个 jar。</p>
</li>
<li>
<p>在 agent jar 中的 manifest 添加一项 <code>Premain-class</code> 为我们的 agent 类的全限定名，例如</p>
<pre class="line-numbers language-language-shell"><code class="language-language-shell">Premain-Class : org.example.JavaAgent
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li>
<p>agent 类中的必须存在以下钩子方法中的一个</p>
<pre class="line-numbers language-language-java"><code class="language-language-java">public static void premain(String agentArgs, Instrumentation inst);
public static void premain(String agentArgs);
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>JVM 会先尝试寻找前者调用；如果 agent 中没有实现该方法，就会尝试调用后者；如果还找不到，JVM 就会停止运行。第一步中的 <code>options</code> 字符串会传递到 <code>premain</code> 方法的第一个字符串参数中。</p>
</li>
</ol>
<p>静态指定 agent 的方式在程序启动的时候在任何代码执行之前进行字节码修改（先按照 agent 的定义顺序执行 <code>premain</code> 方法，所有 <code>premain</code> 方法执行完成之后才会执行 <code>main</code> 方法）。</p>
<p>agent class 是通过 system class loader 加载的（<code>ClassLoader.getSystemClassLoader</code>）。这个类加载器同时会加载应用的 main 方法类。<code>premain</code> 方法和 <code>main</code> 方法拥有相同的 security 和 classloader rules，没有什么特别的限制，只要是 <code>main</code> 方法中能做的，<code>premain</code> 方法都可以做。</p>
<p>如果无法获取 agent（包括 agent class 无法加载、agent class 没有 <code>premain</code> 方法）或者 <code>premain</code> 方法抛出了异常，JVM 都会停止运行。</p>
<h3 id="动态加载"><a class="header-anchor" href="#动态加载">¶</a>动态加载</h3>
<p>在 JVM 程序运行之后（<code>main</code> 方法已经运行），通过 <a href="https://docs.oracle.com/javase/7/docs/jdk/api/attach/spec/com/sun/tools/attach/package-summary.html" target="_blank" rel="noopener">Java Attach API</a> 为正在运行的 JVM 进程加载 agent（Arthas）。</p>
<ol>
<li>
<p>将写好的 agent 类打包在一个 JAR，并在 manifest 中添加一项 <code>Agent-Class</code> ，类似 <code>Premain-Class</code>，值为 agent 类的全限定名。</p>
</li>
<li>
<p>agent 类必须实现以下之一的钩子方法：</p>
<pre class="line-numbers language-language-java"><code class="language-language-java">public static void agentmain(String agentArgs, Instrumentation inst);
public static void agentmain(String agentArgs);
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>同 <code>premain</code> 方法，JVM 会先尝试调用前者然后再尝试调用后者。<code>agentmain</code> 方法的类加载器和 <code>premain</code> 一致，security 和 classloader rules 也一致。</p>
</li>
<li>
<blockquote>
<p>注意： agent class 中的 <code>agentmain</code> 方法只有在动态加载的方式中会被调用，而且一旦 JVM 已经启动将不会调用 <code>premain</code> 方法；而在通过命令行方式的静态加载 agent，<code>agentmain</code> 方法不会被调用。</p>
</blockquote>
</li>
<li>
<p>通过 <code>Java Attach API</code> 编写第三个程序代码，该程序会连接到需要被 agent 的 JVM 程序，然后通过类似以下代码使得该程序加载 agent：</p>
<pre class="line-numbers language-language-java"><code class="language-language-java">String agentFilePath = "/Users/zhonghongpeng/IdeaProjects/tech-learning/learingsamples/agent/target/test-agent-jar-with-dependencies.jar";            
VirtualMachine jvm = VirtualMachine.attach(jvmPid);
jvm.loadAgent(agentFile.getAbsolutePath());
jvm.detach();
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
</li>
</ol>
<h3 id="agent-的-manifest-属性"><a class="header-anchor" href="#agent-的-manifest-属性">¶</a>agent 的 manifest 属性</h3>
<ul>
<li>
<p><strong><code>Premain-Class</code>：当 agent 在 JVM 启动的时候被指定，需要定义该属性为 agent class 的全限定名，也就是包含 <code>premain</code> 方法的类，如果该类没有该方法，JVM 会停止运行。</strong></p>
</li>
<li>
<p><strong><code>Agent-Class</code>：如果 JVM 的实现提供了在 VM 启动之后加载 agent 的机制，需要通过当前属性指定 agent 类的全限定名，该类包含了 <code>agentmain</code> 方法，否则 JVM 会停止运行。</strong></p>
</li>
<li>
<p>Boot-Class-Path：A list of paths to be searched by the bootstrap class loader. Paths represent directories or libraries (commonly referred to as JAR or zip libraries on many platforms). These paths are searched by the bootstrap class loader after the platform specific mechanisms of locating a class have failed. Paths are searched in the order listed. Paths in the list are separated by one or more spaces. A path takes the syntax of the path component of a hierarchical URI. The path is absolute if it begins with a slash character (‘/’), otherwise it is relative. A relative path is resolved against the absolute path of the agent JAR file. Malformed and non-existent paths are ignored. When an agent is started sometime after the VM has started then paths that do not represent a JAR file are ignored. This attribute is optional.</p>
</li>
<li>
<p><strong><code>Can-Redefine-Classes</code>：Boolean (<code>true</code> or <code>false</code>, case irrelevant). 是否需要为该 agent 开启 redefine class 的功能. 不是 <code>true</code> 的值都会被当成 <code>false</code>. 可选，默认是 <code>false</code>.</strong></p>
</li>
<li>
<p><strong><code>Can-Retransform-Classes</code>：Boolean (<code>true</code> or <code>false</code>, case irrelevant). 是否需要为该 agent 开启 rertransform class 的功能. 不是 <code>true</code> 的值都会被当成 <code>false</code>. 可选，默认是 <code>false</code>.</strong></p>
</li>
<li>
<p><code>Can-Set-Native-Method-Prefix</code>：Boolean (<code>true</code> or <code>false</code>, case irrelevant). Is the ability to set native method prefix needed by this agent. Values other than <code>true</code> are considered <code>false</code>. This attribute is optional, the default is <code>false</code>.</p>
</li>
</ul>
<h2 id="字节码框架选型指标"><a class="header-anchor" href="#字节码框架选型指标">¶</a>字节码框架选型指标</h2>
<p>high-level API or low-level API, community size, and the license</p>
<h1>遇到的问题和解决</h1>
<h2 id="Maven打包问题"><a class="header-anchor" href="#Maven打包问题">¶</a>Maven打包问题</h2>
<p>默认情况下，maven 仅对当前工程中的源文件编译出来的字节码打包到一个 jar 中，而不会对其依赖项进行打包。一旦我们直接执行打包出来的文件就会遇到 <code>ClassNotFound</code> 等错误。这里通过一个 maven 插件 <code>maven-assembly-plugin</code> 解决，它会对当前项目默认打出来的包进行重新打包（另外 springboot 也有类似的插件），包含了除了 system scope 之外的所有依赖：</p>
<pre class="line-numbers language-language-xml"><code class="language-language-xml">            <plugin>
                <artifactId>maven-assembly-plugin</artifactId>
                <configuration>
                    <archive>
                        <manifest>
                            <addClasspath>true</addClasspath>
                        </manifest>
                        <manifestEntries>
                            <Premain-Class>com.john.agent.MyInstrumentationAgent</Premain-Class>
                            <Main-Class>com.john.application.Launcher</Main-Class>
                            <Can-Retransform-Classes>true</Can-Retransform-Classes>
                            <Can-Redefine-Classes>true</Can-Redefine-Classes>
                        </manifestEntries>
                    </archive>
                    <descriptorRefs>
                        <descriptorRef>jar-with-dependencies</descriptorRef>
                    </descriptorRefs>
                    <finalName>test-agent</finalName>
                </configuration>
            </plugin>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>运行以下命令即可：</p>
<pre class="line-numbers language-language-shell"><code class="language-language-shell">mvn assembly:assembly
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>使用以下命令可以查看需要的 class 是否已经被打在包中：</p>
<pre class="line-numbers language-language-shell"><code class="language-language-shell">jar -tf test-agent-jar-with-dependencies.jar | grep xxx
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h2 id="找不到-VirtualMachine-类"><a class="header-anchor" href="#找不到-VirtualMachine-类">¶</a>找不到 VirtualMachine 类</h2>
<p>在 <code>AgentLoader</code> 类中我们引入了 <code>com.sun.tools.attach.VirtualMachine</code> 类，IDEA 编译是可以通过的，因为 IDEA 自动扫描的 classpath 包含了该类所属 jar 包 tools.jar 所在路径。</p>
<p><img src="https://cdn.jsdelivr.net/gh/JohnZhongg/blog_images/image/20201229115949.png" alt="image-20201229115948942"></p>
<p>但是在进行 maven 打包的时候编译过不了：</p>
<h3 id="步骤1"><a class="header-anchor" href="#步骤1">¶</a>步骤1</h3>
<p>通过增加 system 依赖解决</p>
<pre class="line-numbers language-language-xml"><code class="language-language-xml">        <dependency>
            <groupId>org.sun</groupId>
            <artifactId>tools</artifactId>
            <version>1.0</version>
            <scope>system</scope>
            <systemPath>${JAVA_HOME}/lib/tools.jar</systemPath>
        </dependency>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>以上方式虽然使得 maven 打包的时候可以编译通过但是在运行 jar 文件的时候就找不到了，报了以下错误：</p>
<pre class="line-numbers language-language-shell"><code class="language-language-shell">十二月 29, 2020 10:07:37 上午 com.john.agent.MyInstrumentationAgent premain
信息: [Agent] In premain method
class com.john.application.MyAtmsun.misc.Launcher$AppClassLoader@18b4aac2
Exception in thread "main" java.lang.reflect.InvocationTargetException
        at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)
        at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)
        at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)
        at java.lang.reflect.Method.invoke(Method.java:498)
        at sun.instrument.InstrumentationImpl.loadClassAndStartAgent(InstrumentationImpl.java:386)
        at sun.instrument.InstrumentationImpl.loadClassAndCallPremain(InstrumentationImpl.java:401)
Caused by: java.lang.NoClassDefFoundError: javassist/NotFoundException
        at com.john.agent.MyInstrumentationAgent.transform(MyInstrumentationAgent.java:50)
        at com.john.agent.MyInstrumentationAgent.transformClass(MyInstrumentationAgent.java:31)
        at com.john.agent.MyInstrumentationAgent.premain(MyInstrumentationAgent.java:14)
        ... 6 more
Caused by: java.lang.ClassNotFoundException: javassist.NotFoundException
        at java.net.URLClassLoader.findClass(URLClassLoader.java:381)
        at java.lang.ClassLoader.loadClass(ClassLoader.java:424)
        at sun.misc.Launcher$AppClassLoader.loadClass(Launcher.java:349)
        at java.lang.ClassLoader.loadClass(ClassLoader.java:357)
        ... 9 more

<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>看到了一个 <code>java.lang.NoClassDefFoundError</code> 错误，所有的元信息 <code>Error</code> 都是因为在运行时和编译期的元信息（类、方法、属性等）发生了偏差被抛出。这里是因为在编译期 <code>VirtualMachine</code> 类就需要被检查（因为在 <code>AgentLoader</code> 的 <code>.java</code> 源文件中使用了 <code>import</code> 字面量进行导入，在 <code>javac</code> 编译阶段就需要进行检查；相对于那些不会在编译期做检查的元信息错误即抛出 <code>Exception</code>）是否存在，被引用的方法描述是否正确等，在编译期通过后但是在运行期发现通过所有类加载器都无法找到这个类，即抛出一个该 <code>Error</code>。</p>
<p>其根本原因是因为在运行时类加载器无法找到 <code>tools.jar</code> 这一个包，而这又是因为上面提到的 <code>assembly</code> maven 插件默认不会将 system scope 的 jar 打到包中，以下有三种方式可以解决：</p>
<ol>
<li>增加 <code>assembly.xml</code> 修改 assembly 默认配置：比较繁琐，要引入额外的配置，这里先不选择这种。</li>
<li>执行 java 程序的时候通过 <code>-cp</code> 指定 <code>tools.jar</code>：我们需要通过 <code>-jar</code> 来运行我们打出来的 full jar，同时一旦指定了 <code>-jar</code> 选项，<code>-cp</code> 就会被忽略，不选择。</li>
<li>使用 <code>maven-install</code> 插件将本地安装绑定到 clean 阶段，查看下面的步骤2</li>
</ol>
<h3 id="步骤2"><a class="header-anchor" href="#步骤2">¶</a>步骤2</h3>
<p>引入以下插件，在 <code>mvn clean</code> 阶段将  <code>tools.jar</code> 安装到本地：</p>
<pre class="line-numbers language-language-xml"><code class="language-language-xml">            <plugin>
                <artifactId>maven-assembly-plugin</artifactId>
                <configuration>
                    <archive>
                        <manifest>
                            <addClasspath>true</addClasspath>
                        </manifest>
                        <manifestEntries>
                            <Premain-Class>com.john.agent.MyInstrumentationAgent</Premain-Class>
                            <Agent-Class>com.john.agent.MyInstrumentationAgent</Agent-Class>
                            <Main-Class>com.john.application.Launcher</Main-Class>
                            <Can-Retransform-Classes>true</Can-Retransform-Classes>
                            <Can-Redefine-Classes>true</Can-Redefine-Classes>
                        </manifestEntries>
                    </archive>
                    <descriptorRefs>
                        <descriptorRef>jar-with-dependencies</descriptorRef>
                    </descriptorRefs>
                    <finalName>test-agent</finalName>
                </configuration>
            </plugin>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>然后修改依赖为：</p>
<pre class="line-numbers language-language-xml"><code class="language-language-xml">        <dependency>
            <groupId>org.sun</groupId>
            <artifactId>tools</artifactId>
            <version>0.1</version>
        </dependency>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在每一次执行以下命令之前先执行 <code>mvn clean</code> 即可：</p>
<pre class="line-numbers language-language-shell"><code class="language-language-shell">mvn assembly:assembly
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h1>参考阅读</h1>
<p><a href="https://docs.oracle.com/javase/8/docs/technotes/guides/jvmti/" target="_blank" rel="noopener">oracle JVM TI guide</a></p>
<p><a href="https://docs.oracle.com/javase/8/docs/platform/jvmti/jvmti.html" target="_blank" rel="noopener">JVM Tool Interface Reference</a></p>
<p><a href="https://docs.oracle.com/javase/8/docs/technotes/guides/instrumentation/index.html" target="_blank" rel="noopener">oracle java.lang.instrument pacakge</a></p>
<p><a href="https://docs.oracle.com/javase/8/docs/api/java/lang/instrument/package-summary.html" target="_blank" rel="noopener">oracle java se 8 api document：Package java.lang.instrument</a></p>
<p><a href="https://www.jrebel.com/blog/how-write-javaagent" target="_blank" rel="noopener">Jrebel：How to write Java agent</a></p>
<p><a href="https://www.baeldung.com/java-instrumentation" target="_blank" rel="noopener">baeldung：Guide to Java Instrumentation</a></p>
<p><a href="https://github.com/eugenp/tutorials/tree/master/core-java-modules/core-java-jvm" target="_blank" rel="noopener">包含了静态加载和动态加载实现的代码示例</a></p>
<p><a href="https://dzone.com/articles/java-agent-1#:~:text=Java%20agents%20are%20a%20special,using%20the%20simple%20HelloWorld%20Example." target="_blank" rel="noopener">Understanding Java Agents</a></p>
<p><a href="https://www3.ntu.edu.sg/home/ehchua/programming/java/JavaNativeInterface.html" target="_blank" rel="noopener">Java Programming Tutoriial JNI</a></p>
<p><a href="https://docs.oracle.com/javase/8/docs/technotes/guides/jni/index.html" target="_blank" rel="noopener">Oracle jdk8 JNI</a></p>

            </div>
            <hr />

            
            <style>
    #reward {
        margin: 40px 0;
        text-align: center;
    }

    #reward .reward-link {
        font-size: 1.88rem;
    }

    #reward .btn-floating:hover {
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2), 0 5px 15px rgba(0, 0, 0, 0.2);
    }

    #rewardModal {
        width: 320px;
        height: 350px;
    }

    #rewardModal .reward-title {
        margin: 15px auto;
        padding-bottom: 5px;
    }

    #rewardModal .modal-content {
        padding: 10px;
    }

    #rewardModal .close {
        position: absolute;
        right: 15px;
        top: 15px;
        color: rgba(0, 0, 0, 0.5);
        font-size: 1.3rem;
        line-height: 20px;
        cursor: pointer;
    }

    #rewardModal .close:hover {
        color: #ef5350;
        transform: scale(1.3);
        -moz-transform:scale(1.3);
        -webkit-transform:scale(1.3);
        -o-transform:scale(1.3);
    }

    #rewardModal .reward-tabs {
        margin: 0 auto;
        width: 210px;
    }

    .reward-tabs .tabs {
        height: 38px;
        margin: 10px auto;
        padding-left: 0;
    }

    .reward-content ul {
        padding-left: 0 !important;
    }

    .reward-tabs .tabs .tab {
        height: 38px;
        line-height: 38px;
    }

    .reward-tabs .tab a {
        color: #fff;
        background-color: #ccc;
    }

    .reward-tabs .tab a:hover {
        background-color: #ccc;
        color: #fff;
    }

    .reward-tabs .wechat-tab .active {
        color: #fff !important;
        background-color: #22AB38 !important;
    }

    .reward-tabs .alipay-tab .active {
        color: #fff !important;
        background-color: #019FE8 !important;
    }

    .reward-tabs .reward-img {
        width: 210px;
        height: 210px;
    }
</style>

<div id="reward">
    <a href="#rewardModal" class="reward-link modal-trigger btn-floating btn-large waves-effect waves-light red">赏</a>

    <!-- Modal Structure -->
    <div id="rewardModal" class="modal">
        <div class="modal-content">
            <a class="close modal-close"><i class="fa fa-close"></i></a>
            <h4 class="reward-title">写作不易，客官能否打赏一杯奶茶？</h4>
            <div class="reward-content">
                <div class="reward-tabs">
                    <ul class="tabs row">
                        <li class="tab col s6 alipay-tab waves-effect waves-light"><a href="#alipay">支付宝</a></li>
                        <li class="tab col s6 wechat-tab waves-effect waves-light"><a href="#wechat">微 信</a></li>
                    </ul>
                    <div id="alipay">
                        <img src="/medias/reward/alipay.jpg" class="reward-img" alt="支付宝打赏二维码">
                    </div>
                    <div id="wechat">
                        <img src="/medias/reward/wechat.jpg" class="reward-img" alt="微信打赏二维码">
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    $(function () {
        $('.tabs').tabs();
    });
</script>
            

            <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">

<div id="article-share">
    
    <div class="social-share" data-disabled="qzone" data-wechat-qrcode-helper="<p>微信里点“发现”->“扫一扫”二维码便可查看分享。</p>"></div>
    
</div>

<script src="/libs/share/js/social-share.min.js"></script>

            

    <div class="reprint" id="reprint-statement">
        <p class="reprint-tip">
            <i class="fa fa-exclamation-triangle"></i>&nbsp;&nbsp;
            <span>转载规则</span>
        </p>
        
            <div class="center-align">
                <a rel="license" href="https://creativecommons.org/licenses/by/4.0/deed.zh">
                    <img alt=""
                         style="border-width:0"
                         src="https://i.creativecommons.org/l/by/4.0/88x31.png"/>
                </a>
            </div>
            <br/>
            <span xmlns:dct="http://purl.org/dc/terms/" href="http://purl.org/dc/dcmitype/Text"
                  property="dct:title" rel="dct:type">
                    《Java agent》
                </span> 由
            <a xmlns:cc="http://creativecommons.org/ns#" href="/2020/01/04/jvm/za-xiang/java-agent/" property="cc:attributionName"
               rel="cc:attributionURL">
                阿钟
            </a> 采用
            <a rel="license" href="https://creativecommons.org/licenses/by/4.0/deed.zh">
                知识共享署名 4.0 国际许可协议
            </a>进行许可。
        
    </div>

    <script async defer>
      document.addEventListener("copy", function (e) {
        let toastHTML = '<span>复制成功，请遵循本文的转载规则</span><button class="btn-flat toast-action" onclick="navToReprintStatement()" style="font-size: smaller">查看</a>';
        M.toast({html: toastHTML})
      });

      function navToReprintStatement() {
        $("html, body").animate({scrollTop: $("#reprint-statement").offset().top - 80}, 800);
      }
    </script>


        </div>
    </div>

    
    <link rel="stylesheet" href="/libs/gitalk/gitalk.css">
<link rel="stylesheet" href="/css/my-gitalk.css">

<div class="card gitalk-card" data-aos="fade-up">
    <div id="gitalk-container" class="card-content"></div>
</div>

<script src="/libs/gitalk/gitalk.min.js"></script>
<script>
    let gitalk = new Gitalk({
        clientID: '466e387c08bce10f3f28',
        clientSecret: '5b2bf16f8a42bd72eef32e50187c7f2ccb105a1d',
        repo: 'azhong.github.io',
        owner: 'JohnZhongg',
        admin: "JohnZhongg",
        id: '2020/01/04/jvm/za-xiang/java-agent/',
        distractionFreeMode: false  // Facebook-like distraction free mode
    });

    gitalk.render('gitalk-container');
</script>
    

    

    

    

    
    <style>
    .valine-card {
        margin: 1.5rem auto;
    }

    .valine-card .card-content {
        padding: 20px 20px 5px 20px;
    }

    #vcomments input[type=text],
    #vcomments input[type=email],
    #vcomments input[type=url],
    #vcomments textarea {
        box-sizing: border-box;
    }

    #vcomments p {
        margin: 2px 2px 10px;
        font-size: 1.05rem;
        line-height: 1.78rem;
    }

    #vcomments blockquote p {
        text-indent: 0.2rem;
    }

    #vcomments a {
        padding: 0 2px;
        color: #42b983;
        font-weight: 500;
        text-decoration: underline;
    }

    #vcomments img {
        max-width: 100%;
        height: auto;
        cursor: pointer;
    }

    #vcomments ol li {
        list-style-type: decimal;
    }

    #vcomments ol,
    ul {
        display: block;
        padding-left: 2em;
        word-spacing: 0.05rem;
    }

    #vcomments ul li,
    ol li {
        display: list-item;
        line-height: 1.8rem;
        font-size: 1rem;
    }

    #vcomments ul li {
        list-style-type: disc;
    }

    #vcomments ul ul li {
        list-style-type: circle;
    }

    #vcomments table, th, td {
        padding: 12px 13px;
        border: 1px solid #dfe2e5;
    }

    #vcomments table, th, td {
        border: 0;
    }

    table tr:nth-child(2n), thead {
        background-color: #fafafa;
    }

    #vcomments table th {
        background-color: #f2f2f2;
        min-width: 80px;
    }

    #vcomments table td {
        min-width: 80px;
    }

    #vcomments h1 {
        font-size: 1.85rem;
        font-weight: bold;
        line-height: 2.2rem;
    }

    #vcomments h2 {
        font-size: 1.65rem;
        font-weight: bold;
        line-height: 1.9rem;
    }

    #vcomments h3 {
        font-size: 1.45rem;
        font-weight: bold;
        line-height: 1.7rem;
    }

    #vcomments h4 {
        font-size: 1.25rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    #vcomments h5 {
        font-size: 1.1rem;
        font-weight: bold;
        line-height: 1.4rem;
    }

    #vcomments h6 {
        font-size: 1rem;
        line-height: 1.3rem;
    }

    #vcomments p {
        font-size: 1rem;
        line-height: 1.5rem;
    }

    #vcomments hr {
        margin: 12px 0;
        border: 0;
        border-top: 1px solid #ccc;
    }

    #vcomments blockquote {
        margin: 15px 0;
        border-left: 5px solid #42b983;
        padding: 1rem 0.8rem 0.3rem 0.8rem;
        color: #666;
        background-color: rgba(66, 185, 131, .1);
    }

    #vcomments pre {
        font-family: monospace, monospace;
        padding: 1.2em;
        margin: .5em 0;
        background: #272822;
        overflow: auto;
        border-radius: 0.3em;
        tab-size: 4;
    }

    #vcomments code {
        font-family: monospace, monospace;
        padding: 1px 3px;
        font-size: 0.92rem;
        color: #e96900;
        background-color: #f8f8f8;
        border-radius: 2px;
    }

    #vcomments pre code {
        font-family: monospace, monospace;
        padding: 0;
        color: #e8eaf6;
        background-color: #272822;
    }

    #vcomments pre[class*="language-"] {
        padding: 1.2em;
        margin: .5em 0;
    }

    #vcomments code[class*="language-"],
    pre[class*="language-"] {
        color: #e8eaf6;
    }

    #vcomments [type="checkbox"]:not(:checked), [type="checkbox"]:checked {
        position: inherit;
        margin-left: -1.3rem;
        margin-right: 0.4rem;
        margin-top: -1px;
        vertical-align: middle;
        left: unset;
        visibility: visible;
    }

    #vcomments b,
    strong {
        font-weight: bold;
    }

    #vcomments dfn {
        font-style: italic;
    }

    #vcomments small {
        font-size: 85%;
    }

    #vcomments cite {
        font-style: normal;
    }

    #vcomments mark {
        background-color: #fcf8e3;
        padding: .2em;
    }

    #vcomments table, th, td {
        padding: 12px 13px;
        border: 1px solid #dfe2e5;
    }

    table tr:nth-child(2n), thead {
        background-color: #fafafa;
    }

    #vcomments table th {
        background-color: #f2f2f2;
        min-width: 80px;
    }

    #vcomments table td {
        min-width: 80px;
    }

    #vcomments [type="checkbox"]:not(:checked), [type="checkbox"]:checked {
        position: inherit;
        margin-left: -1.3rem;
        margin-right: 0.4rem;
        margin-top: -1px;
        vertical-align: middle;
        left: unset;
        visibility: visible;
    }
</style>

<div class="card valine-card" data-aos="fade-up">
    <div id="vcomments" class="card-content"></div>
</div>

<script src="/libs/valine/av-min.js"></script>
<script src="/libs/valine/Valine.min.js"></script>
<!-- <script src="//unpkg.com/valine@latest/dist/Valine.min.js"></script> -->

<script>
    new Valine({
        el: '#vcomments',
        appId: '',
        appKey: '',
        notify: 'false' === 'true',
        verify: 'false' === 'true',
        visitor: 'false' === 'true',
        avatar: 'wavatar',
        pageSize: '10',
        lang: 'zh-cn',
        placeholder: '如果你没有GitHub账号，还可以在这里评论啦！'
    });
</script>

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fa fa-chevron-left"></i>&nbsp;上一篇</div>
            <div class="card">
                <a href="/2020/01/04/redis/redis-guan-fang-wen-dang/redlock/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/1.jpg" class="responsive-img" alt="基于 Redis 的分布式锁：RedLock">
                        
                        <span class="card-title">基于 Redis 的分布式锁：RedLock</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            基于 Redis 的分布式锁：RedLock
                        
                    </div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="fa fa-clock-o fa-fw icon-date"></i>2020-01-04
                        </span>
                        <span class="publish-author">
                            
                            <i class="fa fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/redis/" class="post-category" target="_blank">
                                    redis
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/分布式锁/" target="_blank">
                        <span class="chip bg-color">分布式锁</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                本篇&nbsp;<i class="fa fa-dot-circle-o"></i>
            </div>
            <div class="card">
                <a href="/2020/01/04/jvm/za-xiang/java-agent/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/0.jpg" class="responsive-img" alt="Java agent">
                        
                        <span class="card-title">Java agent</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            Java agent
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="fa fa-clock-o fa-fw icon-date"></i>2020-01-04
                            </span>
                        <span class="publish-author">
                            
                            <i class="fa fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/JVM学习/" class="post-category" target="_blank">
                                    JVM学习
                                </a>
                            
                            
                        </span>
                    </div>
                </div>

                
                <div class="card-action article-tags">
                    
                    <a href="/tags/JVM学习/" target="_blank">
                        <span class="chip bg-color">JVM学习</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>
</div>


    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget">
            <div class="toc-title"><i class="fa fa-list-alt"></i>&nbsp;&nbsp;目录</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fa fa-list"></i>
    </a>
</div>


<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            // headingsOffset: -205,
            headingSelector: 'h1, h2, h3, h4'
        });

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('#articleContent').children('h1, h2, h3, h4').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).slideUp(500);
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).slideDown(500);
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>
    

</main>


<script src="https://cdn.bootcss.com/mathjax/2.7.5/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
<script>
    MathJax.Hub.Config({
        tex2jax: {inlineMath: [['$', '$'], ['\(', '\)']]}
    });
</script>

<script type="text/javascript" src="/libs/codeBlock/codeBlockFuction.js"></script>
<!-- 代码语言 -->
<script type="text/javascript" src="/libs/codeBlock/codeLang.js"></script>
<!-- 代码块复制 -->
<script type="text/javascript" src="/libs/codeBlock/codeCopy.js"></script>
<script type="text/javascript" src="/libs/codeBlock/clipboard.min.js"></script>
<!-- 代码块收缩 -->
<script type="text/javascript" src="/libs/codeBlock/codeShrink.js"></script> 
<!-- 代码块折行 -->
<style type="text/css">code[class*="language-"], pre[class*="language-"] { white-space: pre !important; }</style>


    <footer class="page-footer bg-color">
    <div class="container row center-align">
        <div class="col s12 m8 l8 copy-right">
            &copy; 2020- Azhong. 版权所有

            
            &nbsp;<i class="fa fa-area-chart"></i>&nbsp;站点总字数:&nbsp;
            <span class="white-color">632.8k</span>
            

            <br>
            <span id="sitetime"></span>

            
            
            <br>
            
            <span id="busuanzi_container_site_pv" style='display:none'>
                <i class="fa fa-heart-o"></i>
                本站总访问量 <span id="busuanzi_value_site_pv" class="white-color"></span>
            </span>
            
            
            <span id="busuanzi_container_site_uv" style='display:none'>
                人次,&nbsp;访客数 <span id="busuanzi_value_site_uv" class="white-color"></span> 人.
            </span>
            
            
        </div>
        <div class="col s12 m4 l4 social-link social-statis">
    <a href="https://github.com/JohnZhongg" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
        <i class="fa fa-github"></i>
    </a>



    <a href="mailto:707845008@qq.com" class="tooltipped" target="_blank" data-tooltip="邮件联系我" data-position="top" data-delay="50">
        <i class="fa fa-envelope-open"></i>
    </a>



    <a href="https://zhihu.com/people/change-94-17" class="tooltipped" target="_blank" data-tooltip="访问我的知乎" data-position="top" data-delay="50">
        <i class="fa fa-inverse">知</i>
    </a>



    <a href="http://wpa.qq.com/msgrd?v=3&uin=707845008&site=qq&menu=yes" class="tooltipped" target="_blank" data-tooltip="访问我的知乎" data-position="top" data-delay="50">
        <i class="fa fa-qq"></i>
    </a>


<!-- 


    <a href="/atom.xml" class="tooltipped" target="_blank" data-tooltip="RSS 订阅" data-position="top" data-delay="50">
        <i class="fa fa-rss"></i>
    </a>
 --></div>
    </div>
</footer>

<div class="progress-bar"></div>

<!-- 不蒜子计数初始值纠正 -->
<script>
    $(document).ready(function () {

        var int = setInterval(fixCount, 50);
        var pvcountOffset = 0;
        var uvcountOffset = 0;

        function fixCount() {
            if (document.getElementById("busuanzi_container_site_pv").style.display != "none") {
                $("#busuanzi_value_site_pv").html(parseInt($("#busuanzi_value_site_pv").html()) + pvcountOffset);
                clearInterval(int);
            }
            if ($("#busuanzi_container_site_pv").css("display") != "none") {
                $("#busuanzi_value_site_uv").html(parseInt($("#busuanzi_value_site_uv").html()) + uvcountOffset); // 加上初始数据 
                clearInterval(int);
            }
        }
    });
</script>

<script language=javascript>
    function siteTime() {
        window.setTimeout("siteTime()", 1000);
        var seconds = 1000;
        var minutes = seconds * 60;
        var hours = minutes * 60;
        var days = hours * 24;
        var years = days * 365;
        var today = new Date();
        var todayYear = today.getFullYear();
        var todayMonth = today.getMonth() + 1;
        var todayDate = today.getDate();
        var todayHour = today.getHours();
        var todayMinute = today.getMinutes();
        var todaySecond = today.getSeconds();
        /* Date.UTC() -- 返回date对象距世界标准时间(UTC)1970年1月1日午夜之间的毫秒数(时间戳)
        year - 作为date对象的年份，为4位年份值
        month - 0-11之间的整数，做为date对象的月份
        day - 1-31之间的整数，做为date对象的天数
        hours - 0(午夜24点)-23之间的整数，做为date对象的小时数
        minutes - 0-59之间的整数，做为date对象的分钟数
        seconds - 0-59之间的整数，做为date对象的秒数
        microseconds - 0-999之间的整数，做为date对象的毫秒数 */
        var t1 = Date.UTC(2020, 12, 20, 00, 00, 00); //北京时间2018-2-13 00:00:00
        var t2 = Date.UTC(todayYear, todayMonth, todayDate, todayHour, todayMinute, todaySecond);
        var diff = t2 - t1;
        var diffYears = Math.floor(diff / years);
        var diffDays = Math.floor((diff / days) - diffYears * 365);
        var diffHours = Math.floor((diff - (diffYears * 365 + diffDays) * days) / hours);
        var diffMinutes = Math.floor((diff - (diffYears * 365 + diffDays) * days - diffHours * hours) / minutes);
        var diffSeconds = Math.floor((diff - (diffYears * 365 + diffDays) * days - diffHours * hours - diffMinutes * minutes) / seconds);
        document.getElementById("sitetime").innerHTML = "本站已运行 " + diffYears + " 年 " + diffDays + " 天 " + diffHours + " 小时 " + diffMinutes + " 分钟 " + diffSeconds + " 秒";
    }/*因为建站时间还没有一年，就将之注释掉了。需要的可以取消*/
    siteTime();
</script>


    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fa fa-search"></i>&nbsp;&nbsp;搜索</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script src="/js/search.js"></script>
<script type="text/javascript">
$(function () {
    searchFunc("/" + "search.xml", 'searchInput', 'searchResult');
});
</script>
    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fa fa-angle-up"></i>
    </a>
</div>


    <script src="/libs/materialize/materialize.min.js"></script>
    <script src="/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="/libs/aos/aos.js"></script>
    <script src="/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="/js/matery.js"></script>

    <script type="text/javascript"> var OriginTitile = document.title, st; document.addEventListener("visibilitychange", function () { document.hidden ? (document.title = "Σ(っ °Д °;)っ喔哟，崩溃啦！", clearTimeout(st)) : (document.title = "φ(゜▽゜*)♪咦，又好了！", st = setTimeout(function () { document.title = OriginTitile }, 3e3)) })
    </script>

    <!-- Global site tag (gtag.js) - Google Analytics -->

<script async src="https://www.googletagmanager.com/gtag/js?id="></script>
<script>
    window.dataLayer = window.dataLayer || [];
    function gtag() {
        dataLayer.push(arguments);
    }

    gtag('js', new Date());
    gtag('config', '');
</script>



    
    <script src="/libs/others/clicklove.js"></script>
    

    
    <script async src="/libs/others/busuanzi.pure.mini.js"></script>
    

    <!-- 雪花特效 -->
    

</body>

</html>