<!DOCTYPE HTML>
<html lang="zh-CN">


<head><meta name="generator" content="Hexo 3.9.0">
    <meta charset="utf-8">
    <meta name="keywords" content="k8s入门概述, 技术博客 钟鸿鹏 honphan 阿钟">
    <meta name="baidu-site-verification" content="fmlEuI34ir">
    <meta name="google-site-verification" content="yCy2azpds5XSuGZvis6OuA-XIGF5GuGpYRAaGfD6o48">
    <meta name="360-site-verification" content="b7c11a830ef90fd1464ad6206bb7b6e7">
    <meta name="description" content="k8s 里面的节点分为 master 和 node 节点，master 提供 api 操作集群。

Master：

API Server：和外界交互
Scheduler：调度
Controller：控制，如维持 pods 的期望部署数量和">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>k8s入门概述 | 阿钟的博客</title>
    <link rel="icon" type="image/png" href="/favicon.png">

    <link rel="stylesheet" type="text/css" href="/libs/awesome/css/font-awesome.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
    <link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css" href="/css/matery.css">
    <link rel="stylesheet" type="text/css" href="/css/my.css">
    <style type="text/css">
        
    </style>

    <script src="/libs/jquery/jquery-2.2.0.min.js"></script>
    <script src="https://sdk.jinrishici.com/v2/browser/jinrishici.js" charset="utf-8"></script>
    <script>
        var _hmt = _hmt || [];
        (function () {
            var hm = document.createElement("script");
            hm.src = "https://hm.baidu.com/hm.js?46e79e71af0709a5b9106bf20cecc493";
            var s = document.getElementsByTagName("script")[0];
            s.parentNode.insertBefore(hm, s);
        })();
    </script>

    
        <script>
            (function(){
                var bp = document.createElement('script');
                var curProtocol = window.location.protocol.split(':')[0];
                if (curProtocol === 'https') {
                    bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
                }
                else {
                    bp.src = 'http://push.zhanzhang.baidu.com/push.js';
                }
                var s = document.getElementsByTagName("script")[0];
                s.parentNode.insertBefore(bp, s);
            })();
        </script>
    

    <script>
        (function(){
        var src = "https://jspassport.ssl.qhimg.com/11.0.1.js?d182b3f28525f2db83acfaaf6e696dba";
        document.write('<script src="' + src + '" id="sozz"><\/script>');
        })();
    </script>

<link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css">
<link rel="stylesheet" href="/css/prism-line-numbers.css" type="text/css"></head>

<body>

    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="/medias/logo.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">阿钟的博客</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fa fa-navicon"></i></a>
<ul class="right">
    
    <li class="hide-on-med-and-down">
        <a href="/" class="waves-effect waves-light">
            
            <i class="fa fa-home"></i>
            
            <span>首页</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/tags" class="waves-effect waves-light">
            
            <i class="fa fa-tags"></i>
            
            <span>标签</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/categories" class="waves-effect waves-light">
            
            <i class="fa fa-bookmark"></i>
            
            <span>分类</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/archives" class="waves-effect waves-light">
            
            <i class="fa fa-archive"></i>
            
            <span>归档</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/about" class="waves-effect waves-light">
            
            <i class="fa fa-user-circle-o"></i>
            
            <span>关于</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/friends" class="waves-effect waves-light">
            
            <i class="fa fa-address-book"></i>
            
            <span>友情链接</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/contact" class="waves-effect waves-light">
            
            <i class="fa fa-comments"></i>
            
            <span>留言板</span>
        </a>
    </li>
    
    <li>
        <a href="#searchModal" class="modal-trigger waves-effect waves-light">
            <i id="searchIcon" class="fa fa-search" title="搜索"></i>
        </a>
    </li>
</ul>

<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="/medias/logo.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">阿钟的博客</div>
        <div class="logo-desc">
            
            keep going...
            
        </div>
    </div>

    

    <ul class="menu-list mobile-menu-list">
        
        <li>
            <a href="/" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-home"></i>
                
                首页
            </a>
        </li>
        
        <li>
            <a href="/tags" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-tags"></i>
                
                标签
            </a>
        </li>
        
        <li>
            <a href="/categories" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-bookmark"></i>
                
                分类
            </a>
        </li>
        
        <li>
            <a href="/archives" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-archive"></i>
                
                归档
            </a>
        </li>
        
        <li>
            <a href="/about" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-user-circle-o"></i>
                
                关于
            </a>
        </li>
        
        <li>
            <a href="/friends" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-address-book"></i>
                
                友情链接
            </a>
        </li>
        
        <li>
            <a href="/contact" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-comments"></i>
                
                留言板
            </a>
        </li>
        
        
        <li><div class="divider"></div></li>
        <li>
            <a href="https://github.com/JohnZhongg" class="waves-effect waves-light" target="_blank">
                <i class="fa fa-github-square fa-fw"></i>Fork Me
            </a>
        </li>
        
    </ul>
</div>

        </div>

        
            <style>
    .nav-transparent .github-corner {
        display: none !important;
    }

    .github-corner {
        position: absolute;
        z-index: 10;
        top: 0;
        right: 0;
        border: 0;
        transform: scale(1.1);
    }

    .github-corner svg {
        color: #0f9d58;
        fill: #fff;
        height: 64px;
        width: 64px;
    }

    .github-corner:hover .octo-arm {
        animation: a 0.56s ease-in-out;
    }

    .github-corner .octo-arm {
        animation: none;
    }

    @keyframes a {
        0%,
        to {
            transform: rotate(0);
        }
        20%,
        60% {
            transform: rotate(-25deg);
        }
        40%,
        80% {
            transform: rotate(10deg);
        }
    }
</style>

<a href="https://github.com/JohnZhongg" class="github-corner tooltipped hide-on-med-and-down" target="_blank"
   data-tooltip="Fork Me" data-position="left" data-delay="50">
    <svg viewBox="0 0 250 250" aria-hidden="true">
        <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path>
        <path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2"
              fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path>
        <path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z"
              fill="currentColor" class="octo-body"></path>
    </svg>
</a>
        
    </nav>

</header>

    
<script src="/libs/cryptojs/crypto-js.min.js"></script>
<script>
    (function() {
        let pwd = '';
        if (pwd && pwd.length > 0) {
            if (pwd !== CryptoJS.SHA256(prompt('请输入访问本文章的密码')).toString(CryptoJS.enc.Hex)) {
                alert('密码错误，将返回主页！');
                location.href = '/';
            }
        }
    })();
</script>




<div class="bg-cover pd-header post-cover" style="background-image: url('/medias/featureimages/1.jpg')">
    <div class="container">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <div class="description center-align post-title">
                        k8s入门概述
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>



<main class="post-container content">

    
    <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
<style>
    #articleContent h1::before,
    #articleContent h2::before,
    #articleContent h3::before,
    #articleContent h4::before,
    #articleContent h5::before,
    #articleContent h6::before {
        display: block;
        content: " ";
        height: 100px;
        margin-top: -100px;
        visibility: hidden;
    }

    #articleContent :focus {
        outline: none;
    }

    .toc-fixed {
        position: fixed;
        top: 64px;
    }

    .toc-widget {
        padding-left: 20px;
    }

    .toc-widget .toc-title {
        margin: 35px 0 15px 0;
        padding-left: 17px;
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    .toc-widget ol {
        padding: 0;
        list-style: none;
    }

    #toc-content ol {
        padding-left: 10px;
    }

    #toc-content ol li {
        padding-left: 10px;
    }

    #toc-content .toc-link:hover {
        color: #42b983;
        font-weight: 700;
        text-decoration: underline;
    }

    #toc-content .toc-link::before {
        background-color: transparent;
        max-height: 25px;
    }

    #toc-content .is-active-link {
        color: #42b983;
    }

    #toc-content .is-active-link::before {
        background-color: #42b983;
    }

    #floating-toc-btn {
        position: fixed;
        right: 20px;
        bottom: 76px;
        padding-top: 15px;
        margin-bottom: 0;
        z-index: 998;
    }

    #floating-toc-btn .btn-floating {
        width: 48px;
        height: 48px;
    }

    #floating-toc-btn .btn-floating i {
        line-height: 48px;
        font-size: 1.4rem;
    }
</style>
<div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                        <a href="/tags/k8s/" target="_blank">
                            <span class="chip bg-color">k8s</span>
                        </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fa fa-bookmark fa-fw icon-category"></i>
                        
                        <a href="/categories/k8s/" class="post-category" target="_blank">
                            k8s
                        </a>
                        
                    </div>
                    
                </div>
            </div>

            <div class="post-info">
                <div class="post-date info-break-policy">
                    <i class="fa fa-calendar-minus-o fa-fw"></i>发布日期:&nbsp;&nbsp;
                    2020-12-22
                </div>

                <div class="post-author info-break-policy">
                    <i class="fa fa-user-o fa-fw"></i>作者:&nbsp;&nbsp;
                    
                    阿钟
                    
                </div>

                
                
                <div class="info-break-policy">
                    <i class="fa fa-file-word-o fa-fw"></i>文章字数:&nbsp;&nbsp;
                    5.9k
                </div>
                

                
                <div class="info-break-policy">
                    <i class="fa fa-clock-o fa-fw"></i>阅读时长:&nbsp;&nbsp;
                    29 分
                </div>
                
                

                
                <div id="busuanzi_container_page_pv" class="info-break-policy">
                    <i class="fa fa-eye fa-fw"></i>阅读次数:&nbsp;&nbsp;
                    <span id="busuanzi_value_page_pv"></span>
                </div>
                
            </div>
        </div>
        <hr class="clearfix">
        <div class="card-content article-card-content">
            <div id="articleContent">
                <p>k8s 里面的节点分为 master 和 node 节点，master 提供 api 操作集群。</p>
<p><img src="https://cdn.jsdelivr.net/gh/JohnZhongg/blog_images/image/20201221203114.png" alt="image-20201022152526918"></p>
<p>Master：</p>
<ul>
<li>API Server：和外界交互</li>
<li>Scheduler：调度</li>
<li>Controller：控制，如维持 pods 的期望部署数量和实际部署数量的匹配</li>
<li>etcd：存储数据</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/JohnZhongg/blog_images/image/20201221203122.png" alt="image-20201022152624806"></p>
<p>Node：</p>
<ul>
<li>Pod：具有相同 namespace 的容器的集合就是一个 Pod</li>
<li>Docker：容器技术的实现</li>
<li>kubelet：Master 节点控制 Node 节点的桥梁</li>
<li>kube-proxy：网络控制相关、services 负载均衡</li>
<li>Fluentd：日志采集、存储、查询</li>
<li>Optional 的插件：DNS、UI etc</li>
<li>Image Registry：镜像服务</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/JohnZhongg/blog_images/image/20201221203130.png" alt="image-20201022152735696"></p>
<p><img src="https://cdn.jsdelivr.net/gh/JohnZhongg/blog_images/image/20201221203137.png" alt="image-20201022153122051"></p>
<h1 id="k8s安装"><a href="#k8s安装" class="headerlink" title="k8s安装"></a>k8s安装</h1><ul>
<li><p>从0一步一步手动搭建 k8s 集群的<a href="https://github.com/kelseyhightower/kubernetes-the-hard-way" target="_blank" rel="noopener">步骤</a>，最困难，最容易熟悉 k8s</p>
</li>
<li><p>快速创建有一个单节点的集群的 <a href="https://github.com/kubernetes/minikube" target="_blank" rel="noopener">minikube 工具</a></p>
</li>
<li><p>方便地安装一个多节点的集群的 <a href="https://github.com/kubernetes/kubeadm" target="_blank" rel="noopener">kubeadm 工具</a></p>
</li>
<li><p>使用 coreos 公司的 <a href="https://coreos.com/tectonic/docs/latest/" target="_blank" rel="noopener">tectonic</a> 安装，这个软件也是基于 vagrant 和 virtualbox 的，不过现在 coreos 公司被 RedHat 收购了， tectonic 被移植到 <a href="https://www.openshift.com/try" target="_blank" rel="noopener">OpenShift</a> 上面了</p>
</li>
<li><p>在云上安装多节点集群的 <a href="https://github.com/kubernetes/kops" target="_blank" rel="noopener">kops 工具</a></p>
</li>
<li><p><a href="https://labs.play-with-k8s.com/" target="_blank" rel="noopener">别人提供的资源供web页面操作</a></p>
</li>
</ul>
<h2 id="minikube-安装"><a href="#minikube-安装" class="headerlink" title="minikube 安装"></a>minikube 安装</h2><p><a href="https://kubernetes.io/docs/tasks/tools/" target="_blank" rel="noopener">官网安装工具页面</a>：</p>
<ol>
<li><p>依赖一个虚拟化技术，可以使用 virtual box，先安装 <a href="https://www.virtualbox.org/" target="_blank" rel="noopener">virtual box</a></p>
</li>
<li><p>先安装 <a href="https://kubernetes.io/docs/tasks/tools/install-kubectl/" target="_blank" rel="noopener">kubectl</a> ，注意<a href="https://kubernetes.io/docs/tasks/tools/install-kubectl/#enable-kubectl-autocompletion" target="_blank" rel="noopener">页面的最后</a>有介绍 kubectl 命令的自动补全功能，目前只支持 bash shell 和 zsh shell。</p>
</li>
<li><p>安装 <a href="https://minikube.sigs.k8s.io/docs/start/" target="_blank" rel="noopener">minikube</a></p>
<ul>
<li>minikube 类似 vagrant 和 docker machine，会依赖虚拟化技术创建一个 VM，然后安装一系列的 docker 和 k8s 的软件，在安装过程中会拉取镜像，官方的 minikube 可能会去拉取一些在 google 服务器中的镜像，会遇到网络问题，这是阿里云提供<a href="https://developer.aliyun.com/article/221687" target="_blank" rel="noopener">的解决方案</a> 。</li>
</ul>
</li>
<li><p>使用 minikube 创建一个 k8s 集群</p>
<pre class="line-numbers language-powershell"><code class="language-powershell">minikube <span class="token function">start</span> <span class="token operator">--</span>registry<span class="token operator">-</span>mirror=https:<span class="token operator">/</span><span class="token operator">/</span>8awf7z4n<span class="token punctuation">.</span>mirror<span class="token punctuation">.</span>aliyuncs<span class="token punctuation">.</span>com<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li><p>使用 <code>kubectl</code> 查看集群的上下文(context)信息：</p>
<p>查看集群详细信息：</p>
<pre class="line-numbers language-powershell"><code class="language-powershell">D:\k8s>kubectl config view
apiVersion: v1
clusters:
<span class="token operator">-</span> cluster:
    certificate<span class="token operator">-</span>authority: C:\Users\john\<span class="token punctuation">.</span>minikube\ca<span class="token punctuation">.</span>crt
    server: https:<span class="token operator">/</span><span class="token operator">/</span>192<span class="token punctuation">.</span>168<span class="token punctuation">.</span>99<span class="token punctuation">.</span>100:8443
  name: minikube
contexts:
<span class="token operator">-</span> context:
    cluster: minikube
    user: minikube
  name: minikube
current<span class="token operator">-</span>context: minikube
kind: Config
preferences: <span class="token punctuation">{</span><span class="token punctuation">}</span>
users:
<span class="token operator">-</span> name: minikube
  user:
    client<span class="token operator">-</span>certificate: C:\Users\john\<span class="token punctuation">.</span>minikube\profiles\minikube\client<span class="token punctuation">.</span>crt
    client<span class="token operator">-</span>key: C:\Users\john\<span class="token punctuation">.</span>minikube\profiles\minikube\client<span class="token punctuation">.</span>key<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>列出所有集群</p>
<pre class="line-numbers language-powershell"><code class="language-powershell">D:\k8s>kubectl config get<span class="token operator">-</span>contexts
CURRENT   NAME       CLUSTER    AUTHINFO   NAMESPACE
<span class="token operator">*</span>         minikube   minikube   minikube<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>查看集群状态：</p>
<pre class="line-numbers language-powershell"><code class="language-powershell">D:\k8s>kubectl cluster<span class="token operator">-</span>info
Kubernetes master is running at https:<span class="token operator">/</span><span class="token operator">/</span>192<span class="token punctuation">.</span>168<span class="token punctuation">.</span>99<span class="token punctuation">.</span>100:8443
KubeDNS is running at https:<span class="token operator">/</span><span class="token operator">/</span>192<span class="token punctuation">.</span>168<span class="token punctuation">.</span>99<span class="token punctuation">.</span>100:8443<span class="token operator">/</span>api<span class="token operator">/</span>v1<span class="token operator">/</span>namespaces<span class="token operator">/</span>kube<span class="token operator">-</span>system<span class="token operator">/</span>services<span class="token operator">/</span>kube<span class="token operator">-</span>dns:dns<span class="token operator">/</span>proxy

To further debug and diagnose cluster problems<span class="token punctuation">,</span> use <span class="token string">'kubectl cluster-info dump'</span><span class="token punctuation">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>获取集群节点简要信息和详细信息：</p>
<pre class="line-numbers language-powershell"><code class="language-powershell">D:\docker\docker\chapter9\labs\deployment>kubectl get node
NAME       STATUS   ROLES    AGE   VERSION
minikube   Ready    master   14h   v1<span class="token punctuation">.</span>19<span class="token punctuation">.</span>2

D:\docker\docker\chapter9\labs\deployment>kubectl get node <span class="token operator">-</span>o wide
NAME       STATUS   ROLES    AGE   VERSION   INTERNAL<span class="token operator">-</span>IP      EXTERNAL<span class="token operator">-</span>IP   OS<span class="token operator">-</span>IMAGE               KERNEL<span class="token operator">-</span>VERSION   CONTAINER<span class="token operator">-</span>RUNTIME
minikube   Ready    master   14h   v1<span class="token punctuation">.</span>19<span class="token punctuation">.</span>2   192<span class="token punctuation">.</span>168<span class="token punctuation">.</span>99<span class="token punctuation">.</span>100   &lt;none>        Buildroot 2019<span class="token punctuation">.</span>02<span class="token punctuation">.</span>11   4<span class="token punctuation">.</span>19<span class="token punctuation">.</span>114         docker:<span class="token operator">/</span><span class="token operator">/</span>19<span class="token punctuation">.</span>3<span class="token punctuation">.</span>12<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>通过 <code>minikube ssh</code> 进入集群虚拟机，类似 vagrant</p>
<pre class="line-numbers language-powershell"><code class="language-powershell">D:\k8s>minikube ssh
                         _             _
            _         _ <span class="token punctuation">(</span> <span class="token punctuation">)</span>           <span class="token punctuation">(</span> <span class="token punctuation">)</span>
  ___ ___  <span class="token punctuation">(</span>_<span class="token punctuation">)</span>  ___  <span class="token punctuation">(</span>_<span class="token punctuation">)</span><span class="token punctuation">|</span> <span class="token punctuation">|</span><span class="token operator">/</span><span class="token string">')  _   _ | |_      __
/'</span> _ ` _ `\<span class="token punctuation">|</span> <span class="token punctuation">|</span><span class="token operator">/</span><span class="token string">' _ `\| || , &lt;  ( ) ( )| '</span>_`\  <span class="token operator">/</span><span class="token string">'__`\
| ( ) ( ) || || ( ) || || |\`\ | (_) || |_) )(  ___/
(_) (_) (_)(_)(_) (_)(_)(_) (_)`\___/'</span><span class="token punctuation">(</span>_<span class="token punctuation">,</span>__<span class="token operator">/</span>'`\____<span class="token punctuation">)</span>

$ docker version
Client: Docker Engine <span class="token operator">-</span> Community
 Version:           19<span class="token punctuation">.</span>03<span class="token punctuation">.</span>12
 API version:       1<span class="token punctuation">.</span>40
 Go version:        go1<span class="token punctuation">.</span>13<span class="token punctuation">.</span>10
 Git commit:        48a66213fe
 Built:             Mon Jun 22 15:42:53 2020
 OS<span class="token operator">/</span>Arch:           linux<span class="token operator">/</span>amd64
 Experimental:      false

Server: Docker Engine <span class="token operator">-</span> Community
 Engine:
  Version:          19<span class="token punctuation">.</span>03<span class="token punctuation">.</span>12
  API version:      1<span class="token punctuation">.</span>40 <span class="token punctuation">(</span>minimum version 1<span class="token punctuation">.</span>12<span class="token punctuation">)</span>
  Go version:       go1<span class="token punctuation">.</span>13<span class="token punctuation">.</span>10
  Git commit:       48a66213fe
  Built:            Mon Jun 22 15:49:35 2020
  OS<span class="token operator">/</span>Arch:          linux<span class="token operator">/</span>amd64
  Experimental:     false
 containerd:
  Version:          v1<span class="token punctuation">.</span>2<span class="token punctuation">.</span>13
  GitCommit:        7ad184331fa3e55e52b890ea95e65ba581ae3429
 runc:
  Version:          1<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token operator">-</span>rc10
  GitCommit:        dc9208a3303feef5b3839f4323d9beb36df0a9dd
 docker<span class="token operator">-</span>init:
  Version:          0<span class="token punctuation">.</span>18<span class="token punctuation">.</span>0
  GitCommit:        fec3683
$<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
</ol>
<h2 id="kubeadm-安装"><a href="#kubeadm-安装" class="headerlink" title="kubeadm 安装"></a>kubeadm 安装</h2><h3 id="vagrabt-创建-VM"><a href="#vagrabt-创建-VM" class="headerlink" title="vagrabt 创建 VM"></a>vagrabt 创建 VM</h3><p>分别创建一个 master 节点和两个 node 节点，以下是 vagrant 的 <code>.Vagrantfile</code> 文件：</p>
<pre class="line-numbers language-ruby"><code class="language-ruby"><span class="token comment" spellcheck="true"># -*- mode: ruby -*-</span>
<span class="token comment" spellcheck="true"># vi: set ft=ruby :</span>

<span class="token constant">Vagrant</span><span class="token punctuation">.</span>require_version <span class="token string">">= 1.6.0"</span>

boxes <span class="token operator">=</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
        <span class="token symbol">:name</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"k8s-master"</span><span class="token punctuation">,</span>
        <span class="token symbol">:eth1</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"192.168.205.120"</span><span class="token punctuation">,</span>
        <span class="token symbol">:mem</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"2048"</span><span class="token punctuation">,</span>
        <span class="token symbol">:cpu</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"2"</span><span class="token punctuation">,</span>
        <span class="token symbol">:ssh_port</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"2213"</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
        <span class="token symbol">:name</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"k8s-node1"</span><span class="token punctuation">,</span>
        <span class="token symbol">:eth1</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"192.168.205.11"</span><span class="token punctuation">,</span>
        <span class="token symbol">:mem</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"2048"</span><span class="token punctuation">,</span>
        <span class="token symbol">:cpu</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"1"</span><span class="token punctuation">,</span>
        <span class="token symbol">:ssh_port</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"2214"</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
        <span class="token symbol">:name</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"k8s-node2"</span><span class="token punctuation">,</span>
        <span class="token symbol">:eth1</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"192.168.205.12"</span><span class="token punctuation">,</span>
        <span class="token symbol">:mem</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"2048"</span><span class="token punctuation">,</span>
        <span class="token symbol">:cpu</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"1"</span><span class="token punctuation">,</span>
        <span class="token symbol">:ssh_port</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"2215"</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">]</span>

<span class="token constant">Vagrant</span><span class="token punctuation">.</span><span class="token function">configure</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">do</span> <span class="token operator">|</span>config<span class="token operator">|</span>

  config<span class="token punctuation">.</span>vm<span class="token punctuation">.</span>box <span class="token operator">=</span> <span class="token string">"centos/7"</span>

  boxes<span class="token punctuation">.</span><span class="token keyword">each</span> <span class="token keyword">do</span> <span class="token operator">|</span>opts<span class="token operator">|</span>
      config<span class="token punctuation">.</span>vm<span class="token punctuation">.</span>define opts<span class="token punctuation">[</span><span class="token symbol">:name</span><span class="token punctuation">]</span> <span class="token keyword">do</span> <span class="token operator">|</span>config<span class="token operator">|</span>
        config<span class="token punctuation">.</span>vm<span class="token punctuation">.</span>hostname <span class="token operator">=</span> opts<span class="token punctuation">[</span><span class="token symbol">:name</span><span class="token punctuation">]</span>
        config<span class="token punctuation">.</span>vm<span class="token punctuation">.</span>provider <span class="token string">"vmware_fusion"</span> <span class="token keyword">do</span> <span class="token operator">|</span>v<span class="token operator">|</span>
          v<span class="token punctuation">.</span>vmx<span class="token punctuation">[</span><span class="token string">"memsize"</span><span class="token punctuation">]</span> <span class="token operator">=</span> opts<span class="token punctuation">[</span><span class="token symbol">:mem</span><span class="token punctuation">]</span>
          v<span class="token punctuation">.</span>vmx<span class="token punctuation">[</span><span class="token string">"numvcpus"</span><span class="token punctuation">]</span> <span class="token operator">=</span> opts<span class="token punctuation">[</span><span class="token symbol">:cpu</span><span class="token punctuation">]</span>
        <span class="token keyword">end</span>

        config<span class="token punctuation">.</span>vm<span class="token punctuation">.</span>provider <span class="token string">"virtualbox"</span> <span class="token keyword">do</span> <span class="token operator">|</span>v<span class="token operator">|</span>
          v<span class="token punctuation">.</span>customize <span class="token punctuation">[</span><span class="token string">"modifyvm"</span><span class="token punctuation">,</span> <span class="token symbol">:id</span><span class="token punctuation">,</span> <span class="token string">"--memory"</span><span class="token punctuation">,</span> opts<span class="token punctuation">[</span><span class="token symbol">:mem</span><span class="token punctuation">]</span><span class="token punctuation">]</span>
          v<span class="token punctuation">.</span>customize <span class="token punctuation">[</span><span class="token string">"modifyvm"</span><span class="token punctuation">,</span> <span class="token symbol">:id</span><span class="token punctuation">,</span> <span class="token string">"--cpus"</span><span class="token punctuation">,</span> opts<span class="token punctuation">[</span><span class="token symbol">:cpu</span><span class="token punctuation">]</span><span class="token punctuation">]</span>
        <span class="token keyword">end</span>

        config<span class="token punctuation">.</span>vm<span class="token punctuation">.</span>network <span class="token symbol">:forwarded_port</span><span class="token punctuation">,</span> guest<span class="token punctuation">:</span> <span class="token number">22</span><span class="token punctuation">,</span> host<span class="token punctuation">:</span> opts<span class="token punctuation">[</span><span class="token symbol">:ssh_port</span><span class="token punctuation">]</span>
        config<span class="token punctuation">.</span>vm<span class="token punctuation">.</span>network <span class="token symbol">:private_network</span><span class="token punctuation">,</span> ip<span class="token punctuation">:</span> opts<span class="token punctuation">[</span><span class="token symbol">:eth1</span><span class="token punctuation">]</span>
      <span class="token keyword">end</span>
  <span class="token keyword">end</span>

  config<span class="token punctuation">.</span>vm<span class="token punctuation">.</span>synced_folder <span class="token string">"./labs"</span><span class="token punctuation">,</span> <span class="token string">"/home/vagrant/labs"</span>
  config<span class="token punctuation">.</span>vm<span class="token punctuation">.</span>provision <span class="token string">"shell"</span><span class="token punctuation">,</span> privileged<span class="token punctuation">:</span> <span class="token keyword">true</span><span class="token punctuation">,</span> path<span class="token punctuation">:</span> <span class="token string">"./setup.sh"</span>

<span class="token keyword">end</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><code>.Vagrantfile</code> 中指定的 <code>setup.sh</code> 文件</p>
<pre class="line-numbers language-shell"><code class="language-shell">#/bin/sh

sudo yum install wget -y

sudo mv /etc/yum.repos.d/CentOS-Base.repo /etc/yum.repos.d/CentOS-Base.repo.backup

sudo wget -O /etc/yum.repos.d/CentOS-Base.repo https://mirrors.aliyun.com/repo/Centos-7.repo

sudo yum makecache

# install some tools
sudo yum install -y git vim gcc glibc-static telnet bridge-utils brctl bind-utils

# install docker
curl -fsSL get.docker.com -o get-docker.sh
sh get-docker.sh

# start docker service
# sudo groupadd docker
sudo usermod -aG docker vagrant
sudo systemctl start docker

rm -rf get-docker.sh

sudo su
echo root| passwd root --stdin
sed "/^PasswordAuthentication no/c PasswordAuthentication yes" /etc/ssh/sshd_config > tmp_file
mv tmp_file /etc/ssh/sshd_config
rm -f tmp_file

systemctl restart sshd

sudo mkdir -p /etc/docker
sudo tee /etc/docker/daemon.json <<-'eof' { "registry-mirrors": ["https: 8awf7z4n.mirror.aliyuncs.com"] } eof sudo systemctl daemon-reload restart docker bash -c 'cat <<eof> /etc/yum.repos.d/kubernetes.repo
[kubernetes]
name=Kubernetes
baseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64
enabled=1
gpgcheck=1
repo_gpgcheck=1
gpgkey=https://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg https://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg
EOF'

sudo setenforce 0

sudo yum install -y kubelet kubeadm kubectl

cat <<eof | sudo tee etc sysctl.d k8s.conf net.bridge.bridge-nf-call-ip6tables="1" net.bridge.bridge-nf-call-iptables="1" eof sysctl --system systemctl stop firewalld disable swapoff -a enable docker.service kubelet.service<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></eof></-'eof'></code></pre>
<p>运行 vagrant 创建：</p>
<pre class="line-numbers language-shell"><code class="language-shell">vagrant up<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>运行完成后，分别进入三个 VM，使用以下命令查看是否安装完成</p>
<pre class="line-numbers language-shell"><code class="language-shell">[root@k8s-master ~]# which kubelet
/usr/bin/kubelet
[root@k8s-master ~]# which kubeadm
/usr/bin/kubeadm
[root@k8s-master ~]# which kubectl
/usr/bin/kubectl
[root@k8s-master ~]# docker version
Client: Docker Engine - Community
 Version:           19.03.13
 API version:       1.40
 Go version:        go1.13.15
 Git commit:        4484c46d9d
 Built:             Wed Sep 16 17:03:45 2020
 OS/Arch:           linux/amd64
 Experimental:      false

Server: Docker Engine - Community
 Engine:
  Version:          19.03.13
  API version:      1.40 (minimum version 1.12)
  Go version:       go1.13.15
  Git commit:       4484c46d9d
  Built:            Wed Sep 16 17:02:21 2020
  OS/Arch:          linux/amd64
  Experimental:     false
 containerd:
  Version:          1.3.7
  GitCommit:        8fba4e9a7d01810a393d5d25a3621dc101981175
 runc:
  Version:          1.0.0-rc10
  GitCommit:        dc9208a3303feef5b3839f4323d9beb36df0a9dd
 docker-init:
  Version:          0.18.0
  GitCommit:        fec3683<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="kubeadm-初始化集群"><a href="#kubeadm-初始化集群" class="headerlink" title="kubeadm 初始化集群"></a>kubeadm 初始化集群</h3><p><code>--pod-network-cidr</code> 指定集群创建的 pod 的网段；<code>--apiserver-advertise-addressv</code> 指定集群公告的地址，也就是当前这台主机作为 master 可以被其它节点以及 API 访问到的地址，所以这个地址要选用和其它节点同网段的网络节点的地址；<code>--v=5</code> 指定打印日志的等级；<code>--image-repository</code> 指定拉取镜像的地址，这里指定阿里云的地址，不然默认会拉谷歌的</p>
<pre class="line-numbers language-shell"><code class="language-shell">[root@k8s-master ~]# kubeadm init --pod-network-cidr 172.100.0.0/16 --apiserver-advertise-address 192.168.205.120 --image-repository='registry.cn-hangzhou.aliyuncs.com/google_containers' --v=5
I1023 04:32:50.960205     889 initconfiguration.go:103] detected and using CRI socket: /var/run/dockershim.sock
I1023 04:32:51.080327     889 version.go:183] fetching Kubernetes version from URL: https://dl.k8s.io/release/stable-1.txt
W1023 04:32:52.697343     889 configset.go:348] WARNING: kubeadm cannot validate component configs for API groups [kubelet.config.k8s.io kubeproxy.config.k8s.io]
[init] Using Kubernetes version: v1.19.3
[preflight] Running pre-flight checks
I1023 04:32:52.697935     889 checks.go:577] validating Kubernetes and kubeadm version

... ...

Your Kubernetes control-plane has initialized successfully!

To start using your cluster, you need to run the following as a regular user:

  mkdir -p $HOME/.kube
  sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
  sudo chown $(id -u):$(id -g) $HOME/.kube/config

You should now deploy a pod network to the cluster.
Run "kubectl apply -f [podnetwork].yaml" with one of the options listed at:
  https://kubernetes.io/docs/concepts/cluster-administration/addons/

Then you can join any number of worker nodes by running the following on each as root:

kubeadm join 192.168.205.120:6443 --token eaxpot.07q5bn1h6etqawca \
    --discovery-token-ca-cert-hash sha256:7445ed26891dd725b679b837cd2752563672c12f671a61d23f8f513efd805877<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-shell"><code class="language-shell">[root@k8s-master ~]#   mkdir -p $HOME/.kube
[root@k8s-master ~]#   sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
[root@k8s-master ~]#   sudo chown $(id -u):$(id -g) $HOME/.kube/config
[root@k8s-master ~]#<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>检查 pods</p>
<pre class="line-numbers language-shell"><code class="language-shell">[root@k8s-master ~]# kubectl get pod --all-namespaces
NAMESPACE     NAME                                 READY   STATUS    RESTARTS   AGE
kube-system   coredns-6c76c8bb89-c5dcd             0/1     Pending   0          12m
kube-system   coredns-6c76c8bb89-n5hqc             0/1     Pending   0          12m
kube-system   etcd-k8s-master                      1/1     Running   0          12m
kube-system   kube-apiserver-k8s-master            1/1     Running   0          12m
kube-system   kube-controller-manager-k8s-master   1/1     Running   0          12m
kube-system   kube-proxy-ctz76                     1/1     Running   0          92s
kube-system   kube-proxy-qbjjx                     1/1     Running   0          12m
kube-system   kube-scheduler-k8s-master            1/1     Running   0          12m<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>安装网络插件</p>
<pre class="line-numbers language-shell"><code class="language-shell">kubectl apply -f "https://cloud.weave.works/k8s/net?k8s-version=$(kubectl version | base64 | tr -d '\n')"<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h3 id="加入-node-节点"><a href="#加入-node-节点" class="headerlink" title="加入 node 节点"></a>加入 node 节点</h3><p>在 node 节点上运行以下命令加入集群：</p>
<ul>
<li><p>node1</p>
<pre class="line-numbers language-shell"><code class="language-shell">[root@k8s-node1 ~]# kubeadm join 192.168.205.120:6443 --token eaxpot.07q5bn1h6etqawca \
>     --discovery-token-ca-cert-hash sha256:7445ed26891dd725b679b837cd2752563672c12f671a61d23f8f513efd805877
[preflight] Running pre-flight checks
    [WARNING IsDockerSystemdCheck]: detected "cgroupfs" as the Docker cgroup driver. The recommended driver is "systemd". Please follow the guide at https://kubernetes.io/docs/setup/cri/
[preflight] Reading configuration from the cluster...
[preflight] FYI: You can look at this config file with 'kubectl -n kube-system get cm kubeadm-config -oyaml'
[kubelet-start] Writing kubelet configuration to file "/var/lib/kubelet/config.yaml"
[kubelet-start] Writing kubelet environment file with flags to file "/var/lib/kubelet/kubeadm-flags.env"
[kubelet-start] Starting the kubelet
[kubelet-start] Waiting for the kubelet to perform the TLS Bootstrap...

This node has joined the cluster:
* Certificate signing request was sent to apiserver and a response was received.
* The Kubelet was informed of the new secure connection details.

Run 'kubectl get nodes' on the control-plane to see this node join the cluster.

[root@k8s-node1 ~]#<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>node2</p>
<pre class="line-numbers language-shell"><code class="language-shell">[root@k8s-node2 ~]# kubeadm join 192.168.205.120:6443 --token eaxpot.07q5bn1h6etqawca \
>     --discovery-token-ca-cert-hash sha256:7445ed26891dd725b679b837cd2752563672c12f671a61d23f8f513efd805877
[preflight] Running pre-flight checks
    [WARNING IsDockerSystemdCheck]: detected "cgroupfs" as the Docker cgroup driver. The recommended driver is "systemd". Please follow the guide at https://kubernetes.io/docs/setup/cri/
[preflight] Reading configuration from the cluster...
[preflight] FYI: You can look at this config file with 'kubectl -n kube-system get cm kubeadm-config -oyaml'
[kubelet-start] Writing kubelet configuration to file "/var/lib/kubelet/config.yaml"
[kubelet-start] Writing kubelet environment file with flags to file "/var/lib/kubelet/kubeadm-flags.env"
[kubelet-start] Starting the kubelet
[kubelet-start] Waiting for the kubelet to perform the TLS Bootstrap...

This node has joined the cluster:
* Certificate signing request was sent to apiserver and a response was received.
* The Kubelet was informed of the new secure connection details.

Run 'kubectl get nodes' on the control-plane to see this node join the cluster.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
</ul>
<p>回到 master 节点查看集群节点状态：</p>
<pre class="line-numbers language-shell"><code class="language-shell">[root@k8s-master ~]# kubectl get nodes
NAME         STATUS     ROLES    AGE     VERSION
k8s-master   Ready      master   16m     v1.19.3
k8s-node1    Ready      <none>   5m10s   v1.19.3
k8s-node2    NotReady   <none>   20s     v1.19.3<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></none></none></code></pre>
<h2 id="其它参考安装"><a href="#其它参考安装" class="headerlink" title="其它参考安装"></a><a href="https://gist.github.com/islishude/231659cec0305ace090b933ce851994a" target="_blank" rel="noopener">其它参考安装</a></h2><blockquote>
<p>注意以下命令，需要切换到 root 后运行</p>
</blockquote>
<h3 id="安装-docker"><a href="#安装-docker" class="headerlink" title="安装 docker"></a>安装 docker</h3><p>首先确定已经安装完成 docker，如果没有安装可以使用以下脚本快速安装并配置：</p>
<pre class="line-numbers language-shell"><code class="language-shell">curl -fsSL https://get.docker.com | sudo sh -s -- --mirror Aliyun
sudo usermod -aG docker $USER
sudo mkdir -p /etc/docker
sudo tee /etc/docker/daemon.json <<-'eof' { "exec-opts": ["native.cgroupdriver="systemd"]," "log-driver": "json-file", "log-opts": "max-size": "100m" }, "storage-driver": "overlay2", "registry-mirrors": ["https: t9ab0rkd.mirror.aliyuncs.com"] } eof sudo systemctl daemon-reload restart docker<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></-'eof'></code></pre>
<h3 id="kubeadm"><a href="#kubeadm" class="headerlink" title="kubeadm"></a>kubeadm</h3><h4 id="安装-k8s-套件"><a href="#安装-k8s-套件" class="headerlink" title="安装 k8s 套件"></a>安装 k8s 套件</h4><pre class="line-numbers language-shell"><code class="language-shell"># 添加并信任APT证书
curl https://mirrors.aliyun.com/kubernetes/apt/doc/apt-key.gpg | sudo apt-key add -

# 添加源地址
add-apt-repository "deb https://mirrors.aliyun.com/kubernetes/apt/ kubernetes-xenial main"

# 更新源并安装最新版 kubenetes
sudo apt update && apt install -y kubelet kubeadm kubectl

# 添加 completion，最好放入 .bashrc 中
source <(kubectl completion bash) source <(kubeadm bash)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></(kubectl></code></pre>
<h4 id="关闭-swap"><a href="#关闭-swap" class="headerlink" title="关闭 swap"></a>关闭 swap</h4><p>为了性能考虑，k8s 需要关闭 swap 功能，然后重启主机。</p>
<p>在 <code>/etc/fstab</code> 中找到带有 <code>swap</code> 的那一行，注释掉。</p>
<pre class="line-numbers language-shell"><code class="language-shell">$ vim /etc/fstab
# UUID=9224d95f-cd87-4b56-b249-3dc7de4491d3 none            swap    sw              0       0<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<h4 id="启动-master-节点："><a href="#启动-master-节点：" class="headerlink" title="启动 master 节点："></a>启动 master 节点：</h4><pre class="line-numbers language-shell"><code class="language-shell">kubeadm init --image-repository='registry.cn-hangzhou.aliyuncs.com/google_containers'<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p><code>--image-repository</code> 指定控制平面容器镜像地址，这里使用aliyun镜像，而不是默认的 k8s.gcr.io，这样就能避免下载失败。</p>
<p>如果 init 失败，检查是否关闭 swap、 用户是否为 root 以及是否下载好核心组件镜像（可能得网络的问题）、是否为至少 2G 内存，然后运行 <code>kubeadm reset</code> 接着再 <code>kubeadm init</code>。</p>
<h4 id="配置读取路径"><a href="#配置读取路径" class="headerlink" title="配置读取路径"></a>配置读取路径</h4><pre class="line-numbers language-shell"><code class="language-shell"># append to .bashrc
export KUBECONFIG=/etc/kubernetes/admin.conf<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<h4 id="安装网络插件"><a href="#安装网络插件" class="headerlink" title="安装网络插件"></a>安装网络插件</h4><pre class="line-numbers language-shell"><code class="language-shell">kubectl apply -f "https://cloud.weave.works/k8s/net?k8s-version=$(kubectl version | base64 | tr -d '\n')"<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h4 id="加入-worker"><a href="#加入-worker" class="headerlink" title="加入 worker"></a>加入 worker</h4><p>worker 节点加入 master，使用 kubeadm init 最后提示的命令在 worker 上运行</p>
<pre class="line-numbers language-shell"><code class="language-shell">kubeadm join 192.168.199.117:6443 --token y8l6qv.oj2hxua9szguei23 \
--discovery-token-ca-cert-hash sha256:bae71d8fb4a26c5f29a6df2db037e08e581fcb344ff85089a603e3eeb9d6d26f<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>其中 <code>--token</code> 是临时的生成，可以通过下面命令获取</p>
<pre class="line-numbers language-shell"><code class="language-shell">$ kubeadm token list
TOKEN                     TTL       EXPIRES                     USAGES                   DESCRIPTION                                                EXTRA GROUPS
y8l6qv.oj2hxua9szguei23   23h      2019-09-09T12:04:27+08:00   authentication,signing   The default bootstrap token generated by 'kubeadm init'.   system:bootstrappers:kubeadm:default-node-token<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>而 <code>--discovery-token-ca-cert-hash</code> 指的是 CA 证书的哈希值，那么可以使用这种方式获取：</p>
<pre class="line-numbers language-shell"><code class="language-shell">$ openssl x509 -pubkey -in /etc/kubernetes/pki/ca.crt | openssl rsa -pubin -outform der 2>/dev/null | sha256sum | awk '{print $1}'
3e77f845edf944d76234a6d78dde3e5bae3e50261362b1d8cc8d025ac97136b0<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<h4 id="查看-nodes"><a href="#查看-nodes" class="headerlink" title="查看 nodes"></a>查看 nodes</h4><p>在 master 节点上运行</p>
<pre class="line-numbers language-shell"><code class="language-shell">kubectl get nodes<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h3 id="minikube"><a href="#minikube" class="headerlink" title="minikube"></a>minikube</h3><h4 id="国内源"><a href="#国内源" class="headerlink" title="国内源"></a>国内源</h4><p>在<a href="https://minikube.sigs.k8s.io/docs/start/" target="_blank" rel="noopener">minikube</a>文档页面，选择操作系统，然后下载 minikube，注意版本号。</p>
<p>在<a href="https://kubernetes.io/docs/tasks/tools/install-kubectl/" target="_blank" rel="noopener">k8s-kubectl</a>页面下载 kubectl 并放在$PATH下，注意版本号。</p>
<p>下载安装 virtualbox。</p>
<p>启动命令：</p>
<pre><code>minikube start \
--vm-driver=virtualbox \
--image-mirror-country=cn \
--registry-mirror=&#39;https://t9ab0rkd.mirror.aliyuncs.com&#39; \
--image-repository=&#39;registry.cn-hangzhou.aliyuncs.com/google_containers&#39; \
--iso-url=&#39;https://kubernetes.oss-cn-hangzhou.aliyuncs.com/minikube/iso/minikube-v1.5.1.iso&#39;</code></pre><p>–image-mirror-country cn 将缺省利用 registry.cn-hangzhou.aliyuncs.com/google_containers 作为安装Kubernetes的容器镜像仓库， –iso-url= 利用阿里云的镜像地址下载相应的 .iso 文件 –cpus=2: 为minikube虚拟机分配CPU核数 –memory=2000mb: 为minikube虚拟机分配内存数 –kubernetes-version= : minikube 虚拟机将使用的 kubernetes 版本</p>
<h4 id="官方源"><a href="#官方源" class="headerlink" title="官方源"></a>官方源</h4><pre><code># k8s
curl -s https://packages.cloud.google.com/apt/doc/apt-key.gpg | sudo apt-key add
apt-add-repository &quot;deb http://apt.kubernetes.io/ kubernetes-xenial main&quot;

# docker
curl -fsSL https://download.docker.com/linux/ubuntu/gpg | apt-key add -
add-apt-repository &quot;deb [arch=amd64] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable&quot;

# apt安装
apt-get update &amp;&amp; apt-get install docker-ce kubeadm

cat &gt; /etc/docker/daemon.json &lt;&lt;EOF
{
  &quot;exec-opts&quot;: [&quot;native.cgroupdriver=systemd&quot;],
  &quot;log-driver&quot;: &quot;json-file&quot;,
  &quot;log-opts&quot;: {
    &quot;max-size&quot;: &quot;100m&quot;
  },
  &quot;storage-driver&quot;: &quot;overlay2&quot;
}
EOF

mkdir -p /etc/systemd/system/docker.service.d

systemctl daemon-reload
systemctl restart docker</code></pre><h3 id="其它阅读参考"><a href="#其它阅读参考" class="headerlink" title="其它阅读参考"></a>其它阅读参考</h3><p><a href="https://juejin.im/post/6844903668269973511" target="_blank" rel="noopener">https://juejin.im/post/6844903668269973511</a></p>
<p><a href="https://cloud.tencent.com/developer/article/1525487" target="_blank" rel="noopener">https://cloud.tencent.com/developer/article/1525487</a></p>
<h2 id="配置-kubectl-操作多个-k8s-集群"><a href="#配置-kubectl-操作多个-k8s-集群" class="headerlink" title="配置 kubectl 操作多个 k8s 集群"></a>配置 kubectl 操作多个 k8s 集群</h2><p>参考 <a href="https://kubernetes.io/docs/tasks/access-application-cluster/configure-access-multiple-clusters/" target="_blank" rel="noopener">官方说明</a> 。</p>
<p>可以看到 kubectl 主要通过类似以下格式的文件读取 k8s 集群的联系信息的：</p>
<pre class="line-numbers language-yaml"><code class="language-yaml"><span class="token key atrule">contexts</span><span class="token punctuation">:</span>
<span class="token punctuation">-</span> <span class="token key atrule">context</span><span class="token punctuation">:</span>
    <span class="token key atrule">cluster</span><span class="token punctuation">:</span> development
    <span class="token key atrule">namespace</span><span class="token punctuation">:</span> frontend
    <span class="token key atrule">user</span><span class="token punctuation">:</span> developer
  <span class="token key atrule">name</span><span class="token punctuation">:</span> dev<span class="token punctuation">-</span>frontend
<span class="token punctuation">-</span> <span class="token key atrule">context</span><span class="token punctuation">:</span>
    <span class="token key atrule">cluster</span><span class="token punctuation">:</span> development
    <span class="token key atrule">namespace</span><span class="token punctuation">:</span> ramp
    <span class="token key atrule">user</span><span class="token punctuation">:</span> developer
  <span class="token key atrule">name</span><span class="token punctuation">:</span> dev<span class="token punctuation">-</span>ramp<span class="token punctuation">-</span>up
<span class="token punctuation">-</span> <span class="token key atrule">context</span><span class="token punctuation">:</span>
    <span class="token key atrule">cluster</span><span class="token punctuation">:</span> development
    <span class="token key atrule">namespace</span><span class="token punctuation">:</span> storage
    <span class="token key atrule">user</span><span class="token punctuation">:</span> developer
  <span class="token key atrule">name</span><span class="token punctuation">:</span> dev<span class="token punctuation">-</span>storage
<span class="token punctuation">-</span> <span class="token key atrule">context</span><span class="token punctuation">:</span>
    <span class="token key atrule">cluster</span><span class="token punctuation">:</span> scratch
    <span class="token key atrule">namespace</span><span class="token punctuation">:</span> default
    <span class="token key atrule">user</span><span class="token punctuation">:</span> experimenter
  <span class="token key atrule">name</span><span class="token punctuation">:</span> exp<span class="token punctuation">-</span>scratch<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li><p>使用 minikube 和 kubeadm 安装集群之后，分别会在 minikube 所在主机以及 kubeadm 所在主机的当前用户 <code>$HOME</code> 下创建 <code>.kube/config</code> 文件，这个就是默认创建给 kubectl 读取的文件，里面包含了集群的连接信息。也就是说 kubectl 默认是会读取这个路径文件的</p>
</li>
<li><p>另外我们可以通过指定环境变量 <code>KUBECONFIG</code> 来修改它的默认行为，将集群配置文件所在目录指定给这个环境变量，如果是多个配置文件，在 linux 和 macos 下用冒号隔开，在 windows 下用分号隔开。</p>
</li>
<li><p>同时还可以通过 <code>kubectl config</code> 命令设置的方式生成该配置文件。</p>
</li>
</ul>
<p>在经过以上步骤使得 kubectl 可以读取多个集群信息后，通过 <code>kubectl config use-context &lt;context-name&gt;</code> 即可在多个集群的不同上下文之间进行上下文切换。</p>
<h1 id="Node"><a href="#Node" class="headerlink" title="Node"></a>Node</h1><p>每个 cluster 下面有多个 context ，一个 context 可能会涉及多个 Node，一个 Node 就是一个物理主机或者虚机。kubectl 切换到一个 context 之后，可以查看它涉及的节点：</p>
<pre class="line-numbers language-shell"><code class="language-shell">[root@k8s-master ~]# kubectl get node
NAME         STATUS     ROLES    AGE   VERSION
k8s-master   Ready      master   9h    v1.19.3
k8s-node1    NotReady   <none>   9h    v1.19.3
k8s-node2    NotReady   <none>   9h    v1.19.3
[root@k8s-master ~]# kubectl get node -o wide
NAME         STATUS     ROLES    AGE   VERSION   INTERNAL-IP   EXTERNAL-IP   OS-IMAGE                KERNEL-VERSION           CONTAINER-RUNTIME
k8s-master   Ready      master   20h   v1.19.3   10.0.2.15     <none>        CentOS Linux 7 (Core)   3.10.0-1127.el7.x86_64   docker://19.3.13
k8s-node1    NotReady   <none>   20h   v1.19.3   10.0.2.15     <none>        CentOS Linux 7 (Core)   3.10.0-1127.el7.x86_64   docker://19.3.13
k8s-node2    NotReady   <none>   20h   v1.19.3   10.0.2.15     <none>        CentOS Linux 7 (Core)   3.10.0-1127.el7.x86_64   docker://19.3.13<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></none></none></none></none></none></none></none></code></pre>
<p>通过 <code>kubectl get node -o yaml</code> 以 yaml 格式输出更多信息（也支持 json 格式输出这些信息，<code>-o json</code>）：</p>
<pre class="line-numbers language-shell"><code class="language-shell">[root@k8s-master ~]# kubectl get node -o yaml
apiVersion: v1
items:
- apiVersion: v1
  kind: Node
  metadata:
    annotations:
      kubeadm.alpha.kubernetes.io/cri-socket: /var/run/dockershim.sock
      node.alpha.kubernetes.io/ttl: "0"
      volumes.kubernetes.io/controller-managed-attach-detach: "true"
    creationTimestamp: "2020-10-23T04:33:49Z"
    labels:
      beta.kubernetes.io/arch: amd64
      beta.kubernetes.io/os: linux
      kubernetes.io/arch: amd64
      kubernetes.io/hostname: k8s-master
      kubernetes.io/os: linux
      node-role.kubernetes.io/master: ""
    managedFields:
    - apiVersion: v1
      fieldsType: FieldsV1
      fieldsV1:
        f:metadata:
          f:annotations:
            f:kubeadm.alpha.kubernetes.io/cri-socket: {}
          f:labels:
            f:node-role.kubernetes.io/master: {}
      manager: kubeadm
      operation: Update
      time: "2020-10-23T04:33:52Z"
    - apiVersion: v1
      fieldsType: FieldsV1
      fieldsV1:
        f:metadata:
          f:annotations:
            f:node.alpha.kubernetes.io/ttl: {}
          f:labels:
            f:beta.kubernetes.io/arch: {}
            f:beta.kubernetes.io/os: {}
        f:spec:
          f:podCIDR: {}
          f:podCIDRs:
            .: {}
            v:"172.100.0.0/24": {}
          f:taints: {}
      manager: kube-controller-manager
      operation: Update
      time: "2020-10-23T04:48:39Z"
    - apiVersion: v1
      fieldsType: FieldsV1
      fieldsV1:
        f:status:
          f:conditions:
            k:{"type":"NetworkUnavailable"}:
              .: {}
              f:lastHeartbeatTime: {}
              f:lastTransitionTime: {}
              f:message: {}
              f:reason: {}
              f:status: {}
              f:type: {}
      manager: kube-utils
      operation: Update
      time: "2020-10-23T14:12:48Z"
    - apiVersion: v1
      fieldsType: FieldsV1
      fieldsV1:
        f:metadata:
          f:annotations:
            .: {}
            f:volumes.kubernetes.io/controller-managed-attach-detach: {}
          f:labels:
            .: {}
            f:kubernetes.io/arch: {}
            f:kubernetes.io/hostname: {}
            f:kubernetes.io/os: {}
        f:status:
          f:addresses:
            .: {}
            k:{"type":"Hostname"}:
              .: {}
              f:address: {}
              f:type: {}
            k:{"type":"InternalIP"}:
              .: {}
              f:address: {}
              f:type: {}
          f:allocatable:
            .: {}
            f:cpu: {}
            f:ephemeral-storage: {}
            f:hugepages-2Mi: {}
            f:memory: {}
            f:pods: {}
          f:capacity:
            .: {}
            f:cpu: {}
            f:ephemeral-storage: {}
... ...<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>通过 <code>kubectl describe node &lt;node-name&gt;</code> 查看详细信息：</p>
<pre class="line-numbers language-shell"><code class="language-shell">[root@k8s-master ~]# kubectl describe node k8s-master
Name:               k8s-master
Roles:              master
Labels:             beta.kubernetes.io/arch=amd64
                    beta.kubernetes.io/os=linux
                    kubernetes.io/arch=amd64
                    kubernetes.io/hostname=k8s-master
                    kubernetes.io/os=linux
                    node-role.kubernetes.io/master=
Annotations:        kubeadm.alpha.kubernetes.io/cri-socket: /var/run/dockershim.sock
                    node.alpha.kubernetes.io/ttl: 0
                    volumes.kubernetes.io/controller-managed-attach-detach: true
CreationTimestamp:  Fri, 23 Oct 2020 04:33:49 +0000
Taints:             node-role.kubernetes.io/master:NoSchedule
Unschedulable:      false
Lease:
  HolderIdentity:  k8s-master
  AcquireTime:     <unset>
  RenewTime:       Sat, 24 Oct 2020 00:58:28 +0000
Conditions:
  Type                 Status  LastHeartbeatTime                 LastTransitionTime                Reason                       Message
  ----                 ------  -----------------                 ------------------                ------                       -------
  NetworkUnavailable   False   Fri, 23 Oct 2020 14:12:48 +0000   Fri, 23 Oct 2020 14:12:48 +0000   WeaveIsUp                    Weave pod has set this
  MemoryPressure       False   Sat, 24 Oct 2020 00:55:03 +0000   Fri, 23 Oct 2020 04:33:40 +0000   KubeletHasSufficientMemory   kubelet has sufficient memory available
  DiskPressure         False   Sat, 24 Oct 2020 00:55:03 +0000   Fri, 23 Oct 2020 04:33:40 +0000   KubeletHasNoDiskPressure     kubelet has no disk pressure
  PIDPressure          False   Sat, 24 Oct 2020 00:55:03 +0000   Fri, 23 Oct 2020 04:33:40 +0000   KubeletHasSufficientPID      kubelet has sufficient PID available
  Ready                True    Sat, 24 Oct 2020 00:55:03 +0000   Fri, 23 Oct 2020 04:48:39 +0000   KubeletReady                 kubelet is posting ready status
Addresses:
  InternalIP:  10.0.2.15
  Hostname:    k8s-master
Capacity:
  cpu:                2
  ephemeral-storage:  41921540Ki
  hugepages-2Mi:      0
  memory:             1881936Ki
  pods:               110
Allocatable:
  cpu:                2
  ephemeral-storage:  38634891201
  hugepages-2Mi:      0
  memory:             1779536Ki
  pods:               110
System Info:
  Machine ID:                 db0b07db41e673489398574c36ad7aa0
  System UUID:                DB0B07DB-41E6-7348-9398-574C36AD7AA0
  Boot ID:                    814e4cf8-5526-42fd-ae20-1afe15ee387f
  Kernel Version:             3.10.0-1127.el7.x86_64
  OS Image:                   CentOS Linux 7 (Core)
  Operating System:           linux
  Architecture:               amd64
  Container Runtime Version:  docker://19.3.13
  Kubelet Version:            v1.19.3
  Kube-Proxy Version:         v1.19.3
PodCIDR:                      172.100.0.0/24
PodCIDRs:                     172.100.0.0/24
Non-terminated Pods:          (8 in total)
  Namespace                   Name                                  CPU Requests  CPU Limits  Memory Requests  Memory Limits  AGE
  ---------                   ----                                  ------------  ----------  ---------------  -------------  ---
  kube-system                 coredns-6c76c8bb89-c5dcd              100m (5%)     0 (0%)      70Mi (4%)        170Mi (9%)     20h
  kube-system                 coredns-6c76c8bb89-n5hqc              100m (5%)     0 (0%)      70Mi (4%)        170Mi (9%)     20h
  kube-system                 etcd-k8s-master                       0 (0%)        0 (0%)      0 (0%)           0 (0%)         20h
  kube-system                 kube-apiserver-k8s-master             250m (12%)    0 (0%)      0 (0%)           0 (0%)         20h
  kube-system                 kube-controller-manager-k8s-master    200m (10%)    0 (0%)      0 (0%)           0 (0%)         20h
  kube-system                 kube-proxy-qbjjx                      0 (0%)        0 (0%)      0 (0%)           0 (0%)         20h
  kube-system                 kube-scheduler-k8s-master             100m (5%)     0 (0%)      0 (0%)           0 (0%)         20h
  kube-system                 weave-net-k777j                       100m (5%)     0 (0%)      200Mi (11%)      0 (0%)         20h
Allocated resources:
  (Total limits may be over 100 percent, i.e., overcommitted.)
  Resource           Requests     Limits
  --------           --------     ------
  cpu                850m (42%)   0 (0%)
  memory             340Mi (19%)  340Mi (19%)
  ephemeral-storage  0 (0%)       0 (0%)
  hugepages-2Mi      0 (0%)       0 (0%)
Events:              <none>[root@k8s-master ~]# kubectl describe node k8s-master
Name:               k8s-master
Roles:              master
Labels:             beta.kubernetes.io/arch=amd64
                    beta.kubernetes.io/os=linux
                    kubernetes.io/arch=amd64
                    kubernetes.io/hostname=k8s-master
                    kubernetes.io/os=linux
                    node-role.kubernetes.io/master=
Annotations:        kubeadm.alpha.kubernetes.io/cri-socket: /var/run/dockershim.sock
                    node.alpha.kubernetes.io/ttl: 0
                    volumes.kubernetes.io/controller-managed-attach-detach: true
CreationTimestamp:  Fri, 23 Oct 2020 04:33:49 +0000
Taints:             node-role.kubernetes.io/master:NoSchedule
Unschedulable:      false
Lease:
  HolderIdentity:  k8s-master
  AcquireTime:     <unset>
  RenewTime:       Sat, 24 Oct 2020 00:58:28 +0000
Conditions:
  Type                 Status  LastHeartbeatTime                 LastTransitionTime                Reason                       Message
  ----                 ------  -----------------                 ------------------                ------                       -------
  NetworkUnavailable   False   Fri, 23 Oct 2020 14:12:48 +0000   Fri, 23 Oct 2020 14:12:48 +0000   WeaveIsUp                    Weave pod has set this
  MemoryPressure       False   Sat, 24 Oct 2020 00:55:03 +0000   Fri, 23 Oct 2020 04:33:40 +0000   KubeletHasSufficientMemory   kubelet has sufficient memory available
  DiskPressure         False   Sat, 24 Oct 2020 00:55:03 +0000   Fri, 23 Oct 2020 04:33:40 +0000   KubeletHasNoDiskPressure     kubelet has no disk pressure
  PIDPressure          False   Sat, 24 Oct 2020 00:55:03 +0000   Fri, 23 Oct 2020 04:33:40 +0000   KubeletHasSufficientPID      kubelet has sufficient PID available
  Ready                True    Sat, 24 Oct 2020 00:55:03 +0000   Fri, 23 Oct 2020 04:48:39 +0000   KubeletReady                 kubelet is posting ready status
Addresses:
  InternalIP:  10.0.2.15
  Hostname:    k8s-master
Capacity:
  cpu:                2
  ephemeral-storage:  41921540Ki
  hugepages-2Mi:      0
  memory:             1881936Ki
  pods:               110
Allocatable:
  cpu:                2
  ephemeral-storage:  38634891201
  hugepages-2Mi:      0
  memory:             1779536Ki
  pods:               110
System Info:
  Machine ID:                 db0b07db41e673489398574c36ad7aa0
  System UUID:                DB0B07DB-41E6-7348-9398-574C36AD7AA0
  Boot ID:                    814e4cf8-5526-42fd-ae20-1afe15ee387f
  Kernel Version:             3.10.0-1127.el7.x86_64
  OS Image:                   CentOS Linux 7 (Core)
  Operating System:           linux
  Architecture:               amd64
  Container Runtime Version:  docker://19.3.13
  Kubelet Version:            v1.19.3
  Kube-Proxy Version:         v1.19.3
PodCIDR:                      172.100.0.0/24
PodCIDRs:                     172.100.0.0/24
Non-terminated Pods:          (8 in total)
  Namespace                   Name                                  CPU Requests  CPU Limits  Memory Requests  Memory Limits  AGE
  ---------                   ----                                  ------------  ----------  ---------------  -------------  ---
  kube-system                 coredns-6c76c8bb89-c5dcd              100m (5%)     0 (0%)      70Mi (4%)        170Mi (9%)     20h
  kube-system                 coredns-6c76c8bb89-n5hqc              100m (5%)     0 (0%)      70Mi (4%)        170Mi (9%)     20h
  kube-system                 etcd-k8s-master                       0 (0%)        0 (0%)      0 (0%)           0 (0%)         20h
  kube-system                 kube-apiserver-k8s-master             250m (12%)    0 (0%)      0 (0%)           0 (0%)         20h
  kube-system                 kube-controller-manager-k8s-master    200m (10%)    0 (0%)      0 (0%)           0 (0%)         20h
  kube-system                 kube-proxy-qbjjx                      0 (0%)        0 (0%)      0 (0%)           0 (0%)         20h
  kube-system                 kube-scheduler-k8s-master             100m (5%)     0 (0%)      0 (0%)           0 (0%)         20h
  kube-system                 weave-net-k777j                       100m (5%)     0 (0%)      200Mi (11%)      0 (0%)         20h
Allocated resources:
  (Total limits may be over 100 percent, i.e., overcommitted.)
  Resource           Requests     Limits
  --------           --------     ------
  cpu                850m (42%)   0 (0%)
  memory             340Mi (19%)  340Mi (19%)
  ephemeral-storage  0 (0%)       0 (0%)
  hugepages-2Mi      0 (0%)       0 (0%)
Events:              <none><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></none></unset></none></unset></code></pre>
<h3 id="Labels"><a href="#Labels" class="headerlink" title="Labels"></a>Labels</h3><p>在上面的 <code>describe</code> 命令中可以看到 node 的 Labels 属性：</p>
<pre><code>Labels:             beta.kubernetes.io/arch=amd64
                    beta.kubernetes.io/os=linux
                    kubernetes.io/arch=amd64
                    kubernetes.io/hostname=k8s-master
                    kubernetes.io/os=linux
                    node-role.kubernetes.io/master=</code></pre><p>Labels 以键值对的形式存在，可以利用这些 Labels 做过滤条件，<code>kubectl get node --show-labels</code> 可以获取 lables</p>
<pre class="line-numbers language-shell"><code class="language-shell">[root@k8s-master ~]# kubectl get node --show-labels
NAME         STATUS     ROLES    AGE   VERSION   LABELS
k8s-master   Ready      master   20h   v1.19.3   beta.kubernetes.io/arch=amd64,beta.kubernetes.io/os=linux,kubernetes.io/arch=amd64,kubernetes.io/hostname=k8s-master,kubernetes.io/os=linux,node-role.kubernetes.io/master=
k8s-node1    NotReady   <none>   20h   v1.19.3   beta.kubernetes.io/arch=amd64,beta.kubernetes.io/os=linux,kubernetes.io/arch=amd64,kubernetes.io/hostname=k8s-node1,kubernetes.io/os=linux
k8s-node2    NotReady   <none>   20h   v1.19.3   beta.kubernetes.io/arch=amd64,beta.kubernetes.io/os=linux,kubernetes.io/arch=amd64,kubernetes.io/hostname=k8s-node2,kubernetes.io/os=linux<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></none></none></code></pre>
<p>添加 label、删除 label</p>
<pre class="line-numbers language-shell"><code class="language-shell">[root@k8s-master ~]# kubectl label node k8s-master
.bash_history    .bash_logout     .bash_profile    .bashrc          .cshrc           .kube/           .pki/            .tcshrc          .viminfo         anaconda-ks.cfg  original-ks.cfg
[root@k8s-master ~]# kubectl label node k8s-master env=test
node/k8s-master labeled
[root@k8s-master ~]# kubectl get node --show-labels
NAME         STATUS     ROLES    AGE   VERSION   LABELS
k8s-master   Ready      master   20h   v1.19.3   beta.kubernetes.io/arch=amd64,beta.kubernetes.io/os=linux,env=test,kubernetes.io/arch=amd64,kubernetes.io/hostname=k8s-master,kubernetes.io/os=linux,node-role.kubernetes.io/master=
k8s-node1    NotReady   <none>   20h   v1.19.3   beta.kubernetes.io/arch=amd64,beta.kubernetes.io/os=linux,kubernetes.io/arch=amd64,kubernetes.io/hostname=k8s-node1,kubernetes.io/os=linux
k8s-node2    NotReady   <none>   20h   v1.19.3   beta.kubernetes.io/arch=amd64,beta.kubernetes.io/os=linux,kubernetes.io/arch=amd64,kubernetes.io/hostname=k8s-node2,kubernetes.io/os=linux
[root@k8s-master ~]# kubectl label node k8s-master env-
node/k8s-master labeled
[root@k8s-master ~]# kubectl get node --show-labels
NAME         STATUS     ROLES    AGE   VERSION   LABELS
k8s-master   Ready      master   20h   v1.19.3   beta.kubernetes.io/arch=amd64,beta.kubernetes.io/os=linux,kubernetes.io/arch=amd64,kubernetes.io/hostname=k8s-master,kubernetes.io/os=linux,node-role.kubernetes.io/master=
k8s-node1    NotReady   <none>   20h   v1.19.3   beta.kubernetes.io/arch=amd64,beta.kubernetes.io/os=linux,kubernetes.io/arch=amd64,kubernetes.io/hostname=k8s-node1,kubernetes.io/os=linux
k8s-node2    NotReady   <none>   20h   v1.19.3   beta.kubernetes.io/arch=amd64,beta.kubernetes.io/os=linux,kubernetes.io/arch=amd64,kubernetes.io/hostname=k8s-node2,kubernetes.io/os=linux
[root@k8s-master ~]#<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></none></none></none></none></code></pre>
<h3 id="node-role"><a href="#node-role" class="headerlink" title="node-role"></a>node-role</h3><p>ROLES 是一个特殊的 label “node-role.kubernetes.io”。</p>
<pre class="line-numbers language-shell"><code class="language-shell">[root@k8s-master ~]# kubectl get node --show-labels
NAME         STATUS     ROLES    AGE   VERSION   LABELS
k8s-master   Ready      master   20h   v1.19.3   beta.kubernetes.io/arch=amd64,beta.kubernetes.io/os=linux,kubernetes.io/arch=amd64,kubernetes.io/hostname=k8s-master,kubernetes.io/os=linux,node-role.kubernetes.io/master=
k8s-node1    NotReady   <none>   20h   v1.19.3   beta.kubernetes.io/arch=amd64,beta.kubernetes.io/os=linux,kubernetes.io/arch=amd64,kubernetes.io/hostname=k8s-node1,kubernetes.io/os=linux
k8s-node2    NotReady   <none>   20h   v1.19.3   beta.kubernetes.io/arch=amd64,beta.kubernetes.io/os=linux,kubernetes.io/arch=amd64,kubernetes.io/hostname=k8s-node2,kubernetes.io/os=linux
[root@k8s-master ~]# kubectl label node k8s-node1 node-role.kubernetes.io/worker=
node/k8s-node1 labeled
[root@k8s-master ~]# kubectl label node k8s-node2 node-role.kubernetes.io/worker=
node/k8s-node2 labeled
[root@k8s-master ~]# kubectl get node
NAME         STATUS     ROLES    AGE   VERSION
k8s-master   Ready      master   20h   v1.19.3
k8s-node1    NotReady   worker   20h   v1.19.3
k8s-node2    NotReady   worker   20h   v1.19.3<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></none></none></code></pre>
<h1 id="调度的最小单位：Pod"><a href="#调度的最小单位：Pod" class="headerlink" title="调度的最小单位：Pod"></a>调度的最小单位：Pod</h1><p>一个 Pod 里面一个或者多个 Container，一个 Pod 只有一个 namespace，所有 Container 共享这个 namespace 。</p>
<p><img src="https://cdn.jsdelivr.net/gh/JohnZhongg/blog_images/image/20201221203203.png" alt="image-20201022191526685"></p>
<h3 id="创建-pod"><a href="#创建-pod" class="headerlink" title="创建 pod"></a>创建 pod</h3><p>下面是一个 k8s 格式的 yml 文件，通过这个文件可以创建一个资源</p>
<pre class="line-numbers language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod <span class="token comment" spellcheck="true"># 资源类型是 pod</span>
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">containers</span><span class="token punctuation">:</span> <span class="token comment" spellcheck="true"># 可以包含多个容器</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx <span class="token comment" spellcheck="true"># 命名</span>
    <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx <span class="token comment" spellcheck="true"># 镜像</span>
    <span class="token key atrule">ports</span><span class="token punctuation">:</span> <span class="token comment" spellcheck="true"># 容器暴露的端口</span>
    <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">80</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p> 使用 <code>kubectl create</code> 命令创建资源，根据 <code>-f</code> 指定的文件里面的指定资源类型按需创建，使用 <code>kubectl get pods</code> 命令查看 pods 的状态，显示正在创建中：</p>
<pre class="line-numbers language-powershell"><code class="language-powershell">D:\docker\docker\chapter9\labs\pod<span class="token operator">-</span>basic>kubectl create <span class="token operator">-</span>f pod_nginx<span class="token punctuation">.</span>yml
pod<span class="token operator">/</span>nginx created

D:\docker\docker\chapter9\labs\pod<span class="token operator">-</span>basic>kubectl get pods
NAME    READY   STATUS              RESTARTS   AGE
nginx   0<span class="token operator">/</span>1     ContainerCreating   0          13s<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>过一会儿，创建完成</p>
<pre class="line-numbers language-powershell"><code class="language-powershell">D:\docker\docker\chapter9\labs\pod<span class="token operator">-</span>basic>kubectl get pods
NAME    READY   STATUS    RESTARTS   AGE
nginx   1<span class="token operator">/</span>1     Running   0          10m<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>查看更详细的信息，可以看到名为 nginx 的 pod 的 ip 地址 “172.17.0.2” 和所在的主机节点 “minikube”</p>
<pre class="line-numbers language-powershell"><code class="language-powershell">D:\docker\docker\chapter9\labs\pod<span class="token operator">-</span>basic>kubectl get pods <span class="token operator">-</span>o wide
NAME    READY   STATUS    RESTARTS   AGE   IP           NODE       NOMINATED NODE   READINESS GATES
nginx   1<span class="token operator">/</span>1     Running   0          12m   172<span class="token punctuation">.</span>17<span class="token punctuation">.</span>0<span class="token punctuation">.</span>2   minikube   &lt;none>           &lt;none><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<h3 id="进入容器的两种方式"><a href="#进入容器的两种方式" class="headerlink" title="进入容器的两种方式"></a>进入容器的两种方式</h3><ul>
<li><p><code>minikube ssh</code> 进入 minikube 主机进行操作：</p>
<pre class="line-numbers language-shell"><code class="language-shell">D:\docker\docker\chapter9\labs\pod-basic>minikube ssh
                         _             _
            _         _ ( )           ( )
  ___ ___  (_)  ___  (_)| |/')  _   _ | |_      __
/' _ ` _ `\| |/' _ `\| || , <  ( ) ( )| '_`\  /'__`\
| ( ) ( ) || || ( ) || || |\`\ | (_) || |_) )(  ___/
(_) (_) (_)(_)(_) (_)(_)(_) (_)`\___/'(_,__/'`\____)

                         _             _
            _         _ ( )           ( )
  ___ ___  (_)  ___  (_)| |/')  _   _ | |_      __
/' _ ` _ `\| |/' _ `\| || , <  ( ) ( )| '_`\  /'__`\
| ( ) ( ) || || ( ) || || |\`\ | (_) || |_) )(  ___/
(_) (_) (_)(_)(_) (_)(_)(_) (_)`\___/'(_,__/'`\____)

$ docker ps | grep nginx # 查看 nginx 容器的 id
701409f023de        nginx                  "/docker-entrypoint.…"   7 minutes ago       Up 7 minutes                            k8s_nginx_nginx_default_d94d0dba-f5c4-42a6-ac43-ac58d1f9afe0_0
$ docker exec -it 701409f023de sh # 这样就进来了
# exit<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>通过 inspect 查看容器的 ip 得到 “172.17.0.2/16”，正是上面 <code>kubectl get pods -o wide</code> 得到的 ip：</p>
<pre class="line-numbers language-shell"><code class="language-shell">$ docker network ls
NETWORK ID          NAME                DRIVER              SCOPE
f557efad83b5        bridge              bridge              local
532631c87d8b        host                host                local
66c4b8c8efa3        none                null                local
$ docker network inspect f557efad83b5
[
    {
        "Name": "bridge",
        "Id": "f557efad83b5947aa44cbe3989e93ded56da77ecddc42e98f3d469dea389c2a0",
        "Created": "2020-10-22T09:00:27.247244957Z",
        "Scope": "local",
        "Driver": "bridge",
        "EnableIPv6": false,
        "IPAM": {
            "Driver": "default",
            "Options": null,
            "Config": [
                {
                    "Subnet": "172.17.0.0/16",
                    "Gateway": "172.17.0.1"
                }
            ]
        },
        "Internal": false,
        "Attachable": false,
        "Ingress": false,
        "ConfigFrom": {
            "Network": ""
        },
        "ConfigOnly": false,
        "Containers": {
            "03a004aa1e27244812acedddb03dcbc471ff19472a05c53b292897cbaa704963": {
                "Name": "k8s_POD_nginx_default_d94d0dba-f5c4-42a6-ac43-ac58d1f9afe0_1",
                "EndpointID": "d5a75a4f94133680a249472e9389c7cb92108262ef9b13e4be0ee13c77bf14ec",
                "MacAddress": "02:42:ac:11:00:02",
                "IPv4Address": "172.17.0.2/16",
                "IPv6Address": ""
            },
            "05839cdb2c6b26ca0865bed8cbbcdff77a2056d6972d25627e3b11b0a13e071e": {
                "Name": "k8s_POD_coredns-f9fd979d6-gsjlm_kube-system_c2971377-7640-4c2d-bf5b-bbb3a2c4fa41_2",
                "EndpointID": "0a8539bd0e679a9cc7fc1eef47c3c393031a3a042503d75bbce6ce27600e7c9a",
                "MacAddress": "02:42:ac:11:00:03",
                "IPv4Address": "172.17.0.3/16",
                "IPv6Address": ""
            }
        },
        "Options": {
            "com.docker.network.bridge.default_bridge": "true",
            "com.docker.network.bridge.enable_icc": "true",
            "com.docker.network.bridge.enable_ip_masquerade": "true",
            "com.docker.network.bridge.host_binding_ipv4": "0.0.0.0",
            "com.docker.network.bridge.name": "docker0",
            "com.docker.network.driver.mtu": "1500"
        },
        "Labels": {}
    }
]<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>直接使用 <code>kubectl exec -it</code> 进入容器</p>
<pre class="line-numbers language-shell"><code class="language-shell">D:\docker\docker\chapter9\labs\pod-basic>kubectl exec -it nginx -- sh
#<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>通过 <code>-c=&lt;Container namme&gt;</code> 指定要进入的 pod 的容器，如果不指定，默认进入第一个容器</p>
</li>
</ul>
<h3 id="查看-pod-的更详细信息"><a href="#查看-pod-的更详细信息" class="headerlink" title="查看 pod 的更详细信息"></a>查看 pod 的更详细信息</h3><p>通过 <code>kubectl describe</code> 命令查看</p>
<pre class="line-numbers language-shell"><code class="language-shell">D:\docker\docker\chapter9\labs\pod-basic>kubectl describe pods nginx
Name:         nginx
Namespace:    default
Priority:     0
Node:         minikube/192.168.99.100
Start Time:   Thu, 22 Oct 2020 19:22:57 +0800
Labels:       app=nginx
Annotations:  <none>
Status:       Running
IP:           172.17.0.2
IPs:
  IP:  172.17.0.2
Containers:
  nginx:
    Container ID:   docker://701409f023de62e508b79b1cd95a70e2ce96cc8e4ab084c4cc4f5cc0fe82ca98
    Image:          nginx
    Image ID:       docker-pullable://nginx@sha256:ed7f815851b5299f616220a63edac69a4cc200e7f536a56e421988da82e44ed8
    Port:           80/TCP
    Host Port:      0/TCP
    State:          Running
      Started:      Thu, 22 Oct 2020 19:30:47 +0800
    Ready:          True
    Restart Count:  0
    Environment:    <none>
    Mounts:
      /var/run/secrets/kubernetes.io/serviceaccount from default-token-fc5qj (ro)
Conditions:
  Type              Status
  Initialized       True
  Ready             True
  ContainersReady   True
  PodScheduled      True
Volumes:
  default-token-fc5qj:
    Type:        Secret (a volume populated by a Secret)
    SecretName:  default-token-fc5qj
    Optional:    false
QoS Class:       BestEffort
Node-Selectors:  <none>
Tolerations:     node.kubernetes.io/not-ready:NoExecute op=Exists for 300s
                 node.kubernetes.io/unreachable:NoExecute op=Exists for 300s
Events:
  Type     Reason          Age                From               Message
  ----     ------          ----               ----               -------
  Normal   Scheduled       24m                default-scheduler  Successfully assigned default/nginx to minikube
  Warning  Failed          17m                kubelet, minikube  Failed to pull image "nginx": rpc error: code = Unknown desc = unexpected EOF
  Warning  Failed          17m                kubelet, minikube  Error: ErrImagePull
  Normal   SandboxChanged  17m                kubelet, minikube  Pod sandbox changed, it will be killed and re-created.
  Normal   BackOff         17m (x3 over 17m)  kubelet, minikube  Back-off pulling image "nginx"
  Warning  Failed          17m (x3 over 17m)  kubelet, minikube  Error: ImagePullBackOff
  Normal   Pulling         17m (x2 over 24m)  kubelet, minikube  Pulling image "nginx"
  Normal   Pulled          17m                kubelet, minikube  Successfully pulled image "nginx" in 8.817994182s
  Normal   Created         17m                kubelet, minikube  Created container nginx
  Normal   Started         17m                kubelet, minikube  Started container nginx<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></none></none></none></code></pre>
<h3 id="端口映射"><a href="#端口映射" class="headerlink" title="端口映射"></a>端口映射</h3><p>在 minikube 内部可以根据 nginx 容器的 ip 地址进行访问的</p>
<pre class="line-numbers language-shell"><code class="language-shell">D:\docker\docker\chapter9\labs\pod-basic>minikube ssh
                         _             _
            _         _ ( )           ( )
  ___ ___  (_)  ___  (_)| |/')  _   _ | |_      __
/' _ ` _ `\| |/' _ `\| || , <  ( ) ( )| '_`\  /'__`\
| ( ) ( ) || || ( ) || || |\`\ | (_) || |_) )(  ___/
(_) (_) (_)(_)(_) (_)(_)(_) (_)`\___/'(_,__/'`\____)

$ ping 172.17.0.2
PING 172.17.0.2 (172.17.0.2): 56 data bytes
64 bytes from 172.17.0.2: seq=0 ttl=64 time=0.242 ms
64 bytes from 172.17.0.2: seq=1 ttl=64 time=0.088 ms
^C
--- 172.17.0.2 ping statistics ---
2 packets transmitted, 2 packets received, 0% packet loss
round-trip min/avg/max = 0.088/0.165/0.242 ms
$ curl 172.17.0.2
<!DOCTYPE html>
<html>
<head><meta name="generator" content="Hexo 3.9.0">
<title>Welcome to nginx!</title>
<style>
    body {
        width: 35em;
        margin: 0 auto;
        font-family: Tahoma, Verdana, Arial, sans-serif;
    }
</style>
<link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css">
<link rel="stylesheet" href="/css/prism-line-numbers.css" type="text/css"></head>
<body>
<h1>Welcome to nginx!</h1>
<p>If you see this page, the nginx web server is successfully installed and
working. Further configuration is required.</p>

<p>For online documentation and support please refer to
<a href="http://nginx.org/">nginx.org</a>.<br>
Commercial support is available at
<a href="http://nginx.com/">nginx.com</a>.</p>

<p><em>Thank you for using nginx.</em></p>
</body>
</html>
$<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>下面我们要实现在 minikube 外面访问这个容器没，先查看 minikube  的 ip ，kuku 可以在外面访问</p>
<pre class="line-numbers language-shell"><code class="language-shell">$ ip a | grep inet
    inet 127.0.0.1/8 scope host lo
    inet 10.0.2.15/24 brd 10.0.2.255 scope global dynamic eth0
    inet 192.168.99.100/24 brd 192.168.99.255 scope global dynamic eth1
    inet 172.17.0.1/16 brd 172.17.255.255 scope global docker0
$ exit
logout
ssh: exit status 127

D:\docker\docker\chapter9\labs\pod-basic>ping 192.168.99.100

正在 Ping 192.168.99.100 具有 32 字节的数据:
来自 192.168.99.100 的回复: 字节=32 时间<1ms ttl="64" 来自 192.168.99.100 的回复: 字节="32" 时间<1ms 的 ping 统计信息: 数据包: 已发送="2，已接收" = 2，丢失="0" (0% 丢失)， 往返行程的估计时间(以毫秒为单位): 最短="0ms，最长" 0ms，平均="0ms" control-c ^c<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></1ms></code></pre>
<p> 通过 <code>kubectl port-forward &lt;pod-name&gt; &lt;local-port&gt;:&lt;container-port&gt;</code> 命令可以对指定 pod 做端口映射，下面命令将 nginx 的80 端口映射到 <code>kubectl</code> 所在主机(<strong>不是 minikube 主机</strong>)的 8080 端口：</p>
<pre class="line-numbers language-powershell"><code class="language-powershell">D:\docker\docker\chapter9\labs\pod<span class="token operator">-</span>basic>kubectl port<span class="token operator">-</span>forward nginx 8080:80
Forwarding <span class="token keyword">from</span> 127<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>1:8080 <span class="token operator">-</span>> 80
Forwarding <span class="token keyword">from</span> <span class="token punctuation">[</span>::1<span class="token punctuation">]</span>:8080 <span class="token operator">-</span>> 80
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>此时在 <code>kubectl</code> 所在主机访问 “127.0.0.1:8080” 就可以访问到 nginx 了：</p>
<p><img src="https://cdn.jsdelivr.net/gh/JohnZhongg/blog_images/image/20201221203214.png" alt="image-20201022201832158"></p>
<p>可以看到这种映射方式会导致当前终端阻塞，如果中断阻塞，就会导致映射结束。</p>
<h3 id="删除-pod"><a href="#删除-pod" class="headerlink" title="删除 pod"></a>删除 pod</h3><pre class="line-numbers language-powershell"><code class="language-powershell">D:\docker\docker\chapter9\labs\pod<span class="token operator">-</span>basic>kubectl delete <span class="token operator">-</span>f pod_nginx<span class="token punctuation">.</span>yml
pod <span class="token string">"nginx"</span> deleted

D:\docker\docker\chapter9\labs\pod<span class="token operator">-</span>basic>kubectl get pods
No resources found in default namespace<span class="token punctuation">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="pod-横向扩展"><a href="#pod-横向扩展" class="headerlink" title="pod 横向扩展"></a>pod 横向扩展</h3><h4 id="ReplicationController"><a href="#ReplicationController" class="headerlink" title="ReplicationController"></a>ReplicationController</h4><p>以下是一个类型是 ReplicationController 的资源，他会创建 3 个 pods，在 v1 版本的配置文件中，支持扩展 pod 副本的资源类型为 ReplicationController 。</p>
<pre class="line-numbers language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ReplicationController 
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">3</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx
  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx
      <span class="token key atrule">labels</span><span class="token punctuation">:</span>
        <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx
        <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx
        <span class="token key atrule">ports</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">80</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h5 id="创建"><a href="#创建" class="headerlink" title="创建"></a>创建</h5><p>使用 <code>kubectl create</code> 创建一个 ReplicationController 资源，<code>kubectl get rc</code> 获取资源创建情况：</p>
<pre class="line-numbers language-powershell"><code class="language-powershell">D:\docker\docker\chapter9\labs\replicas<span class="token operator">-</span><span class="token function">set</span>>kubectl create <span class="token operator">-</span>f rc_nginx<span class="token punctuation">.</span>yml
replicationcontroller<span class="token operator">/</span>nginx created

D:\docker\docker\chapter9\labs\replicas<span class="token operator">-</span><span class="token function">set</span>>kubectl get rc
NAME    DESIRED   CURRENT   READY   AGE
nginx   3         3         1       12s

D:\docker\docker\chapter9\labs\replicas<span class="token operator">-</span><span class="token function">set</span>>kubectl get pods
NAME          READY   STATUS    RESTARTS   AGE
nginx<span class="token operator">-</span>9m8br   1<span class="token operator">/</span>1     Running   0          26s
nginx<span class="token operator">-</span>h97jg   1<span class="token operator">/</span>1     Running   0          26s
nginx<span class="token operator">-</span>ntjcb   1<span class="token operator">/</span>1     Running   0          26s

D:\docker\docker\chapter9\labs\replicas<span class="token operator">-</span><span class="token function">set</span>>kubectl get rc
NAME    DESIRED   CURRENT   READY   AGE
nginx   3         3         3       30s
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h5 id="自愈"><a href="#自愈" class="headerlink" title="自愈"></a>自愈</h5><p>下面尝试删除一个 pod，和 docker swarm 一样具有自动恢复的功能：</p>
<pre class="line-numbers language-powershell"><code class="language-powershell">D:\docker\docker\chapter9\labs\replicas<span class="token operator">-</span><span class="token function">set</span>>kubectl delete pods nginx<span class="token operator">-</span>9m8br
pod <span class="token string">"nginx-9m8br"</span> deleted

D:\docker\docker\chapter9\labs\replicas<span class="token operator">-</span><span class="token function">set</span>>kubectl get pods
NAME          READY   STATUS    RESTARTS   AGE
nginx<span class="token operator">-</span>h97jg   1<span class="token operator">/</span>1     Running   0          3m18s
nginx<span class="token operator">-</span>ntjcb   1<span class="token operator">/</span>1     Running   0          3m18s
nginx<span class="token operator">-</span>schc7   1<span class="token operator">/</span>1     Running   0          8s<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h5 id="扩展"><a href="#扩展" class="headerlink" title="扩展"></a>扩展</h5><p>使用 <code>kubectl scale rc</code> 命令可以对 ReplicationController 进行横向扩展</p>
<pre class="line-numbers language-powershell"><code class="language-powershell">D:\docker\docker\chapter9\labs\replicas<span class="token operator">-</span><span class="token function">set</span>>kubectl scale rc nginx <span class="token operator">--</span>replicas=2
replicationcontroller<span class="token operator">/</span>nginx scaled

D:\docker\docker\chapter9\labs\replicas<span class="token operator">-</span><span class="token function">set</span>>kubectl get rc
NAME    DESIRED   CURRENT   READY   AGE
nginx   2         2         2       6m35s

D:\docker\docker\chapter9\labs\replicas<span class="token operator">-</span><span class="token function">set</span>>kubectl scale rc nginx <span class="token operator">--</span>replicas=4
replicationcontroller<span class="token operator">/</span>nginx scaled

D:\docker\docker\chapter9\labs\replicas<span class="token operator">-</span><span class="token function">set</span>>kubectl get rc
NAME    DESIRED   CURRENT   READY   AGE
nginx   4         4         4       6m53s
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h5 id="删除"><a href="#删除" class="headerlink" title="删除"></a>删除</h5><pre class="line-numbers language-powershell"><code class="language-powershell">D:\docker\docker\chapter9\labs\replicas<span class="token operator">-</span><span class="token function">set</span>>kubectl delete <span class="token operator">-</span>f rc_nginx<span class="token punctuation">.</span>yml
replicationcontroller <span class="token string">"nginx"</span> deleted

D:\docker\docker\chapter9\labs\replicas<span class="token operator">-</span><span class="token function">set</span>>kubectl get pods
No resources found in default namespace<span class="token punctuation">.</span>

D:\docker\docker\chapter9\labs\replicas<span class="token operator">-</span><span class="token function">set</span>>kubectl get rc
No resources found in default namespace<span class="token punctuation">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="ReplicaSet"><a href="#ReplicaSet" class="headerlink" title="ReplicaSet"></a>ReplicaSet</h4><p>ReplicaSet 是用来替换 ReplictionController 的，它在 apps/v1 版本配置文件中开始支持，它比 ReplicationController 多了一个 new set-based selector requirement 的功能，以下是它的一个 yml 文件配置：</p>
<pre class="line-numbers language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ReplicaSet
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">tier</span><span class="token punctuation">:</span> frontend
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">3</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
      <span class="token key atrule">tier</span><span class="token punctuation">:</span> frontend
  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx
      <span class="token key atrule">labels</span><span class="token punctuation">:</span>
        <span class="token key atrule">tier</span><span class="token punctuation">:</span> frontend
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx
        <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx
        <span class="token key atrule">ports</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">80</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h5 id="创建-1"><a href="#创建-1" class="headerlink" title="创建"></a>创建</h5><p><code>kubectl create rs</code> 创建 ReplicaSet</p>
<pre class="line-numbers language-powershell"><code class="language-powershell">D:\docker\docker\chapter9\labs\replicas<span class="token operator">-</span><span class="token function">set</span>>kubectl create <span class="token operator">-</span>f rs_nginx<span class="token punctuation">.</span>yml
replicaset<span class="token punctuation">.</span>apps<span class="token operator">/</span>nginx created

D:\docker\docker\chapter9\labs\replicas<span class="token operator">-</span><span class="token function">set</span>>kubectl get rs
NAME    DESIRED   CURRENT   READY   AGE
nginx   3         3         3       15s

D:\docker\docker\chapter9\labs\replicas<span class="token operator">-</span><span class="token function">set</span>>kubectl get pods
NAME          READY   STATUS    RESTARTS   AGE
nginx<span class="token operator">-</span>5ddz7   1<span class="token operator">/</span>1     Running   0          21s
nginx<span class="token operator">-</span>7gfjk   1<span class="token operator">/</span>1     Running   0          21s
nginx<span class="token operator">-</span>t4k5l   1<span class="token operator">/</span>1     Running   0          21s<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h5 id="自愈-1"><a href="#自愈-1" class="headerlink" title="自愈"></a>自愈</h5><p>… …</p>
<h5 id="扩展-1"><a href="#扩展-1" class="headerlink" title="扩展"></a>扩展</h5><p><code>kubectl scale rs</code> 横向扩展</p>
<pre class="line-numbers language-powershell"><code class="language-powershell">D:\docker\docker\chapter9\labs\replicas<span class="token operator">-</span><span class="token function">set</span>>kubectl scale rs nginx <span class="token operator">--</span>replicas=2
replicaset<span class="token punctuation">.</span>apps<span class="token operator">/</span>nginx scaled

D:\docker\docker\chapter9\labs\replicas<span class="token operator">-</span><span class="token function">set</span>>kubectl get rs
NAME    DESIRED   CURRENT   READY   AGE
nginx   2         2         2       42s
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h5 id="删除-1"><a href="#删除-1" class="headerlink" title="删除"></a>删除</h5><pre class="line-numbers language-powershell"><code class="language-powershell">D:\docker\docker\chapter9\labs\replicas<span class="token operator">-</span><span class="token function">set</span>>kubectl delete <span class="token operator">-</span>f rs_nginx<span class="token punctuation">.</span>yml
replicaset<span class="token punctuation">.</span>apps <span class="token string">"nginx"</span> deleted

D:\docker\docker\chapter9\labs\replicas<span class="token operator">-</span><span class="token function">set</span>>kubectl get rs
No resources found in default namespace<span class="token punctuation">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="Deployment"><a href="#Deployment" class="headerlink" title="Deployment"></a>Deployment</h4><p>deployment 是比 replicas set 更抽象的资源，使用它可以创建 replicas set 的同时还可以对 replicas set 进行更新操作，例如镜像更新，端口更新等，类似 docker swarm 的 docker service update 和 docker deploy。下面是它的一个配置文件：</p>
<pre class="line-numbers language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>deployment
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">3</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
      <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx
  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">labels</span><span class="token punctuation">:</span>
        <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx
        <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx<span class="token punctuation">:</span>1.12.2
        <span class="token key atrule">ports</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">80</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h5 id="创建-2"><a href="#创建-2" class="headerlink" title="创建"></a>创建</h5><p><code>kubectl create</code> 指定 deployment 类型的配置文件创建 deployment，使用 <code>kubectl get deployment</code> 获取创建的 deployment 信息：</p>
<pre class="line-numbers language-powershell"><code class="language-powershell">D:\docker\docker\chapter9\labs\deployment>kubectl create <span class="token operator">-</span>f deployment_nginx<span class="token punctuation">.</span>yml
deployment<span class="token punctuation">.</span>apps<span class="token operator">/</span>nginx<span class="token operator">-</span>deployment created

D:\docker\docker\chapter9\labs\deployment>kubectl get deployment
NAME               READY   UP<span class="token operator">-</span>TO<span class="token operator">-</span>DATE   AVAILABLE   AGE
nginx<span class="token operator">-</span>deployment   0<span class="token operator">/</span>3     3            0           9s

D:\docker\docker\chapter9\labs\deployment>kubectl get deployment
NAME               READY   UP<span class="token operator">-</span>TO<span class="token operator">-</span>DATE   AVAILABLE   AGE
nginx<span class="token operator">-</span>deployment   3<span class="token operator">/</span>3     3            3           23s

D:\docker\docker\chapter9\labs\deployment>kubectl get rs
NAME                          DESIRED   CURRENT   READY   AGE
nginx<span class="token operator">-</span>deployment<span class="token operator">-</span>84b8bdb667   3         3         3       32s

D:\docker\docker\chapter9\labs\deployment>kubectl get pods
NAME                                READY   STATUS    RESTARTS   AGE
nginx<span class="token operator">-</span>deployment<span class="token operator">-</span>84b8bdb667<span class="token operator">-</span>tfsfr   1<span class="token operator">/</span>1     Running   0          39s
nginx<span class="token operator">-</span>deployment<span class="token operator">-</span>84b8bdb667<span class="token operator">-</span>tr9dm   1<span class="token operator">/</span>1     Running   0          39s
nginx<span class="token operator">-</span>deployment<span class="token operator">-</span>84b8bdb667<span class="token operator">-</span>xp8pm   1<span class="token operator">/</span>1     Running   0          39s<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h5 id="查看详细信息"><a href="#查看详细信息" class="headerlink" title="查看详细信息"></a>查看详细信息</h5><pre class="line-numbers language-powershell"><code class="language-powershell">D:\docker\docker\chapter9\labs\deployment>kubectl get deployment <span class="token operator">-</span>o wide
NAME               READY   UP<span class="token operator">-</span>TO<span class="token operator">-</span>DATE   AVAILABLE   AGE     CONTAINERS   IMAGES         SELECTOR
nginx<span class="token operator">-</span>deployment   3<span class="token operator">/</span>3     3            3           3m36s   nginx        nginx:1<span class="token punctuation">.</span>12<span class="token punctuation">.</span>2   app=nginx
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<h5 id="更新-deployment"><a href="#更新-deployment" class="headerlink" title="更新 deployment"></a>更新 deployment</h5><ul>
<li><p>使用 <code>kubectl set image deployment</code> 更新镜像</p>
<pre class="line-numbers language-powershell"><code class="language-powershell">D:\docker\docker\chapter9\labs\deployment>kubectl <span class="token function">set</span> image deployment nginx<span class="token operator">-</span>deployment nginx=nginx:1<span class="token punctuation">.</span>13
deployment<span class="token punctuation">.</span>apps<span class="token operator">/</span>nginx<span class="token operator">-</span>deployment image updated

D:\docker\docker\chapter9\labs\deployment>kubectl get deployment <span class="token operator">-</span>o wide
NAME               READY   UP<span class="token operator">-</span>TO<span class="token operator">-</span>DATE   AVAILABLE   AGE    CONTAINERS   IMAGES       SELECTOR
nginx<span class="token operator">-</span>deployment   3<span class="token operator">/</span>3     3            3           8m8s   nginx        nginx:1<span class="token punctuation">.</span>13   app=nginx

D:\docker\docker\chapter9\labs\deployment>kubectl get rs
NAME                          DESIRED   CURRENT   READY   AGE
nginx<span class="token operator">-</span>deployment<span class="token operator">-</span>687d765c64   3         3         3       29s
nginx<span class="token operator">-</span>deployment<span class="token operator">-</span>84b8bdb667   0         0         0       8m18s

D:\docker\docker\chapter9\labs\deployment>kubectl get pods
NAME                                READY   STATUS    RESTARTS   AGE
nginx<span class="token operator">-</span>deployment<span class="token operator">-</span>687d765c64<span class="token operator">-</span>24s72   1<span class="token operator">/</span>1     Running   0          36s
nginx<span class="token operator">-</span>deployment<span class="token operator">-</span>687d765c64<span class="token operator">-</span>pzz7w   1<span class="token operator">/</span>1     Running   0          27s
nginx<span class="token operator">-</span>deployment<span class="token operator">-</span>687d765c64<span class="token operator">-</span>tm68b   1<span class="token operator">/</span>1     Running   0          29s<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>使用 <code>kubectl apply -f &lt;resource-yml&gt;</code> 指定一个对某个现有资源的配置做了更改的 yml 文件，也会对正在运行的资源进行更新，apply 相当于 create or update。而 create 只会 create ，如果资源已存在，就会报错。</p>
</li>
<li><p><code>kubectl edit deployment &lt;deployment-name&gt;</code> 也可以对资源进行更新，它会打开资源的 yaml 文件编辑界面，我们对 yml 文件更新后保存即可。</p>
</li>
</ul>
<h5 id="滚动发布"><a href="#滚动发布" class="headerlink" title="滚动发布"></a>滚动发布</h5><p>deployment 的更新是滚动的，使用 <code>kubectl describe deployment</code> 可以看到它的策略：</p>
<pre class="line-numbers language-shell"><code class="language-shell">[root@k8s-master deployment]# kubectl describe deployment nginx-deployment
... ...
StrategyType:           RollingUpdate
MinReadySeconds:        0
RollingUpdateStrategy:  25% max unavailable, 25% max surge
... ...<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h5 id="回滚"><a href="#回滚" class="headerlink" title="回滚"></a>回滚</h5><p><code>kubectl rollout history</code> 查看 deployment 的历史记录</p>
<pre class="line-numbers language-powershell"><code class="language-powershell">D:\docker\docker\chapter9\labs\deployment>kubectl rollout history deployment nginx<span class="token operator">-</span>deployment
deployment<span class="token punctuation">.</span>apps<span class="token operator">/</span>nginx<span class="token operator">-</span>deployment
REVISION  CHANGE<span class="token operator">-</span>CAUSE
1         &lt;none>
2         &lt;none>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>查看版本1 和版本 2 的详细：</p>
<pre class="line-numbers language-shell"><code class="language-shell">[root@k8s-master deployment]# kubectl rollout history deployment nginx-deployment --revision 1
deployment.apps/nginx-deployment with revision #1
Pod Template:
  Labels:    app=nginx
    pod-template-hash=84b8bdb667
  Containers:
   nginx:
    Image:    nginx:1.12.2
    Port:    80/TCP
    Host Port:    0/TCP
    Environment:    <none>
    Mounts:    <none>
  Volumes:    <none>

[root@k8s-master deployment]# kubectl rollout history deployment nginx-deployment --revision 2
deployment.apps/nginx-deployment with revision #2
Pod Template:
  Labels:    app=nginx
    pod-template-hash=687d765c64
  Containers:
   nginx:
    Image:    nginx:1.13
    Port:    80/TCP
    Host Port:    0/TCP
    Environment:    <none>
    Mounts:    <none>
  Volumes:    <none>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></none></none></none></none></none></none></code></pre>
<p><code>kubectl rollout undo</code> 对 deployment 进行回滚；另外加 <code>--to-revision &lt;revision num&gt;</code> 可以回滚到指定版本</p>
<pre class="line-numbers language-powershell"><code class="language-powershell">D:\docker\docker\chapter9\labs\deployment>kubectl rollout undo deployment nginx<span class="token operator">-</span>deployment
deployment<span class="token punctuation">.</span>apps<span class="token operator">/</span>nginx<span class="token operator">-</span>deployment rolled back

D:\docker\docker\chapter9\labs\deployment>kubectl get deployment <span class="token operator">-</span>o wide
NAME               READY   UP<span class="token operator">-</span>TO<span class="token operator">-</span>DATE   AVAILABLE   AGE   CONTAINERS   IMAGES         SELECTOR
nginx<span class="token operator">-</span>deployment   3<span class="token operator">/</span>3     3            3           10m   nginx        nginx:1<span class="token punctuation">.</span>12<span class="token punctuation">.</span>2   app=nginx

D:\docker\docker\chapter9\labs\deployment>kubectl rollout history deployment nginx<span class="token operator">-</span>deployment
deployment<span class="token punctuation">.</span>apps<span class="token operator">/</span>nginx<span class="token operator">-</span>deployment
REVISION  CHANGE<span class="token operator">-</span>CAUSE
2         &lt;none>
3         &lt;none>


D:\docker\docker\chapter9\labs\deployment>kubectl <span class="token function">set</span> image deployment nginx<span class="token operator">-</span>deployment nginx=nginx:1<span class="token punctuation">.</span>13
deployment<span class="token punctuation">.</span>apps<span class="token operator">/</span>nginx<span class="token operator">-</span>deployment image updated<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h5 id="自愈-2"><a href="#自愈-2" class="headerlink" title="自愈"></a>自愈</h5><p>deployment 包装了 ReplicasSet，依赖 ReplicasSet 实现 。</p>
<h1 id="Namespace"><a href="#Namespace" class="headerlink" title="Namespace"></a>Namespace</h1><p>Namespace 用来隔离资源，可以在不同的 Namespace 下同时存在两个同类型同名的资源，不能在一个 Namespace 下存在这种情况。即以 pod 为例，现在的 k8s 资源结构层级为：cluster - context - namespace - pod。</p>
<p><code>kubectl get namespaces</code> 查看命名空间：</p>
<pre class="line-numbers language-shell"><code class="language-shell">[root@k8s-master ~]# kubectl get namespaces
NAME              STATUS   AGE
default           Active   21h
kube-node-lease   Active   21h
kube-public       Active   21h
kube-system       Active   21h<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>获取指定 namespace 下面的 pods；获取所有 namespace 下的资源使用参数 <code>--all-namespaces</code> ：</p>
<pre class="line-numbers language-shell"><code class="language-shell">[root@k8s-master ~]# kubectl get pod --namespace kube-system
NAME                                 READY   STATUS    RESTARTS   AGE
coredns-6c76c8bb89-c5dcd             1/1     Running   1          21h
coredns-6c76c8bb89-n5hqc             1/1     Running   1          21h
etcd-k8s-master                      1/1     Running   1          21h
kube-apiserver-k8s-master            1/1     Running   1          21h
kube-controller-manager-k8s-master   1/1     Running   2          21h
kube-proxy-ctz76                     1/1     Running   0          21h
kube-proxy-fn2fh                     1/1     Running   0          21h
kube-proxy-qbjjx                     1/1     Running   1          21h
kube-scheduler-k8s-master            1/1     Running   2          21h
weave-net-k777j                      2/2     Running   3          21h
weave-net-m88vt                      2/2     Running   0          21h
weave-net-w6krt                      2/2     Running   1          21h<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>创建 namespace</p>
<pre class="line-numbers language-shell"><code class="language-shell">[root@k8s-master ~]# kubectl create namespace demo
namespace/demo created
[root@k8s-master ~]# kubectl get namespaces
NAME              STATUS   AGE
default           Active   21h
demo              Active   3s
kube-node-lease   Active   21h
kube-public       Active   21h
kube-system       Active   21h<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在创建 pod 的 yml 文件中，在顶级属性 metadata 下的子属性 namespace 指定命名空间：</p>
<pre class="line-numbers language-yaml"><code class="language-yaml"><span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx
    <span class="token key atrule">namesapce</span><span class="token punctuation">:</span> demo
    <span class="token punctuation">...</span> <span class="token punctuation">...</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>删除当前上下文中的命名空间：</p>
<pre class="line-numbers language-shell"><code class="language-shell">[root@k8s-master ~]# kubectl delete namespaces demo
namespace "demo" deleted<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<h3 id="k8s-自带命名空间"><a href="#k8s-自带命名空间" class="headerlink" title="k8s 自带命名空间"></a>k8s 自带命名空间</h3><pre class="line-numbers language-shell"><code class="language-shell">[root@k8s-master ~]# kubectl get ns
NAME              STATUS   AGE
default           Active   27h
kube-node-lease   Active   27h
kube-public       Active   27h
kube-system       Active   27h<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>其中 kube-system 中运行着 kubernetes 提供的服务的 pod ，如 etcd、controller、apiserver等等，其中还有一个提供 DNS 服务 的 service ：kube-dns。</p>
<h4 id="内置-DNS-服务"><a href="#内置-DNS-服务" class="headerlink" title="内置 DNS 服务"></a>内置 DNS 服务</h4><p>如下就是内置 DNS 服务的信息，它的 ip 地址是 10.96.0.10，kubernetes 通过在每个容器内的 <code>/etc/resolv.conf</code> 文件中增加这个 ip 地址为 DNS 服务器地址，从而实现每个容器进行 DNS 查询的时候就会访问这个 ip 。</p>
<pre class="line-numbers language-shell"><code class="language-shell">[root@k8s-master ~]# kubectl get services -n kube-system -o wide
NAME       TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)                  AGE   SELECTOR
kube-dns   ClusterIP   10.96.0.10   <none>        53/UDP,53/TCP,9153/TCP   27h   k8s-app=kube-dns<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></none></code></pre>
<h1 id="Context"><a href="#Context" class="headerlink" title="Context"></a>Context</h1><p><strong>default 是所有上下文中默认的缺省命名空间，创建上下文的时候如果没有指定 namespace ，后续创建资源的时候如果没有创建自定义的命名空间或者创建资源没有指定命名空间，新创建的资源就会位于这个命名空间下面</strong> :</p>
<pre class="line-numbers language-shell"><code class="language-shell">[root@k8s-master ~]# kubectl config get-contexts
CURRENT   NAME                          CLUSTER      AUTHINFO           NAMESPACE
*         kubernetes-admin@kubernetes   kubernetes   kubernetes-admin<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>另外我们可以创建自己的上下文并指定该上下文的默认命名空间，如下所示，在 demo 上下文中创建资源没有指定命名空间，就会放到 demo 命名空间中：</p>
<pre class="line-numbers language-shell"><code class="language-shell">[root@k8s-master ~]# kubectl config set-context demo --user=john --cluster=kubernetes --namespace=demo
Context "demo" created.
[root@k8s-master ~]# kubectl config get-contexts
CURRENT   NAME                          CLUSTER      AUTHINFO           NAMESPACE
          demo                          kubernetes   john               demo
*         kubernetes-admin@kubernetes   kubernetes   kubernetes-admin
[root@k8s-master ~]# kubectl config view
apiVersion: v1
clusters:
- cluster:
    certificate-authority-data: DATA+OMITTED
    server: https://192.168.205.120:6443
  name: kubernetes
contexts:
- context:
    cluster: kubernetes
    namespace: demo
    user: john
  name: demo
- context:
    cluster: kubernetes
    user: kubernetes-admin
  name: kubernetes-admin@kubernetes
current-context: kubernetes-admin@kubernetes
kind: Config
preferences: {}
users:
- name: kubernetes-admin
  user:
    client-certificate-data: REDACTED
    client-key-data: REDACTED<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>删除上下文：</p>
<pre class="line-numbers language-shell"><code class="language-shell">[root@k8s-master ~]# kubectl config delete-context demo
deleted context demo from /root/.kube/config<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<h1 id="Service"><a href="#Service" class="headerlink" title="Service"></a>Service</h1><p>反向代理、负载均衡。</p>
<h3 id="Selector、Label"><a href="#Selector、Label" class="headerlink" title="Selector、Label"></a>Selector、Label</h3><p>Service 使用 Selector 组件获取 pods 的标签并根据 Selector 的条件标签进行流量定向。</p>
<h3 id="Service-Type"><a href="#Service-Type" class="headerlink" title="Service Type"></a>Service Type</h3><h4 id="ClusterIP"><a href="#ClusterIP" class="headerlink" title="ClusterIP"></a>ClusterIP</h4><p>k8s 内部服务暴露</p>
<h4 id="NodePort"><a href="#NodePort" class="headerlink" title="NodePort"></a>NodePort</h4><p>k8s 服务暴露给外部</p>
<h4 id="LoadBalancer"><a href="#LoadBalancer" class="headerlink" title="LoadBalancer"></a>LoadBalancer</h4><p>暴露服务到公网（只监听公网ip，NodePort 监听内网 ip？）</p>
<h3 id="网络转发模式"><a href="#网络转发模式" class="headerlink" title="网络转发模式"></a>网络转发模式</h3><ul>
<li><p>用户空间代理模式：路由信息存储在 kube-proxy 中，转发逻辑需要切换到 kube-proxy 用户态然后再切回内核态</p>
</li>
<li><p>iptables：每一个 pod 一条 netfilter(iptables 接口操作的内核程序) 规则，负载均衡由转发表实现，负载均衡算法较简单，且一个 pod 一条规则在大规模 k8s 集群下会导致规则过多，频繁更新 linux 内核的 netfilter。</p>
</li>
<li><p>IPVS：一个 service 一条 netfilter 规则，这条规则会将流量转发到 LVS，由 LVS 实现负载均衡，性能更高，算法更多。</p>
</li>
</ul>
<h3 id="蓝绿发布"><a href="#蓝绿发布" class="headerlink" title="蓝绿发布"></a>蓝绿发布</h3><p>先发布新版本 pod，与旧版本 pod 并存，修改 Service Selector Label 指向新版本，待新版本稳定后删除旧版本；如果新版本出现问题，则改回旧版本。</p>
<h1 id="k8s-ingress"><a href="#k8s-ingress" class="headerlink" title="k8s ingress"></a>k8s ingress</h1><p>本质上也是一种 service，相当于微服务网关，可以实现流量路由(根据域名、路径、端口等路由到不同 pod)、安全认证、日志监控、流量治理等功能。k8s 的 ingress 和网络一样也是提供了一个标准，有不同的实现，流行的是 nginx-ingress。</p>
<h1 id="ConfigMap"><a href="#ConfigMap" class="headerlink" title="ConfigMap"></a>ConfigMap</h1><p>通过发布一个 ConfigMap 对象，然后在其它对象如 Pod、Service 等中引用这个 ConfigMap 对象。</p>
<ul>
<li>通过环境变量的形式注入配置到容器：<code>envFrom</code> 属性的 <code>configMapRef</code> 子属性</li>
<li>挂载一个 volume 到容器，并将配置以文件的形式放到 volume 中</li>
</ul>
<h3 id="变更传播"><a href="#变更传播" class="headerlink" title="变更传播"></a>变更传播</h3><p>更新一个已经发布的 ConfigMap，并不会将更新传播到正在运行的之前引用了该 ConfigMap 的 Pod 中。需要以下做法：</p>
<ul>
<li>重启 pod</li>
<li>修改被更新的 ConfigMap 的名称，或者创建一个新的配置文件填入新的内容和名称，然后修改引用了该 ConfigMap 的资源中的 ConfigMap 名称，重新发布该资源，利用滚动更新的机制相较上面直接重启的方式更平滑</li>
</ul>
<h1 id="Secret"><a href="#Secret" class="headerlink" title="Secret"></a>Secret</h1><p>Secret 和 ConfigMap 一样也是一个键值对的配置存储对象，也是有环境变量注入和 volume 挂载的方式进行使用。区别是使用 <code>kubectl describe</code> 的时候 ConfigMap 会显示配置信息，Secret 不会显示。不过使用 <code>kubectl get secret &lt;secret-name&gt; -o yaml</code> 的时候就会显示了，包括配置值的 base64 编码，如果在 yml 文件中填写的是明文，那么也会显示明文信息。而且 base64 也是不安全的，很容器解码。</p>
<h1 id="volume"><a href="#volume" class="headerlink" title="volume"></a>volume</h1><p>k8s 的 volume 有多种类型，hostPath 表示本地文件。在 <code>containers</code> 的子属性 <code>volumeMounts</code> 的子属性 <code>name</code> 引用 <code>containers</code> 的兄弟属性 <code>volumes</code> 的子属性 <code>name</code> 即可对 pod 的路径进行 volume 挂载。挂载的本地文件路径需要是共享的。</p>
<h1 id="PV、PVC"><a href="#PV、PVC" class="headerlink" title="PV、PVC"></a>PV、PVC</h1><p>将在 <code>volumes</code> 中定义的具体 volume 类型进行解耦，改成引用一个 PVC 对象，而 PVC 对象定义 yml 中引用一个 PV。PVC 表示一个申请动作，PV 中定义了具体的 volume 类型和持久化路径。</p>
<pre class="line-numbers language-shell"><code class="language-shell">kubectl get pv
kubectl get pvc<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<h1 id="resources"><a href="#resources" class="headerlink" title="resources"></a>resources</h1><p><code>containers</code> 的子属性 <code>resources</code> 进行设置。</p>
<h3 id="request"><a href="#request" class="headerlink" title="request"></a>request</h3><p>最小需求，如果 k8s 中的资源不能满足，pod 发布就会 pending（如果一个 deployment 发布多个 pod，则会先发布满足资源的 pod，剩下的如果资源不足就 pending），直到资源满足才会启动。</p>
<h3 id="limit"><a href="#limit" class="headerlink" title="limit"></a>limit</h3><p>最大可使用量。如果 pod 在运行过程中内存申请超过了 limit，会被 OOM kil 然后重启（CrashLoopBackOff），重启达到一定次数还不能成功就停止；CPU 资源则会被硬性限制。</p>
<h3 id="三种设置"><a href="#三种设置" class="headerlink" title="三种设置"></a>三种设置</h3><ol>
<li>Guaranteed：request=limit，只有内存使用超出 limit 才会被kill</li>
<li>Burstable：request &lt; limit，在 k8s 集群资源不足的时候可能会 kill</li>
<li>Best Effor：两个值都不设置，在 k8s 资源不足的时候会被 kiil</li>
</ol>
<h1 id="查看资源情况"><a href="#查看资源情况" class="headerlink" title="查看资源情况"></a>查看资源情况</h1><h2 id="metrics-server"><a href="#metrics-server" class="headerlink" title="metrics-server"></a>metrics-server</h2><p>需要安装，安装之后通过 <code>kubectl top</code> 命令可以查看各维度、资源的 metrics。</p>
<h2 id="kubernetes-dashboard"><a href="#kubernetes-dashboard" class="headerlink" title="kubernetes-dashboard"></a>kubernetes-dashboard</h2><p>也需要安装，安装之后有一个图形化界面可以查看各指标信息。</p>
<h1 id="k8s-Java-pod-内存限制"><a href="#k8s-Java-pod-内存限制" class="headerlink" title="k8s Java pod 内存限制"></a>k8s Java pod 内存限制</h1><p>需要开启容器识别，这样 k8s 的 resource request/limit 才能生效，然后设置 JVM 相应的内存参数。</p>
<h1 id="k8s-就绪和存活探针"><a href="#k8s-就绪和存活探针" class="headerlink" title="k8s 就绪和存活探针"></a>k8s 就绪和存活探针</h1><p>防止在 pod 实际上不可用的情况下向它发送流量发生错误。</p>
<ul>
<li><p>就绪探针：在 pod 启动时期检测是否就绪，就绪才会发送流量。</p>
</li>
<li><p>存活探针：在 pod 运行时期检测，如果没有存活则会 kill 掉 pod 重启。</p>
</li>
</ul>
<blockquote>
<p>另外在容器依赖的情况下应该也有用到</p>
</blockquote>
<h1 id="helm-charts"><a href="#helm-charts" class="headerlink" title="helm/charts"></a>helm/charts</h1><p>k8s 插件、安装包管理。</p>

            </div>
            <hr>

            
            <style>
    #reward {
        margin: 40px 0;
        text-align: center;
    }

    #reward .reward-link {
        font-size: 1.88rem;
    }

    #reward .btn-floating:hover {
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2), 0 5px 15px rgba(0, 0, 0, 0.2);
    }

    #rewardModal {
        width: 320px;
        height: 350px;
    }

    #rewardModal .reward-title {
        margin: 15px auto;
        padding-bottom: 5px;
    }

    #rewardModal .modal-content {
        padding: 10px;
    }

    #rewardModal .close {
        position: absolute;
        right: 15px;
        top: 15px;
        color: rgba(0, 0, 0, 0.5);
        font-size: 1.3rem;
        line-height: 20px;
        cursor: pointer;
    }

    #rewardModal .close:hover {
        color: #ef5350;
        transform: scale(1.3);
        -moz-transform:scale(1.3);
        -webkit-transform:scale(1.3);
        -o-transform:scale(1.3);
    }

    #rewardModal .reward-tabs {
        margin: 0 auto;
        width: 210px;
    }

    .reward-tabs .tabs {
        height: 38px;
        margin: 10px auto;
        padding-left: 0;
    }

    .reward-content ul {
        padding-left: 0 !important;
    }

    .reward-tabs .tabs .tab {
        height: 38px;
        line-height: 38px;
    }

    .reward-tabs .tab a {
        color: #fff;
        background-color: #ccc;
    }

    .reward-tabs .tab a:hover {
        background-color: #ccc;
        color: #fff;
    }

    .reward-tabs .wechat-tab .active {
        color: #fff !important;
        background-color: #22AB38 !important;
    }

    .reward-tabs .alipay-tab .active {
        color: #fff !important;
        background-color: #019FE8 !important;
    }

    .reward-tabs .reward-img {
        width: 210px;
        height: 210px;
    }
</style>

<div id="reward">
    <a href="#rewardModal" class="reward-link modal-trigger btn-floating btn-large waves-effect waves-light red">赏</a>

    <!-- Modal Structure -->
    <div id="rewardModal" class="modal">
        <div class="modal-content">
            <a class="close modal-close"><i class="fa fa-close"></i></a>
            <h4 class="reward-title">写作不易，客官能否打赏一杯奶茶？</h4>
            <div class="reward-content">
                <div class="reward-tabs">
                    <ul class="tabs row">
                        <li class="tab col s6 alipay-tab waves-effect waves-light"><a href="#alipay">支付宝</a></li>
                        <li class="tab col s6 wechat-tab waves-effect waves-light"><a href="#wechat">微 信</a></li>
                    </ul>
                    <div id="alipay">
                        <img src="/medias/reward/alipay.jpg" class="reward-img" alt="支付宝打赏二维码">
                    </div>
                    <div id="wechat">
                        <img src="/medias/reward/wechat.jpg" class="reward-img" alt="微信打赏二维码">
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    $(function () {
        $('.tabs').tabs();
    });
</script>
            

            <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">

<div id="article-share">
    
    <div class="social-share" data-disabled="qzone" data-wechat-qrcode-helper="<p>微信里点“发现”->“扫一扫”二维码便可查看分享。</p>"></div>
    
</div>

<script src="/libs/share/js/social-share.min.js"></script>

            

    <div class="reprint" id="reprint-statement">
        <p class="reprint-tip">
            <i class="fa fa-exclamation-triangle"></i>&nbsp;&nbsp;
            <span>转载规则</span>
        </p>
        
            <div class="center-align">
                <a rel="license" href="https://creativecommons.org/licenses/by/4.0/deed.zh">
                    <img alt style="border-width:0" src="https://i.creativecommons.org/l/by/4.0/88x31.png">
                </a>
            </div>
            <br>
            <span xmlns:dct="http://purl.org/dc/terms/" href="http://purl.org/dc/dcmitype/Text" property="dct:title" rel="dct:type">
                    《k8s入门概述》
                </span> 由
            <a xmlns:cc="http://creativecommons.org/ns#" href="/2020/12/22/docker/k8s-ru-men-gai-shu/" property="cc:attributionName" rel="cc:attributionURL">
                阿钟
            </a> 采用
            <a rel="license" href="https://creativecommons.org/licenses/by/4.0/deed.zh">
                知识共享署名 4.0 国际许可协议
            </a>进行许可。
        
    </div>

    <script async defer>
      document.addEventListener("copy", function (e) {
        let toastHTML = '<span>复制成功，请遵循本文的转载规则</span><button class="btn-flat toast-action" onclick="navToReprintStatement()" style="font-size: smaller">查看</a>';
        M.toast({html: toastHTML})
      });

      function navToReprintStatement() {
        $("html, body").animate({scrollTop: $("#reprint-statement").offset().top - 80}, 800);
      }
    </script>


        </div>
    </div>

    
    <link rel="stylesheet" href="/libs/gitalk/gitalk.css">
<link rel="stylesheet" href="/css/my-gitalk.css">

<div class="card gitalk-card" data-aos="fade-up">
    <div id="gitalk-container" class="card-content"></div>
</div>

<script src="/libs/gitalk/gitalk.min.js"></script>
<script>
    let gitalk = new Gitalk({
        clientID: '466e387c08bce10f3f28',
        clientSecret: '5b2bf16f8a42bd72eef32e50187c7f2ccb105a1d',
        repo: 'azhong.github.io',
        owner: 'JohnZhongg',
        admin: "JohnZhongg",
        id: '2020/12/22/docker/k8s-ru-men-gai-shu/',
        distractionFreeMode: false  // Facebook-like distraction free mode
    });

    gitalk.render('gitalk-container');
</script>
    

    

    

    

    
    <style>
    .valine-card {
        margin: 1.5rem auto;
    }

    .valine-card .card-content {
        padding: 20px 20px 5px 20px;
    }

    #vcomments input[type=text],
    #vcomments input[type=email],
    #vcomments input[type=url],
    #vcomments textarea {
        box-sizing: border-box;
    }

    #vcomments p {
        margin: 2px 2px 10px;
        font-size: 1.05rem;
        line-height: 1.78rem;
    }

    #vcomments blockquote p {
        text-indent: 0.2rem;
    }

    #vcomments a {
        padding: 0 2px;
        color: #42b983;
        font-weight: 500;
        text-decoration: underline;
    }

    #vcomments img {
        max-width: 100%;
        height: auto;
        cursor: pointer;
    }

    #vcomments ol li {
        list-style-type: decimal;
    }

    #vcomments ol,
    ul {
        display: block;
        padding-left: 2em;
        word-spacing: 0.05rem;
    }

    #vcomments ul li,
    ol li {
        display: list-item;
        line-height: 1.8rem;
        font-size: 1rem;
    }

    #vcomments ul li {
        list-style-type: disc;
    }

    #vcomments ul ul li {
        list-style-type: circle;
    }

    #vcomments table, th, td {
        padding: 12px 13px;
        border: 1px solid #dfe2e5;
    }

    #vcomments table, th, td {
        border: 0;
    }

    table tr:nth-child(2n), thead {
        background-color: #fafafa;
    }

    #vcomments table th {
        background-color: #f2f2f2;
        min-width: 80px;
    }

    #vcomments table td {
        min-width: 80px;
    }

    #vcomments h1 {
        font-size: 1.85rem;
        font-weight: bold;
        line-height: 2.2rem;
    }

    #vcomments h2 {
        font-size: 1.65rem;
        font-weight: bold;
        line-height: 1.9rem;
    }

    #vcomments h3 {
        font-size: 1.45rem;
        font-weight: bold;
        line-height: 1.7rem;
    }

    #vcomments h4 {
        font-size: 1.25rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    #vcomments h5 {
        font-size: 1.1rem;
        font-weight: bold;
        line-height: 1.4rem;
    }

    #vcomments h6 {
        font-size: 1rem;
        line-height: 1.3rem;
    }

    #vcomments p {
        font-size: 1rem;
        line-height: 1.5rem;
    }

    #vcomments hr {
        margin: 12px 0;
        border: 0;
        border-top: 1px solid #ccc;
    }

    #vcomments blockquote {
        margin: 15px 0;
        border-left: 5px solid #42b983;
        padding: 1rem 0.8rem 0.3rem 0.8rem;
        color: #666;
        background-color: rgba(66, 185, 131, .1);
    }

    #vcomments pre {
        font-family: monospace, monospace;
        padding: 1.2em;
        margin: .5em 0;
        background: #272822;
        overflow: auto;
        border-radius: 0.3em;
        tab-size: 4;
    }

    #vcomments code {
        font-family: monospace, monospace;
        padding: 1px 3px;
        font-size: 0.92rem;
        color: #e96900;
        background-color: #f8f8f8;
        border-radius: 2px;
    }

    #vcomments pre code {
        font-family: monospace, monospace;
        padding: 0;
        color: #e8eaf6;
        background-color: #272822;
    }

    #vcomments pre[class*="language-"] {
        padding: 1.2em;
        margin: .5em 0;
    }

    #vcomments code[class*="language-"],
    pre[class*="language-"] {
        color: #e8eaf6;
    }

    #vcomments [type="checkbox"]:not(:checked), [type="checkbox"]:checked {
        position: inherit;
        margin-left: -1.3rem;
        margin-right: 0.4rem;
        margin-top: -1px;
        vertical-align: middle;
        left: unset;
        visibility: visible;
    }

    #vcomments b,
    strong {
        font-weight: bold;
    }

    #vcomments dfn {
        font-style: italic;
    }

    #vcomments small {
        font-size: 85%;
    }

    #vcomments cite {
        font-style: normal;
    }

    #vcomments mark {
        background-color: #fcf8e3;
        padding: .2em;
    }

    #vcomments table, th, td {
        padding: 12px 13px;
        border: 1px solid #dfe2e5;
    }

    table tr:nth-child(2n), thead {
        background-color: #fafafa;
    }

    #vcomments table th {
        background-color: #f2f2f2;
        min-width: 80px;
    }

    #vcomments table td {
        min-width: 80px;
    }

    #vcomments [type="checkbox"]:not(:checked), [type="checkbox"]:checked {
        position: inherit;
        margin-left: -1.3rem;
        margin-right: 0.4rem;
        margin-top: -1px;
        vertical-align: middle;
        left: unset;
        visibility: visible;
    }
</style>

<div class="card valine-card" data-aos="fade-up">
    <div id="vcomments" class="card-content"></div>
</div>

<script src="/libs/valine/av-min.js"></script>
<script src="/libs/valine/Valine.min.js"></script>
<!-- <script src="//unpkg.com/valine@latest/dist/Valine.min.js"></script> -->

<script>
    new Valine({
        el: '#vcomments',
        appId: '',
        appKey: '',
        notify: 'false' === 'true',
        verify: 'false' === 'true',
        visitor: 'false' === 'true',
        avatar: 'wavatar',
        pageSize: '10',
        lang: 'zh-cn',
        placeholder: '如果你没有GitHub账号，还可以在这里评论啦！'
    });
</script>

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fa fa-chevron-left"></i>&nbsp;上一篇</div>
            <div class="card">
                <a href="/2020/12/22/docker/yin-xiang-bi-ji/2-an-zhuang-docker/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/1.jpg" class="responsive-img" alt="2、安装Docker">
                        
                        <span class="card-title">2、安装Docker</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            2、安装Docker
                        
                    </div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="fa fa-clock-o fa-fw icon-date"></i>2020-12-22
                        </span>
                        <span class="publish-author">
                            
                            <i class="fa fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/docker/" class="post-category" target="_blank">
                                    docker
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/docker/" target="_blank">
                        <span class="chip bg-color">docker</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                下一篇&nbsp;<i class="fa fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/2020/12/22/docker/docker-gai-shu/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/0.jpg" class="responsive-img" alt="docker概述">
                        
                        <span class="card-title">docker概述</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            docker概述
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="fa fa-clock-o fa-fw icon-date"></i>2020-12-22
                            </span>
                        <span class="publish-author">
                            
                            <i class="fa fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/docker/" class="post-category" target="_blank">
                                    docker
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/docker/" target="_blank">
                        <span class="chip bg-color">docker</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>
</div>


    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget">
            <div class="toc-title"><i class="fa fa-list-alt"></i>&nbsp;&nbsp;目录</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fa fa-list"></i>
    </a>
</div>


<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            // headingsOffset: -205,
            headingSelector: 'h1, h2, h3, h4'
        });

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('#articleContent').children('h1, h2, h3, h4').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).slideUp(500);
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).slideDown(500);
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>
    

</main>


<script src="https://cdn.bootcss.com/mathjax/2.7.5/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
<script>
    MathJax.Hub.Config({
        tex2jax: {inlineMath: [['$', '$'], ['\(', '\)']]}
    });
</script>

<script type="text/javascript" src="/libs/codeBlock/codeBlockFuction.js"></script>
<!-- 代码语言 -->
<script type="text/javascript" src="/libs/codeBlock/codeLang.js"></script>
<!-- 代码块复制 -->
<script type="text/javascript" src="/libs/codeBlock/codeCopy.js"></script>
<script type="text/javascript" src="/libs/codeBlock/clipboard.min.js"></script>
<!-- 代码块收缩 -->
<script type="text/javascript" src="/libs/codeBlock/codeShrink.js"></script> 
<!-- 代码块折行 -->
<style type="text/css">code[class*="language-"], pre[class*="language-"] { white-space: pre !important; }</style>


    <footer class="page-footer bg-color">
    <div class="container row center-align">
        <div class="col s12 m8 l8 copy-right">
            &copy; 2020- Azhong. 版权所有

            
            &nbsp;<i class="fa fa-area-chart"></i>&nbsp;站点总字数:&nbsp;
            <span class="white-color">634.8k</span>
            

            <br>
            <span id="sitetime"></span>

            
            
            <br>
            
            <span id="busuanzi_container_site_pv" style='display:none'>
                <i class="fa fa-heart-o"></i>
                本站总访问量 <span id="busuanzi_value_site_pv" class="white-color"></span>
            </span>
            
            
            <span id="busuanzi_container_site_uv" style='display:none'>
                人次,&nbsp;访客数 <span id="busuanzi_value_site_uv" class="white-color"></span> 人.
            </span>
            
            
        </div>
        <div class="col s12 m4 l4 social-link social-statis">
    <a href="https://github.com/JohnZhongg" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
        <i class="fa fa-github"></i>
    </a>



    <a href="mailto:707845008@qq.com" class="tooltipped" target="_blank" data-tooltip="邮件联系我" data-position="top" data-delay="50">
        <i class="fa fa-envelope-open"></i>
    </a>



    <a href="https://zhihu.com/people/change-94-17" class="tooltipped" target="_blank" data-tooltip="访问我的知乎" data-position="top" data-delay="50">
        <i class="fa fa-inverse">知</i>
    </a>



    <a href="http://wpa.qq.com/msgrd?v=3&uin=707845008&site=qq&menu=yes" class="tooltipped" target="_blank" data-tooltip="访问我的知乎" data-position="top" data-delay="50">
        <i class="fa fa-qq"></i>
    </a>


<!-- 


    <a href="/atom.xml" class="tooltipped" target="_blank" data-tooltip="RSS 订阅" data-position="top" data-delay="50">
        <i class="fa fa-rss"></i>
    </a>
 --></div>
    </div>
</footer>

<div class="progress-bar"></div>

<!-- 不蒜子计数初始值纠正 -->
<script>
    $(document).ready(function () {

        var int = setInterval(fixCount, 50);
        var pvcountOffset = 0;
        var uvcountOffset = 0;

        function fixCount() {
            if (document.getElementById("busuanzi_container_site_pv").style.display != "none") {
                $("#busuanzi_value_site_pv").html(parseInt($("#busuanzi_value_site_pv").html()) + pvcountOffset);
                clearInterval(int);
            }
            if ($("#busuanzi_container_site_pv").css("display") != "none") {
                $("#busuanzi_value_site_uv").html(parseInt($("#busuanzi_value_site_uv").html()) + uvcountOffset); // 加上初始数据 
                clearInterval(int);
            }
        }
    });
</script>

<script language=javascript>
    function siteTime() {
        window.setTimeout("siteTime()", 1000);
        var seconds = 1000;
        var minutes = seconds * 60;
        var hours = minutes * 60;
        var days = hours * 24;
        var years = days * 365;
        var today = new Date();
        var todayYear = today.getFullYear();
        var todayMonth = today.getMonth() + 1;
        var todayDate = today.getDate();
        var todayHour = today.getHours();
        var todayMinute = today.getMinutes();
        var todaySecond = today.getSeconds();
        /* Date.UTC() -- 返回date对象距世界标准时间(UTC)1970年1月1日午夜之间的毫秒数(时间戳)
        year - 作为date对象的年份，为4位年份值
        month - 0-11之间的整数，做为date对象的月份
        day - 1-31之间的整数，做为date对象的天数
        hours - 0(午夜24点)-23之间的整数，做为date对象的小时数
        minutes - 0-59之间的整数，做为date对象的分钟数
        seconds - 0-59之间的整数，做为date对象的秒数
        microseconds - 0-999之间的整数，做为date对象的毫秒数 */
        var t1 = Date.UTC(2020, 12, 20, 00, 00, 00); //北京时间2018-2-13 00:00:00
        var t2 = Date.UTC(todayYear, todayMonth, todayDate, todayHour, todayMinute, todaySecond);
        var diff = t2 - t1;
        var diffYears = Math.floor(diff / years);
        var diffDays = Math.floor((diff / days) - diffYears * 365);
        var diffHours = Math.floor((diff - (diffYears * 365 + diffDays) * days) / hours);
        var diffMinutes = Math.floor((diff - (diffYears * 365 + diffDays) * days - diffHours * hours) / minutes);
        var diffSeconds = Math.floor((diff - (diffYears * 365 + diffDays) * days - diffHours * hours - diffMinutes * minutes) / seconds);
        document.getElementById("sitetime").innerHTML = "本站已运行 " + diffYears + " 年 " + diffDays + " 天 " + diffHours + " 小时 " + diffMinutes + " 分钟 " + diffSeconds + " 秒";
    }/*因为建站时间还没有一年，就将之注释掉了。需要的可以取消*/
    siteTime();
</script>


    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fa fa-search"></i>&nbsp;&nbsp;搜索</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script src="/js/search.js"></script>
<script type="text/javascript">
$(function () {
    searchFunc("/" + "search.xml", 'searchInput', 'searchResult');
});
</script>
    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fa fa-angle-up"></i>
    </a>
</div>


    <script src="/libs/materialize/materialize.min.js"></script>
    <script src="/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="/libs/aos/aos.js"></script>
    <script src="/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="/js/matery.js"></script>

    <script type="text/javascript"> var OriginTitile = document.title, st; document.addEventListener("visibilitychange", function () { document.hidden ? (document.title = "Σ(っ °Д °;)っ喔哟，崩溃啦！", clearTimeout(st)) : (document.title = "φ(゜▽゜*)♪咦，又好了！", st = setTimeout(function () { document.title = OriginTitile }, 3e3)) })
    </script>

    <!-- Global site tag (gtag.js) - Google Analytics -->

<script async src="https://www.googletagmanager.com/gtag/js?id="></script>
<script>
    window.dataLayer = window.dataLayer || [];
    function gtag() {
        dataLayer.push(arguments);
    }

    gtag('js', new Date());
    gtag('config', '');
</script>



    
    <script src="/libs/others/clicklove.js"></script>
    

    
    <script async src="/libs/others/busuanzi.pure.mini.js"></script>
    

    <!-- 雪花特效 -->
    

</body>

</html>